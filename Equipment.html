<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Equipment ‚Äì Seavo Nautiq</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <!-- Valgfritt hvis du bruker dem i Office -->
   
     <!-- Kjerne (√©n gang, med defer) -->
  <script src="./js/seavo-core.js" defer></script>
  


  <link rel="stylesheet" href="responsive.css">
  <script defer src="responsive.js"></script>

  <style>
/* ====== TEMA / BASE ====== */
:root{
  --bg:#0f2a4a;
  --panel:rgba(0,0,0,.18);
  --panel-2:rgba(255,255,255,.08);
  --text:#ffffff;
  --muted:#bcd3f1;
  --accent:#62b2e7;
  --accent-2:#1b75d1;
  --accent-3:#0e3e86;
  --danger:#f03747;
  --warn:#ecc543;
  --ok:#28e755;

  --panel-w: 180px;
  --panel-h: 32vh;
  --handle-w: 28px;
}

*{box-sizing:border-box}
body{
  background-color:var(--bg);
  font-family:Arial,sans-serif;
  margin:0;
  color:var(--text);
}

body {
  background-color: hsl(210, 100%, var(--bg-lightness));
  transition: background-color 0.5s ease;
  margin: 0;
  font-family: Arial, sans-serif;
  overflow-x: hidden;
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  pointer-events: none;
  background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.7));
  z-index: -1;
}

:root {
  --bg-lightness: 20%;
  --text-color: hsl(0, 0%, calc(100% - var(--bg-lightness)));
  --box-color: hsl(210, 50%, calc(var(--bg-lightness) + 5%));
  --button-color: hsl(210, 70%, calc(var(--bg-lightness) + 10%));
  --button-text: hsl(0, 0%, calc(100% - var(--bg-lightness)));
}

.theme-slider-container {
  position: relative;
  top: 12px;
  background: rgba(0, 0, 0, 0.705);
  padding: 16px 18px;
  border-radius: 12px;
  border: 2px solid #8f8248;
  color: rgb(255, 255, 255);
  font-family: Arial, sans-serif;
  z-index: 1000;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
  width: 180px;
  margin-left: 0px;
}

.theme-slider-container input[type="range"] {
  width: 82px;
  cursor: pointer;
}


/* Header-video */
.video-header{ position:relative; aspect-ratio:1280/99; overflow:hidden; background:#000; }
.video-header video{ width:100%; height:200%; object-fit:cover; display:block; }
.gradient-overgang{ height:10px; background:linear-gradient(to left,#62b2e7,#001125); box-shadow:6px 4px 6px rgba(0,0,0,.7); }

/* ====== TOPP / LOGO / S√òK ====== */
.logo{
  width:130px; height:auto; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.45);
  cursor:pointer; margin-left:60px; transition:transform .2s ease, box-shadow .2s ease; background:rgba(255,255,255,.04);
}
.logo:hover{ transform:scale(1.05); box-shadow:0 8px 28px rgba(255, 255, 255, 0.212); }

#searchBox{
  width:260px; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.25);
  background:rgba(0,0,0,.25); color:var(--text); margin-left:60px; margin-top:24px; margin-bottom:18px;
  font-weight:600; box-shadow:0 6px 16px rgba(0,0,0,.35); outline:none;
}
#searchBox::placeholder{ color:var(--muted); }
#searchBox:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(98,178,231,.25); }

/* Bakgrunnsbilde */
.equipment{
  width:100%; height:130%; position:absolute; top:0; left:0; z-index:-1; opacity:.08; pointer-events:none;
  filter:saturate(.9) contrast(1.05);
}

/* ====== KATEGORI-SLIDER ====== */
.category-slider-office{
  display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.25); backdrop-filter:blur(4px);
  padding:14px; overflow-x:auto; margin-bottom:-10px; width:70%; max-width: 1400px; margin:auto; border-radius:14px;
  border:1px solid rgba(255,255,255,.12); box-shadow:0 10px 26px rgba(0,0,0,.35);
}
.category-item{ display:flex; align-items:center; margin:0 6px; }
.category-button,.add-category{
  padding:10px 16px; background:linear-gradient(to right,var(--accent-2),var(--accent-3));
  color:#fff; border-radius:10px; cursor:pointer; font-size:15px; border:1px solid rgba(255,255,255,.12); box-shadow:0 4px 12px rgba(0,0,0,.35);
}
.category-button.active{ background:linear-gradient(to right,#08317c,#14b8c4); font-weight:700; box-shadow:0 0 2px #ffffff98; }
.category-button:hover,.add-category:hover{ filter:brightness(1.30); }


.delete-category-button {
  position: relative;
  overflow: hidden;
  transition: background 0.4s;
  border-radius: 6px;
  padding: 4px 10px;
  background-color: #68ddfaa9;
}

/* Skygge-effekt (pseudo-element) */
.delete-category-button::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  background: rgba(240, 55, 71, 8.4); /* r√∏dlig skygge */
  transform: scale(0);
  opacity: 0;
  pointer-events: none;
  
}

/* N√•r vi "holder inne" */
.delete-category-button.hold::after {
  animation: unlockShadow 1.5s forwards;
}

@keyframes unlockShadow {
  0%   { transform: scale(0); opacity: 0.6; }
  80%  { transform: scale(2.5); opacity: 0.15; }
  100% { transform: scale(3.5); opacity: 0; }
}

/* N√•r knappen er klar */
.delete-category-button.unlocked {
  background: #f03747;
  color: #fff;
  box-shadow: 0 0 8px rgba(240,55,71,.7);
}


.arrow{
  font-size:18px; font-weight:700; padding:8px 12px; background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.12);
  color:#fff; border-radius:10px; cursor:pointer; width:56px; box-shadow:0 6px 16px rgba(0,0,0,.35); margin-left:16px;
}
.arrow:hover{ background:rgba(0,0,0,.35); }

.undo-category{
  margin-left:22px; padding:6px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.2);
  background:rgba(255,255,255,.08); color:#fff; cursor:pointer;
}
.undo-category:disabled{ opacity:.5; cursor:not-allowed; }
.undo-category:hover:not(:disabled){ background:rgba(255,255,255,.12); box-shadow:0 6px 16px rgba(0,0,0,.35); }


.global-overview-table {
  width: 100%;
  max-width: 1800px;
  min-width: 620px;
  border-collapse: collapse;
  font-size: 28px;
  line-height: 1.5; 
  font-weight: bolder;
}

.global-overview-table th,
.global-overview-table td {
  border: 1px solid #ccc;
  padding: 14px 10px;
}

.global-overview-table th {
  background: #1466e0;
  font-size: 20px;

}

/* ====== KNAPPER GLOBALT ====== */
.global-button,#sidePanel button:not(#togglePanelBtn),#calc-buttons button{
  background:linear-gradient(to right,var(--accent-2),var(--accent-3));
  color:#fff; border:1px solid rgba(255,255,255,.12); border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.35);
}
.global-button{ padding:10px 18px; font-size:15px; font-weight:700; cursor:pointer; margin:10px 60px; }
.global-button:hover{ filter:brightness(1.30); }

/* ====== TABELL ====== */
.table-wrapper{ overflow-x:auto; }
table{
  width:100%;
  max-width: 1800px;
  min-width: 620px;           /* holder god avstand i RU m.fl. */ 
  margin: auto;
  margin-bottom: 0px;
  border-collapse:collapse;
  background:rgba(0,0,0,.20);
  color:var(--text);
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 12px 28px rgba(0,0,0,.35);
}

th, td { 
  border-bottom:1px solid rgba(255,255,255,.12); 
  padding: var(--cell-padding, 0px);  /* fallback 0px */
  text-align:center; 
  font-size:16px; 
  vertical-align:middle;
}
th{ background:rgba(0,0,0,.28); color:var(--text); height: 42px; }

/* Slider-stil */
#padding-slider {
  width: 200px;
  margin: 16px auto;
  display: block;
  cursor: pointer;
  accent-color: var(--accent);
}

.header-row td{
  background:linear-gradient(to right, rgba(255,255,255,.06), rgba(255,255,255,.02));
  font-weight:700; text-align:left; border-color:rgba(255,255,255,.12); border-radius:0; 
}
.header-row td span{ display:inline-block; width:52%; margin-left:10px; color:var(--text); vertical-align:middle; }

/* Mini-kolonneheader */
.section-columns td{
  background:rgba(0,0,0,.24); color:#ffffffab; font-weight:400; border-bottom:1px solid rgba(255,255,255,.12); padding:2px 10px;
}
.section-columns td.muted{ color:#bcd3f1; font-weight:600; }

/* Header farge-chip */
.header-color-chip{
  height:8px; width:14px; border-radius:4px; border:1px solid rgba(0,0,0,.35); box-shadow:0 0 4px rgba(0,0,0,.25);
  cursor:pointer; margin-left:4px; background:rgba(255,255,255,.15); display:inline-block; opacity:.9;
}

/* Celler / inputs */
.large-bold-input{ font-weight:700; font-size:14px; color:var(--text); background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.18); }
.large-bold-input::placeholder{ color:var(--muted); }
.large-bold-input:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(98,178,231,.18); }

.cell-min,.cell-max{ 
  width: calc(90px + var(--cell-padding, 0px) * 2); 
  min-width: calc(60px + var(--cell-padding, 0px) * 2); 
  max-width: calc(100px + var(--cell-padding, 0px) * 2); 
}
.cell-order{ width:100px; min-width:60px; max-width:100px; }
.cell-move{ width:80px; }
.cell-product{ width: 350px; min-width: 160px; }
.cell-comment{ width: 340px; min-width: 160px;  }
td.min-col input{ width:60px; }

td.cell-small input{
  max-width: 120px;
  min-width: 65px;
  padding: 8px;
  font-size: 16px;
}

/* Flytteknapper */
.cell-move button{
  width:42px; height:35px; background:linear-gradient(to right,var(--accent-2),var(--accent-3));
  color:#fff; border-radius:10px; cursor:pointer; font-size:16px; border:1px solid rgba(255,255,255,.12);
}
.cell-move button:hover{ filter:brightness(1.15); }

td:last-child{ width:50px; background:linear-gradient(to right, rgba(78,155,206,.25), rgba(27,56,99,.25)); }

.btn-danger{
  background:linear-gradient(to right,#f13e4e,#a31621); color:#fff; font-weight:bold; padding:6px 12px; border-radius:6px; cursor:pointer; border:none;
}
.btn-danger:hover{ background:linear-gradient(to right,#ff5a6b,#c3222d); font-style:italic; box-shadow:0 0 20px #ff0000; }

/* Alarmfarger */
.min-alarm{ background:linear-gradient(to right, rgba(255,255,255,.2), rgba(247, 230, 0, 0.35)) !important; }
.max-alarm{ background:linear-gradient(to right, rgba(255,255,255,.2), rgba(95, 255, 2, 0.28)) !important; }

/* Transparent input via CSS-variabel --col-rgb */
.product-input{ background-color:rgba(var(--col-rgb,0,0,0), .30); transition:background-color .15s ease; }
.product-input:focus{ background-color:rgba(var(--col-rgb,0,0,0), .22); }

/* Produkt fargepicker */
.product-color-wrap{
  position:relative;
  display:grid !important;
  grid-template-columns:1fr auto;
  align-items:center;
  column-gap:6px;
  width: 100%;
}
.product-color-wrap input{ width:100% !important; min-width:0; }

.color-chip{
  width:16px; height:16px; border-radius:4px; border:1px solid rgba(0,0,0,.35); cursor:pointer;
  box-shadow:0 0 4px rgba(0,0,0,.25);
  background:var(--chip-color, rgba(255,255,255,.15));
}

/* === POPUP OVER ALT === */
.color-popover{
  position:fixed;
  display:grid; grid-template-columns:repeat(4, 18px); gap:6px;
  background:rgba(3,14,24,.95);
  padding:10px; border-radius:10px;
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 10px 26px rgba(0,0,0,.55);
  z-index:2147483647;
  visibility:hidden;
}
.color-popover.hidden{ display:none; }
.color-option{
  width:18px; height:18px; border-radius:4px; cursor:pointer;
  border:1px solid rgba(0,0,0,.35); box-shadow:0 0 3px rgba(0,0,0,.25);
}
.color-option.clear{
  background:linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 50%, #ccc 50%, #ccc 75%, transparent 75%, transparent);
  background-size:8px 8px;
}
.color-option:hover,.color-chip:hover{ outline:1px solid #ffffff; }

/* ====== SIDE PANEL ====== */
#sidePanel{
  position:fixed; overflow:visible; top:180px; right:0; width:var(--panel-w); height:var(--panel-h);
  background:rgba(0,0,0,.35); backdrop-filter:blur(4px); color:var(--text); display:flex; flex-direction:column; align-items:center;
  padding:16px 10px; box-shadow:-8px 0 22px rgba(0,0,0,.45); transition:right .5s ease; z-index:999; border-radius:16px 0 0 16px; border:1px solid rgba(255,255,255,.12);
}
#sidePanel.hidden{ right:calc(-1 * (var(--panel-w) - var(--handle-w))); }

#togglePanelBtn{
  position:absolute; left:0; top:50%; transform:translate(-100%, -50%); width:var(--handle-w); height:clamp(96px,50%,180px);
  display:flex; align-items:center; justify-content:center; padding:0; background:linear-gradient(to bottom, var(--accent-2), var(--accent-3));
  color:#fff; font-weight:bold; font-size:22px; border-radius:12px 0 0 12px; cursor:pointer; box-shadow:-8px 0 12px rgba(0,0,0,.35);
  user-select:none; z-index:1000; border:1px solid rgba(255,255,255,.12);
}
#togglePanelBtn:hover{ filter:brightness(1.20); box-shadow: 0 0 15px 3px rgba(255, 255, 255, 0.4); }

#bottomButtons{ margin-top:auto; width:100%; display:flex; flex-direction:column; gap:6px; }
#sidePanel button:not(#togglePanelBtn){
  margin:4px 0; padding:12px 14px; width:100%; background:linear-gradient(to right,#123981,#1994db);
  color:#fff; font-weight:700; border-radius:10px; cursor:pointer; font-size:14px; box-shadow:0 6px 14px rgba(0,0,0,.35);
}
#sidePanel button:not(#togglePanelBtn):hover{ filter:brightness(1.20); }

/* Markering */
.highlight{ background:rgba(240,138,42,.8); font-weight:700; color:#09111f; border-radius:4px; padding:0 2px; }
.highlight-input{ background:rgba(255,222,89,.85); color:#09111f; font-weight:700; }

/* ====== MODALER ====== */
  .modal{
    position:fixed; inset:0; background:rgba(0,0,0,.45);
    display:none; z-index:1500;
  }
  .modal-innhold{
    position:absolute; left:300px; top:200px; transform:translate(0,0);
    background:rgba(8,22,38,.9); padding:16px; width:280px;
    border:1px solid rgba(255,255,255,.12); border-radius:12px;
    box-shadow:0 10px 26px rgba(0,0,0,.55); backdrop-filter: blur(6px);
    color:#fff;
  }

  /* ====== KALKULATOR SPESIFIKK STIL ====== */
  #calculatorModal .modal-innhold{
    width: 320px;           /* ryddig bredde for knappe-grid */
    padding: 14px 14px 18px;
  }
  .calculator-header{
    display:flex; align-items:center; justify-content:space-between;
    background: linear-gradient(to right, #1b75d1, #0e3e86);
    padding:8px 10px; border-radius:8px; cursor:move; user-select:none;
  }
  .calculator-header .lukk{
    font-size:18px; line-height:1; cursor:pointer; padding:2px 6px;
  }
  #calc-display{
    width:100%; padding:10px 10px; font-size:24px; text-align:right;
    margin:12px 0; border-radius:8px; border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06); color:#fff;
  }
  .calc-grid{
    display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;
  }
  .calc-grid button{
    padding:8px; font-size:20px; font-weight:600;
    border:none; border-radius:10px;
    background: rgba(255,255,255,.08); color:#fff; cursor:pointer;
    transition: transform .05s ease, background .15s ease;
  }
  .calc-grid button:active{ transform: scale(.98); }
  .btn-op{ background: rgba(98,178,231,.25); }
  .btn-clear{ background: rgba(240,55,71,.35); }
  .btn-del{ background: rgba(236,197,67,.35); }
  .btn-eq{ background:#28e755; color:#061a08; }
  .btn-eq:hover{ filter: brightness(1.05); }
  .span-4{ grid-column: 1 / -1; }

  /* ====== NOTEPAD SPESIFIKK STIL ====== */
  #notepadModal .modal-innhold{ width: 360px; }
  .notepad-header{
    display:flex; align-items:center; justify-content:space-between;
    background: linear-gradient(to right, #1b75d1, #0e3e86);
    padding:8px 10px; border-radius:8px; cursor:move; user-select:none;
  }
  .notepad-body textarea{
    width:100%; min-height:200px; resize:vertical;
    background: rgba(255,255,255,.06); color:#fff; border:1px solid rgba(255,255,255,.12);
    border-radius:8px; padding:10px; font-size:14px;
  }
  .notepad-actions{
    display:flex; gap:8px; margin-top:10px; justify-content:flex-end;
  }
  .btn{
    padding:10px 12px; border:none; border-radius:10px; font-weight:600; cursor:pointer;
    background: rgba(255,255,255,.08); color:#fff;
  }
  .btn-primary{ background: rgba(98,178,231,.3); }
  .btn-danger{ background: rgba(240,55,71,.35); }

  @media (max-width: 420px){
    #calculatorModal .modal-innhold{ width: 92vw; }
    #notepadModal .modal-innhold{ width: 92vw; }
  }

/* Diverse */
button img{ width:40px; height:45px; padding-left:0px; margin-top:18px; }
#content{ padding:60px; }

/* Bildeopplasting i celler */
.image-upload-container {
  display:flex; align-items:center; gap:6px; justify-content:center;
}
.image-upload-container img {
  max-width: 50px; max-height: 38px; border-radius: 6px; box-shadow: 0 0 8px rgba(1, 252, 85, 0.616); cursor:pointer;
}
.image-upload-container img:hover {
  filter: brightness(1.2);
}
.upload-btn{ background:linear-gradient(to right,#20b7dd65,#0fa6cc80); color:#fff; border-radius:8px; padding:6px 4px; font-size:11px; font-weight:700; cursor:pointer; box-shadow:0 0 6px rgba(0,0,0,.4); }
.upload-btn:hover{ filter:brightness(1.2); }

/* Bilde modal */
/* Image Modal - Updated */
#image-modal { 
  position: fixed; 
  inset: 0; 
  display: none; 
  align-items: center; 
  justify-content: center; 
  z-index: 2000; 
  background: rgba(0,0,0,0.8);
}

#modal-overlay { 
  position: absolute; 
  inset: 0; 
  cursor: pointer; 
}

#modal-image { 
  max-width:70%; 
  max-height: 70%; 
  z-index: 2001; 
  border-radius: 8px; 
  box-shadow: 0 0 15px rgba(0,0,0,.8);
  position: relative;
  cursor: default;
}


.send-orders-button {
  background: linear-gradient(to right, #5092e7, #3a0580);
  color: rgb(255, 255, 255);
  padding: 8px 6px;
  margin: 5px;
  border-radius: 24px;
  cursor: pointer;
  font-weight: 500;
  font-size: 12px;
  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.35);
}

.send-orders-button:hover {
  background: linear-gradient(to right, #57d0ee, #072846);
}

/* Print */
@media print{
  body{ background:#fff; color:#000; }
  .video-header,.gradient-overgang,.global-button,#sidePanel,.category-slider-office,.logo,#searchBox{ display:none !important; }
  table{ background:#fff; color:#000; box-shadow:none; border:1px solid #ccc; }
  th{ background:#f2f2f2; color:#000; }
}
  </style>
</head>

<header class="video-header">
  <video autoplay muted loop playsinline disablePictureInPicture>
    <source src="Video/Ocean-Seavo-Nautiq.mp4" type="video/mp4">
  </video>
</header>
<div class="gradient-overgang"></div>

<!-- Libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>

<script defer src="js/MODAL.js"></script>

<body>
<header>
  <h1 style="text-align:center; color: rgb(30, 182, 209); margin-top:20px; font-size:36px; font-weight:bold; text-shadow:0 1px 3px rgba(0,0,0,.6);">
    Equipment
  </h1>
  <a href="index.html" class="logo-link"><img src="images/Logo Seavo Nautiq.png" alt="Logo Seavo Nautiq" class="logo"></a>

  <div id="sidePanel" class="hidden">
    <button onclick="√•pnePopup4()">Help</button>
    <button onclick="√•pnePopup2()">Documents</button>
    <button>Shared Content</button>
    <button onclick="√•pnePopup7()">Settings</button>
    <button id="signOutBtn">Sign Out</button>

    <div id="bottomButtons">
      <button id="openCalculatorBtn">üßÆ Calculator</button>
      <button id="openNotepadBtn">üìù Notepad</button>
    </div>

        <div class="theme-slider-container">
      <label for="themeSlider">‚òÄÔ∏è</label>
      <input type="range" min="1" max="13" value="10" id="themeSlider">
      <label for="themeSlider">üåô</label>
    </div>

    <button id="togglePanelBtn" onclick="toggleSidePanel()">‚´∑</button>
  </div>
</header>




<input type="text" id="searchBox" placeholder="Search inventory..." oninput="searchInPage()">

<div class="category-slider-office">
  <button class="arrow" onclick="scrollSlider(-100)">‚Üê</button>
  <div id="category-container" style="display:flex; overflow-x:auto; max-width:50%; scroll-behavior:smooth;">
    <div id="categories" style="display:flex; gap:8px;"></div>
  </div>
  <button class="arrow" onclick="scrollSlider(100)">‚Üí</button>
  <button class="add-category" onclick="addCategory()">+ Category</button>
  <button id="undo-delete" class="undo-category" onclick="undoCategoryDelete()" disabled>‚Ü∂ Undo Del</button>
</div>

<div><img src="images/Equipment.PNG" alt="Equipment" class="equipment"></div>

<!-- Slider-kontroll -->
<label for="padding-slider" style="display:block;text-align:center;margin:10px 0;color:rgb(28, 192, 233);">
  Table Padding
</label>
<input id="padding-slider" type="range" min="0" max="12" value="0" />

<div id="content"></div>

<button id="globalToggleButton" class="global-button" onclick="toggleGlobalView()">üìã Global Overview</button>‚ÄúThe Global Overview presents all inventory in a structured table format, optimized for PDF generating and printing.‚Äù
<div><button class="global-button" onclick="generatePDF()">üìÑ Generate PDF</button> "This will generate a PDF document of the current inventory view."</div>
<button class="global-button" type="button" onclick="generateExcel()">üìä Export to Excel</button> "This will export the current inventory view to an Excel file."
<div><button class="global-button" onclick="save()">üíæ Save</button> "This will save the active category and its contents, which can be accessed later in the sidepanel - documents."</div>
<div><button class="global-button" onclick="load()">‚¨Ü Load</button> "This will load a selected category and its contents."</div>
     
  
 
<!-- ====== MODALS ====== -->
<!-- Kalkulator -->
<div id="calculatorModal" class="modal">
  <div class="modal-innhold" id="calculatorWindow">
    <div class="calculator-header" id="calcDragHandle">
      <h2 style="margin:0; font-size:15px;">Calculator</h2>
      <span class="lukk" onclick="closeCalculator()">√ó</span>
    </div>

    <input id="calc-display" type="text" readonly>

    <div id="calc-buttons" class="calc-grid">
      <!-- Rad 1 -->
      <button class="btn-clear" onclick="clearCalc()">C</button>
      <button class="btn-del" onclick="deleteLast()">DEL</button>
      <button class="btn-op" onclick="appendCalc('%')">%</button>
      <button class="btn-op" onclick="appendCalc('/')">√∑</button>
      <!-- Rad 2 -->
      <button onclick="appendCalc('7')">7</button>
      <button onclick="appendCalc('8')">8</button>
      <button onclick="appendCalc('9')">9</button>
      <button class="btn-op" onclick="appendCalc('*')">√ó</button>
      <!-- Rad 3 -->
      <button onclick="appendCalc('4')">4</button>
      <button onclick="appendCalc('5')">5</button>
      <button onclick="appendCalc('6')">6</button>
      <button class="btn-op" onclick="appendCalc('-')">‚àí</button>
      <!-- Rad 4 -->
      <button onclick="appendCalc('1')">1</button>
      <button onclick="appendCalc('2')">2</button>
      <button onclick="appendCalc('3')">3</button>
      <button class="btn-op" onclick="appendCalc('+')">+</button>
      <!-- Rad 5 -->
      <button onclick="appendCalc('0')">0</button>
      <button onclick="appendCalc('.')">.</button>
      <button class="btn-eq span-4" onclick="calculateResult()">=</button>
    </div>
  </div>
</div>

<!-- Notepad (valgfritt, siden skriptet ditt inkluderer det) -->
<div id="notepadModal" class="modal">
  <div class="modal-innhold" id="notepadWindow">
    <div class="notepad-header" id="notepadDragHandle">
      <h2 style="margin:0; font-size:15px;">Notepad</h2>
      <span class="lukk" onclick="closeNotepad()">√ó</span>
    </div>
    <div class="notepad-body">
      <textarea id="noteArea" placeholder="Write a note..."></textarea>
    </div>
    <div class="notepad-actions">
      <button class="btn btn-primary" onclick="saveNote()">Save</button>
      <button class="btn btn-danger" onclick="clearNote()">Clear</button>
    </div>
  </div>
</div>

<div id="notepadModal" class="modal" style="display:none;">
  <div class="modal-innhold" id="notepadWindow">
    <div class="calculator-header" id="noteDragHandle">
      <h2 style="margin:0; font-size:15px;">Notepad</h2>
      <span class="lukk" onclick="closeNotepad()">√ó</span>
    </div>
    <textarea id="noteArea" style="width:100%; height:260px; margin-top:10px; border-radius:10px;"></textarea>
    <div style="margin-top:10px; display:flex; gap:8px; justify-content:center;">
      <button onclick="saveNote()" style="padding:8px 12px;">Save</button>
      <button onclick="clearNote()" style="padding:8px 12px;">Clear</button>
    </div>
  </div>
</div>

<!-- Fullscreen image modal -->
<div id="image-modal">
  <div id="modal-overlay"></div>
  <img id="modal-image" src="" alt="Modal Image">
</div>



  
</body>


<script>
/* === Robust SheetJS-loader === */
function loadScript(src){
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.referrerPolicy = 'no-referrer';
    s.onload = resolve;
    s.onerror = () => reject(new Error('Feil ved lasting: ' + src));
    document.head.appendChild(s);
  });
}

async function ensureXLSX(){
  if (window.XLSX?.utils) return;
  const candidates = [
    "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js",
    "https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js",
    "https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js",
    "/libs/xlsx.full.min.js"
  ];
  let lastError;
  for (const url of candidates) {
    try { await loadScript(url); if (window.XLSX?.utils) return; }
    catch(e){ lastError = e; }
  }
  throw lastError || new Error("Kunne ikke laste SheetJS");
}

/* ===== EXCEL ‚Äì med CSV fallback ===== */
function downloadCSV(aoa, filename) {
  const csvRows = aoa.map(row => row.map(cell => {
    let v = cell == null ? "" : String(cell);
    if (v.includes('"')) v = v.replace(/"/g, '""');
    if (/[;\n"]/.test(v)) v = `"${v}"`;
    return v;
  }).join(';'));
  const csv = '\ufeff' + csvRows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename.replace(/\.xlsx$/i, '') + '.csv';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

window.generateExcel = async function(){
  const container = document.getElementById("content");
  const table = container?.querySelector("table") || document.querySelector("table");
  if(!table){ alert("Fant ingen tabell √• eksportere."); return; }

  const aoa = [];
  const dateStr = new Date().toLocaleDateString('no-NO', { year:'numeric', month:'2-digit', day:'2-digit' });
  aoa.push(["Seavo Equipment"]);
  aoa.push(["Generated:", dateStr]);
  aoa.push([]);

  const rows = Array.from(table.querySelectorAll("tr"));
  rows.forEach(tr => {
    const cells = Array.from(tr.cells).map(td => {
      if (td.querySelector("button")) return "";
      const img = td.querySelector("img");
      if (img && img.src) return "[image]";
      const ctrl = td.querySelector("input, textarea, select");
      if (ctrl) {
        if (ctrl.tagName === "SELECT") {
          const sel = ctrl; return sel.options[sel.selectedIndex]?.text || "";
        }
        if (ctrl.type === "checkbox") return ctrl.checked ? "Yes" : "No";
        return ctrl.value ?? "";
      }
      return td.textContent.trim();
    });
    for (let i = cells.length - 1; i >= 0; i--) { if (cells[i] !== "") break; cells.pop(); }
    aoa.push(cells);
  });

  if (typeof XLSX === "undefined" || !XLSX?.utils) {
    console.warn("SheetJS ikke lastet ‚Äì bruker CSV fallback.");
    downloadCSV(aoa, "SeavoEquipment.xlsx");
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const colCount = Math.max(...aoa.map(r => r.length), 1);

  ws['!merges'] = ws['!merges'] || [];
  ws['!merges'].push({ s:{r:0,c:0}, e:{r:0,c:colCount-1} });

  const headerRowIndex = 3;
  if (ws['!ref']) {
    const range = XLSX.utils.decode_range(ws['!ref']);
    ws['!autofilter'] = { ref: XLSX.utils.encode_range({ s:{ r: headerRowIndex, c: 0 }, e:{ r: range.e.r, c: range.e.c } }) };
  }
  ws['!freeze'] = { ySplit: headerRowIndex, xSplit: 0, topLeftCell: XLSX.utils.encode_cell({ r: headerRowIndex, c: 0 }) };

  const colWidths = [];
  for (let c = 0; c < colCount; c++) {
    let maxLen = 10;
    for (let r = 0; r < aoa.length; r++) {
      const val = aoa[r][c];
      const len = (val == null) ? 0 : String(val).length;
      if (len > maxLen) maxLen = len;
    }
    colWidths.push({ wch: Math.min(40, Math.max(10, maxLen + 2)) });
  }
  ws['!cols'] = colWidths;

  XLSX.utils.book_append_sheet(wb, ws, "Seavo Equipment");
  XLSX.writeFile(wb, "SeavoEquipment.xlsx");
};
</script>

<script>
/* ===== Sidepanel toggle ===== */
function toggleSidePanel(){
  const panel = document.getElementById("sidePanel");
  const btn   = document.getElementById("togglePanelBtn");
  const nowHidden = panel.classList.toggle("hidden");
  btn.textContent = nowHidden ? "‚´∑" : "‚´∏";
}

/* ===== S√∏k/markering ===== */
function searchInPage(){
  const term=document.getElementById("searchBox").value.trim().toLowerCase();
  removeHighlights(); if(term==="") return;
  let firstMatch=null;
  document.querySelectorAll("td span").forEach(span=>{
    const content=span.textContent.toLowerCase();
    if(content.includes(term)){
      const index=content.indexOf(term);
      const original=span.textContent;
      const before=original.slice(0,index);
      const match=original.slice(index,index+term.length);
      const after=original.slice(index+term.length);
      span.innerHTML=`${before}<span class="highlight">${match}</span>${after}`;
      if(!firstMatch) firstMatch=span;
    }
  });
  document.querySelectorAll("input").forEach(input=>{
    if((input.value||"").toLowerCase().includes(term)){
      input.classList.add("highlight-input");
      if(!firstMatch) firstMatch=input;
    }
  });
  if(firstMatch){ setTimeout(()=>{ firstMatch.scrollIntoView({behavior:"smooth", block:"center"}); },100); }
}
function removeHighlights(){
  document.querySelectorAll("span .highlight").forEach(el=>{
    const parent=el.parentNode; parent.replaceChild(document.createTextNode(el.textContent), el); parent.normalize();
  });
  document.querySelectorAll(".highlight-input").forEach(input=> input.classList.remove("highlight-input"));
}

/* ===== Data/setup (EGEN N√òKKEL) ===== */
let data = JSON.parse(localStorage.getItem("equipmentDataV1")) || {};
let activeCategory = Object.keys(data)[0] || "Standard";
function save(){ localStorage.setItem("equipmentDataV1", JSON.stringify(data)); }
function scrollSlider(offset){ document.getElementById("category-container").scrollLeft += offset; }

/* Sikre at max finnes */
Object.values(data).forEach(rows=>{
  (rows||[]).forEach(r=>{
    if(r && r.type!=="header" && typeof r.max==="undefined"){ r.max=0; }
  });
});
save();

/* ===== Kategorier ===== */
let lastDeletedCategory = null; // { name, rows, index }
function insertCategoryAtIndex(obj, key, val, index){
  const entries = Object.entries(obj);
  const safeIndex = Math.max(0, Math.min(index, entries.length));
  entries.splice(safeIndex, 0, [key, val]);
  return Object.fromEntries(entries);
}

function updateCategories(){
  const container = document.getElementById("categories");
  container.innerHTML = "";

  const names = Object.keys(data);
  names.forEach((name, idx)=>{
    const wrapper = document.createElement("div");
    wrapper.className = "category-item";
    wrapper.style.display="flex";
    wrapper.style.alignItems="center";

    const btn = document.createElement("button");
    btn.className="category-button";
    btn.textContent=name;
    if(name===activeCategory) btn.classList.add("active");
    btn.onclick=()=>{ activeCategory=name; showCategory(); updateCategories(); };

   const delBtn = document.createElement("button");
delBtn.className = "delete-category-button";
delBtn.textContent = "Del";

let hoverTimer;
let unlocked = false;

delBtn.addEventListener("mouseenter", () => {
  delBtn.classList.add("hold");
  hoverTimer = setTimeout(() => {
    unlocked = true;
    delBtn.classList.remove("hold");
    delBtn.classList.add("unlocked");
  }, 1500); // 1.5 sek
});

delBtn.addEventListener("mouseleave", () => {
  clearTimeout(hoverTimer);
  unlocked = false;
  delBtn.classList.remove("hold", "unlocked");
});

delBtn.addEventListener("click", () => {
  if (!unlocked) {
    return;
  }
  if (confirm(`Do you want to delete the category "${name}"?`)) {
    lastDeletedCategory = { name, rows: data[name], index: idx };
    delete data[name];
    activeCategory = Object.keys(data)[0] || null;
    save();
    updateCategories();
    showCategory();
    const u = document.getElementById("undo-delete");
    if (u) u.disabled = false;
  }
  // reset l√•s etter bruk
  unlocked = false;
  delBtn.classList.remove("unlocked");
});



    wrapper.appendChild(btn);
    wrapper.appendChild(delBtn);
    container.appendChild(wrapper);
  });
}

function undoCategoryDelete(){
  if(!lastDeletedCategory) return;
  const { name, rows, index } = lastDeletedCategory;

  if(data && Object.prototype.hasOwnProperty.call(data, name)){
    lastDeletedCategory = null;
    const u = document.getElementById("undo-delete");
    if(u) u.disabled = true;
    return;
  }

  data = insertCategoryAtIndex(data, name, rows, index);
  activeCategory = name;
  save();
  updateCategories();
  showCategory();

  lastDeletedCategory = null;
  const u = document.getElementById("undo-delete");
  if(u) u.disabled = true;
}

function addCategory(){
  const name=prompt("New category:");
  if(name && !data[name]){ data[name]=[]; activeCategory=name; save(); updateCategories(); showCategory(); }
}

/* Palett */
const PRODUCT_COLORS = [
  "#36d131","#ffd036","#40e0d0","#ffffff",
  "#ff6b6b","#4da3ff","#ffa94d","#a78bfa",
  "#94a3b8","#000000","#f472b6","#2563eb",
  "#1f2937","#7c3aed","#b45309","#c0c0c0",
  "#d00000","#f97316","#ef4441",
];

/* Fargehjelpere */
function toRgbStr(col){
  if(/^#/.test(col)){
    let hex = col.replace('#','');
    if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
    const n = parseInt(hex,16);
    const r = (n>>16)&255, g=(n>>8)&255, b=n&255;
    return `${r},${g},${b}`;
  }
  if(/^rgba?\(/i.test(col)){
    const m = col.match(/rgba?\s*\(\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)/i);
    if(m) return `${m[1]},${m[2]},${m[3]}`;
  }
  const tmp = document.createElement('span');
  tmp.style.color = col; document.body.appendChild(tmp);
  const rgb = getComputedStyle(tmp).color; document.body.removeChild(tmp);
  const m2 = rgb.match(/rgb\(\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)/i);
  return m2 ? `${m2[1]},${m2[2]},${m2[3]}` : `0,0,0`;
}
function bestTextColor(hexOrCss){
  const [r,g,b] = toRgbStr(hexOrCss).split(',').map(n=>+n);
  const lum = 0.2126*(r/255) + 0.7152*(g/255) + 0.0722*(b/255);
  return lum > 0.55 ? '#000' : '#fff';
}

/* === Popover portal & posisjonering === */
let currentOpenPopover = null;
function hidePopover(p){
  if(!p) return;
  p.classList.add('hidden');
  p.style.visibility = 'hidden';
  if(currentOpenPopover===p) currentOpenPopover=null;
}
function positionPopoverNear(pop, anchorEl){
  if(pop.parentNode !== document.body){ document.body.appendChild(pop); }
  pop.classList.remove('hidden');
  pop.style.visibility = 'hidden';
  const a = anchorEl.getBoundingClientRect();
  const pw = pop.offsetWidth || 120;
  const ph = pop.offsetHeight || 120;
  let top  = a.bottom + 8;
  let left = a.left;
  const maxL = window.innerWidth - pw - 8;
  if(left > maxL) left = Math.max(8, maxL);
  if(left < 8)    left = 8;
  if(top + ph > window.innerHeight - 8){
    top = a.top - ph - 8;
    if(top < 8) top = Math.max(8, window.innerHeight - ph - 8);
  }
  pop.style.top  = `${Math.round(top)}px`;
  pop.style.left = `${Math.round(left)}px`;
  pop.style.visibility = 'visible';
  currentOpenPopover = pop;
}

/* ===== Product Color Picker ===== */
function buildProductColorPicker(td, input, row){
  const wrap = document.createElement('span');
  wrap.className = 'product-color-wrap';
  if(input.parentNode===td) td.removeChild(input);
  wrap.appendChild(input);

  const chip = document.createElement('span');
  chip.className = 'color-chip';
  chip.title = 'Pick color';

  if(row.productColor){
    chip.style.setProperty('--chip-color', row.productColor);
    input.classList.add('product-input');
    input.style.setProperty('--col-rgb', toRgbStr(row.productColor));
    input.style.color = bestTextColor(row.productColor);
  }

  const pop = document.createElement('div');
  pop.className = 'color-popover hidden';

  const clear = document.createElement('div');
  clear.className = 'color-option clear';
  clear.title = 'Clear';
  clear.onclick = (e)=>{
    e.stopPropagation();
    row.productColor = null;
    input.classList.remove('product-input');
    input.style.removeProperty('--col-rgb');
    input.style.color = '';
    chip.style.removeProperty('--chip-color');
    save();
    hidePopover(pop);
  };
  pop.appendChild(clear);

  PRODUCT_COLORS.forEach(col=>{
    const sw = document.createElement('div');
    sw.className = 'color-option';
    sw.style.background = col;
    sw.title = col;
    sw.onclick = (e)=>{
      e.stopPropagation();
      row.productColor = col;
      input.classList.add('product-input');
      input.style.setProperty('--col-rgb', toRgbStr(col));
      input.style.color = bestTextColor(col);
      chip.style.setProperty('--chip-color', col);
      save();
      hidePopover(pop);
    };
    pop.appendChild(sw);
  });

  wrap.appendChild(chip);
  td.appendChild(wrap);

  chip.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(currentOpenPopover && currentOpenPopover!==pop) hidePopover(currentOpenPopover);
    if(pop.classList.contains('hidden')){ positionPopoverNear(pop, chip); } else { hidePopover(pop); }
  });

  document.addEventListener('click', (ev)=>{
    if(pop.classList.contains('hidden')) return;
    if(pop.contains(ev.target) || chip.contains(ev.target)) return;
    hidePopover(pop);
  });
}

/* ===== Header Color ===== */
function applyHeaderStyle(td, row){
  const span = td.querySelector('span');
  if(row.headerColor){
    const col = row.headerColor;
    td.style.background = `linear-gradient(to right, ${col}36, ${col}10)`;
    td.style.borderColor = 'rgba(255,255,255,.18)';
    if(span) span.style.color = bestTextColor(col);
  }else{
    td.style.background = '';
    td.style.borderColor = '';
    if(span) span.style.color = '';
  }
}
function buildHeaderColorPicker(hostTd, row){
  hostTd.style.position = hostTd.style.position || 'relative';

  const chip = document.createElement('span');
  chip.className = 'header-color-chip';
  chip.title = 'Pick header color';
  if(row.headerColor) chip.style.background = row.headerColor;

  const pop = document.createElement('div');
  pop.className = 'color-popover hidden';

  const clear = document.createElement('div');
  clear.className = 'color-option clear';
  clear.title = 'Clear';
  clear.onclick = (e)=>{
    e.stopPropagation();
    row.headerColor = null;
    chip.style.background = 'rgba(255,255,255,.15)';
    applyHeaderStyle(hostTd, row);
    save();
    hidePopover(pop);
  };
  pop.appendChild(clear);

  PRODUCT_COLORS.forEach(col=>{
    const sw = document.createElement('div');
    sw.className = 'color-option';
    sw.style.background = col;
    sw.title = col;
    sw.onclick = (e)=>{
      e.stopPropagation();
      row.headerColor = col;
      chip.style.background = col;
      applyHeaderStyle(hostTd, row);
      save();
      hidePopover(pop);
    };
    pop.appendChild(sw);
  });

  hostTd.appendChild(chip);

  chip.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(currentOpenPopover && currentOpenPopover!==pop) hidePopover(currentOpenPopover);
    if(pop.classList.contains('hidden')){ positionPopoverNear(pop, chip); } else { hidePopover(pop); }
  });

  document.addEventListener('click', (ev)=>{
    if(pop.classList.contains('hidden')) return;
    if(pop.contains(ev.target) || chip.contains(ev.target)) return;
    hidePopover(pop);
  });
}

/* ===== Tabellbygging (med IMAGE-kolonne) ===== */
function showCategory(){
  const content=document.getElementById("content");
  content.innerHTML="";
  if(!activeCategory || !data[activeCategory]) return;

  const table=document.createElement("table");
  table.innerHTML=`
    <thead>
      <tr>
        <th>Product</th><th>Start Qty</th><th>Used</th><th>End Qty</th>
        <th>MINüîî</th><th>MAXüîî</th><th>Image</th><th>Comments</th><th>Order</th><th>Move</th><th>Delete</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody=table.querySelector("tbody");

  data[activeCategory].forEach((row,i)=>{
    const tr=document.createElement("tr");

    if(row.type==="header"){
      tr.className="header-row";
      const td=document.createElement("td");
      td.colSpan=11;
      const span=document.createElement("span");
      span.contentEditable=true;
      span.textContent=row.text||"Section / Header";
      span.oninput=()=>{ row.text=span.textContent; save(); };
      td.appendChild(span);
      tr.appendChild(td);
      tbody.appendChild(tr);

      buildHeaderColorPicker(td, row);
      applyHeaderStyle(td, row);

      const sub=document.createElement("tr");
      sub.className="section-columns";
      sub.innerHTML=`
        <td>Product</td>
        <td>Start Qty</td>
        <td>Used</td>
        <td>End Qty</td>
        <td>MINüîî</td>
        <td>MAXüîî</td>
        <td>Image</td>
        <td>Comments</td>
        <td>Order</td>
        <td>Move</td>
        <td><button class="btn-danger" onclick="deleteRow(${i})">Delete</button></td>
      `;
      tbody.appendChild(sub);
      return;
    }

    row.product ??=""; row.start ??=0; row.used ??=0; row.end ??=(parseFloat(row.start)||0)-(parseFloat(row.used)||0);
    row.min ??=0; row.max ??=0; row.comment ??=""; row.order ??=0; row.image ??=null; row.productColor ??=null;

    const fields=['product','start','used','end','min','max','image','comment','order'];
    const inputs={};

    fields.forEach((key)=>{
      const td=document.createElement("td");
      if(key==='product') td.classList.add("cell-product");
      else if(key==='comment') td.classList.add("cell-comment");
      else if(key==='min') td.classList.add("cell-min");
      else if(key==='max') td.classList.add("cell-max");
      else if(key==='order') td.classList.add("cell-order");
      else td.classList.add("cell-small");

      if(key==='image'){
        td.classList.add("cell-image");
        const fileInput = document.createElement("input");
        fileInput.type="file"; fileInput.accept="image/*"; fileInput.style.display="none";
        const inputId=`file-${activeCategory}-${i}`; fileInput.id=inputId;

        const customButton=document.createElement("button");
        customButton.textContent="üì∑ Upload";
        customButton.className="upload-btn";
        customButton.style.padding="6px 10px";
        customButton.onclick=(e)=>{ e.preventDefault(); document.getElementById(inputId).click(); };

        const preview=document.createElement("img");
        preview.style.maxWidth="60px"; preview.style.maxHeight="50px";
        preview.style.display=row.image ? "block" : "none";
        if(row.image) preview.src=row.image;
        preview.style.cursor="pointer";
        preview.onclick=()=>{ openImageModal(preview.src); };

        fileInput.onchange=(e)=>{
          const file=e.target.files[0];
          if(file){
            const reader=new FileReader();
            reader.onload=function(evt){
              row.image=evt.target.result;
              preview.src=row.image; preview.style.display="block"; save();
            };
            reader.readAsDataURL(file);
          }
        };

        const wrap=document.createElement("div");
        wrap.className="image-upload-container";
        wrap.appendChild(customButton); wrap.appendChild(preview);

        

        td.appendChild(fileInput);
        td.appendChild(wrap);
        tr.appendChild(td);
        return;
      }

      const input=document.createElement("input");
      input.type=(key==='product'||key==='comment')?"text":"number";
      input.value=row[key] ?? "";
      input.style.width="90%"; input.style.padding="8px"; input.style.borderRadius="10px";
      input.placeholder=key.charAt(0).toUpperCase()+key.slice(1);
      input.classList.add("large-bold-input");
      if(key==='end'){ input.readOnly=true; }

      input.oninput=()=>{
        row[key]=input.value;
        const startVal=parseFloat(row.start)||0;
        const usedVal=parseFloat(row.used)||0;
        row.end = startVal - usedVal;
        inputs['end'].value = row.end;
        updateAlarms();
        save();
      };

      inputs[key]=input;
      td.appendChild(input);

      if(key==='product'){
        if(row.productColor){
          input.classList.add('product-input');
          input.style.setProperty('--col-rgb', toRgbStr(row.productColor));
          input.style.color = bestTextColor(row.productColor);
        }
        buildProductColorPicker(td, input, row);
      }

      tr.appendChild(td);
    });

    function updateAlarms(){
      const startVal=parseFloat(inputs['start'].value);
      const usedVal=parseFloat(inputs['used'].value);
      const endVal=(isNaN(startVal)?0:startVal)-(isNaN(usedVal)?0:usedVal);
      inputs['end'].value=endVal;
      const minVal=parseFloat(inputs['min'].value);
      const maxVal=parseFloat(inputs['max'].value);

      if(!isNaN(endVal) && !isNaN(minVal) && endVal<=minVal) inputs['min'].classList.add("min-alarm");
      else inputs['min'].classList.remove("min-alarm");

      if(!isNaN(startVal) && !isNaN(maxVal) && startVal>maxVal) inputs['max'].classList.add("max-alarm");
      else inputs['max'].classList.remove("max-alarm");
    }
    updateAlarms();

    const tdMove=document.createElement("td"); tdMove.classList.add("cell-move");
    tdMove.innerHTML=`<button onclick="moveRow(${i},-1)">‚¨ÜÔ∏è</button> <button onclick="moveRow(${i},1)">‚¨áÔ∏è</button>`;
    const tdDel=document.createElement("td"); tdDel.innerHTML=`<button class="btn-danger" onclick="deleteRow(${i})">Delete</button>`;
    tr.appendChild(tdMove); tr.appendChild(tdDel);
    tbody.appendChild(tr);
  });

  /* FOOT: Send to Orders under Order-kolonnen (index 8) */
  const tfoot = document.createElement("tfoot");
  const footRow = document.createElement("tr");
  for (let c = 0; c < 11; c++) {
    const td = document.createElement("td");
    if (c === 8) {
      const sendBtn = document.createElement("button");
      sendBtn.className = "send-orders-button";
      sendBtn.textContent = "Active Category to Orders üì¶";
      sendBtn.onclick = sendToOrders;
      td.appendChild(sendBtn);
    }
    footRow.appendChild(td);
  }
  tfoot.appendChild(footRow);
  table.appendChild(tfoot);

  content.appendChild(table);

  const addLine=document.createElement("button");
  addLine.className="global-button"; addLine.textContent="+ Add line";
  addLine.onclick=()=>{ data[activeCategory].push({type:"line", product:"", start:0, used:0, end:0, min:0, max:0, image:null, comment:"", order:0, productColor:null}); save(); showCategory(); };

  const addHeader=document.createElement("button");
  addHeader.className="global-button"; addHeader.textContent="+ Add header/section";
  addHeader.onclick=()=>{ data[activeCategory].push({type:"header", text:"New Header"}); save(); showCategory(); };

  content.appendChild(addLine); content.appendChild(addHeader);
  searchInPage();
}

function deleteRow(index){ data[activeCategory].splice(index,1); save(); showCategory(); }
function moveRow(index, direction){
  const list=data[activeCategory]; const newIndex=index+direction;
  if(newIndex<0 || newIndex>=list.length) return;
  const temp=list[index]; list[index]=list[newIndex]; list[newIndex]=temp;
  save(); showCategory();
}

/* Send alle linjer med Order>0 til Orders.html */
function sendToOrders(){
  const payload = [];
  Object.entries(data).forEach(([category, rows])=>{
    (rows || []).forEach(r=>{
      if (r && r.type !== "header") {
        const qty  = Number(r.order) || 0;
        const prod = (r.product || "").trim();
        if (prod && qty > 0) {
          payload.push({ product: prod, quantity: qty, category });
        }
      }
    });
  });
  localStorage.setItem("ordersTransfer", JSON.stringify(payload));
  window.location.href = "Orders.html";
}

/* Global oversikt */
function showGlobalOverview(){
  const content=document.getElementById("content");
  content.innerHTML="<h2>Global overview of the entire equipment inventory</h2>";
  const table=document.createElement("table");
  table.className = "global-overview-table";
  table.innerHTML=`
    <thead>
      <tr><th>Category</th><th>product</th><th>Start</th><th>Used</th><th>End</th><th>Min</th><th>Max</th><th>Comment</th><th>Order</th></tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody=table.querySelector("tbody");
  Object.entries(data).forEach(([category, rows])=>{
    rows.forEach(row=>{
      if(row.type==="header") return;
      const tr=document.createElement("tr");
      const start=parseFloat(row.start)||0;
      const used =parseFloat(row.used)||0;
      const end  = (typeof row.end!=="undefined") ? row.end : (start-used);
      const min  = parseFloat(row.min)||0;
      const max  = parseFloat(row.max)||0;
      const values=[category, row.product||"", start, used, end, min, max, row.comment||"", row.order||""];
      values.forEach(val=>{ const td=document.createElement("td"); td.textContent=val; tr.appendChild(td); });
      tbody.appendChild(tr);
    });
  });
  content.appendChild(table);
}

if(!data[activeCategory]){ data[activeCategory]=[]; save(); }

let isGlobalView=false;
function toggleGlobalView(){
  const button=document.getElementById("globalToggleButton");
  if(!isGlobalView){ showGlobalOverview(); button.textContent="üîô Back to control table"; }
  else { showCategory(); button.textContent="üìã Global Overview"; }
  isGlobalView=!isGlobalView;
}

/* ===== PDF (hvit bakgrunn, svart tabell, 1.45x font i tabell) ===== */
async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','mm','a4');

  const today = new Date().toLocaleDateString();
  doc.setFont("helvetica","bold");
  doc.setFontSize(22);
  doc.text("Seavo Equipment", 105, 15, { align: "center" });
  doc.setFontSize(10);
  doc.text("Generated: " + today, 105, 22, { align: "center" });

  const content = document.getElementById("content");

  /* Skjul knapper i skjermdumpen */
  const buttons = content.querySelectorAll("button, .btn, .delete-button");
  buttons.forEach(btn => btn.style.display = "none");

  /* Midlertidig stil for PDF: hvit bakgrunn, svart tekst, 1.45x font i tabell */
  const styleTag = document.createElement("style");
  styleTag.id = "pdfStyleSeavo";
  styleTag.textContent = `
    #content { background:#ffffff !important; }
    #content * { color:#000 !important; box-shadow:none !important; }
    #content table, #content th, #content td { 
      color:#000 !important; 
      border-color:#000 !important; 
      background:transparent !important; 
      font-size: 145% !important;     /* 1.45x */
      line-height: 1.35 !important;
    }
    #content th { 
      background:#e6e6e6 !important;   /* lys gr√• header */
      font-weight:bold !important;
    }
    #content th, #content td { padding: 8px !important; }
  `;
  document.head.appendChild(styleTag);

  /* Render til canvas ‚Äì lavere scale for fart, hvit bakgrunn */
  const canvas = await html2canvas(content, {
    backgroundColor:"#ffffff",
    scale: 2,
    scrollX: 0,
    scrollY: -window.scrollY
  });

  /* Rydd opp: fjern midlertidig stil */
  styleTag.remove();

  /* Vis knapper igjen */
  buttons.forEach(btn => btn.style.display = "");

  /* Legg bildet inn i PDF */
  const imgData = canvas.toDataURL("image/png");
  const imgProps = doc.getImageProperties(imgData);
  const pdfWidth = doc.internal.pageSize.getWidth() - 20; // marger
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

  doc.addImage(imgData, "PNG", 10, 30, pdfWidth, pdfHeight);
  doc.save("SeavoNautiq_Inventory.pdf");
}

const themeSlider = document.getElementById('themeSlider');
themeSlider.addEventListener('input', () => {
  const value = parseInt(themeSlider.value);
  const lightness = 100 - (value * 8);
  const textColor = lightness < 45 ? '#ffffff' : '#000000';
  const boxColor = `hsl(210, 50%, ${Math.max(lightness - 10, 15)}%)`;
  const buttonColor = `hsl(210, 70%, ${Math.max(lightness - 5, 20)}%)`;
  const buttonText = lightness < 45 ? '#ffffff' : '#000000';

  document.documentElement.style.setProperty('--bg-lightness', `${lightness}%`);
  document.documentElement.style.setProperty('--text-color', textColor);
  document.documentElement.style.setProperty('--box-color', boxColor);
  document.documentElement.style.setProperty('--button-color', buttonColor);
  document.documentElement.style.setProperty('--button-text', buttonText);
});


const slider = document.getElementById("padding-slider");
const STORAGE_KEY = "tableCellPadding";

// Hent lagret verdi (eller 0 som standard)
const savedPadding = localStorage.getItem(STORAGE_KEY) || 0;
slider.value = savedPadding;
document.documentElement.style.setProperty("--cell-padding", savedPadding + "px");

// Oppdater n√•r slideren endres
slider.addEventListener("input", e=>{
  const value = e.target.value;
  document.documentElement.style.setProperty("--cell-padding", value + "px");
  localStorage.setItem(STORAGE_KEY, value);
});


/* ===== Calculator / Notepad (dine funksjoner, utvidet) ===== */
function openCalculator(){ document.getElementById("calculatorModal").style.display="block"; }
function closeCalculator(){ document.getElementById("calculatorModal").style.display="none"; }
function openNotepad(){ document.getElementById("notepadModal").style.display="block"; }
function closeNotepad(){ document.getElementById("notepadModal").style.display="none"; }

function appendCalc(v){ const d=document.getElementById('calc-display'); d.value+=v; }
function deleteLast(){ const d=document.getElementById('calc-display'); d.value=d.value.slice(0,-1); }
function clearCalc(){ document.getElementById('calc-display').value=''; }
function calculateResult(){
  const d=document.getElementById('calc-display');
  try{
    const expr=d.value.replace(/√ó/g,'*').replace(/√∑/g,'/');
    // gj√∏r 12% => 0.12
    const expr2=expr.replace(/(\d+(\.\d+)?)%/g,(_,n)=>String(parseFloat(n)/100));
    d.value=String(Function('"use strict";return ('+expr2+')')());
  }catch{ d.value='Error'; }
}

/* Notepad lagring */
function saveNote(){
  const v = document.getElementById('noteArea').value;
  localStorage.setItem('seavo_note', v);
}
function clearNote(){
  document.getElementById('noteArea').value='';
  localStorage.removeItem('seavo_note');
}

/* Drag-n-drop for modal-vinduer */
function makeDraggable(handleId, windowId){
  const handle=document.getElementById(handleId);
  const win=document.getElementById(windowId);
  if(!handle||!win) return;
  let offsetX=0, offsetY=0, dragging=false;

  const startDrag = (e)=>{
    dragging=true;
    const rect=win.getBoundingClientRect();
    const cx = (e.touches? e.touches[0].clientX : e.clientX);
    const cy = (e.touches? e.touches[0].clientY : e.clientY);
    offsetX=cx-rect.left; offsetY=cy-rect.top;
    document.body.style.userSelect='none';
  };
  const moveDrag = (e)=>{
    if(!dragging) return;
    const cx = (e.touches? e.touches[0].clientX : e.clientX);
    const cy = (e.touches? e.touches[0].clientY : e.clientY);
    win.style.left=(cx-offsetX)+'px';
    win.style.top=(cy-offsetY)+'px';
  };
  const endDrag = ()=>{
    dragging=false; document.body.style.userSelect='';
  };

  handle.addEventListener('mousedown', startDrag);
  window.addEventListener('mousemove', moveDrag);
  window.addEventListener('mouseup', endDrag);

  // touch-st√∏tte (valgfritt)
  handle.addEventListener('touchstart', startDrag, {passive:true});
  window.addEventListener('touchmove', moveDrag, {passive:false});
  window.addEventListener('touchend', endDrag);
}

/* Tastatursnarveier for kalkulator: Enter =, Esc = C, Backspace = DEL */
(function(){
  window.addEventListener('keydown', (e)=>{
    const k = e.key;
    if(document.getElementById('calculatorModal').style.display === 'block'){
      if(/^[0-9+\-*/%.]$/.test(k)) { appendCalc(k); e.preventDefault(); }
      else if(k === 'Enter') { calculateResult(); e.preventDefault(); }
      else if(k === 'Backspace') { deleteLast(); e.preventDefault(); }
      else if(k.toLowerCase() === 'c' || k === 'Escape') { clearCalc(); e.preventDefault(); }
    }
  });
})();

/* Init ved last: last notat, aktiver drag for begge vinduer */
document.addEventListener('DOMContentLoaded', ()=>{
  const saved = localStorage.getItem('seavo_note');
  if(saved!==null) document.getElementById('noteArea').value = saved;

  makeDraggable('calcDragHandle', 'calculatorWindow');
  makeDraggable('notepadDragHandle', 'notepadWindow');
});

/* Init */
document.addEventListener("DOMContentLoaded", ()=>{
  const openCalcBtn=document.getElementById("openCalculatorBtn");
  const openNoteBtn=document.getElementById("openNotepadBtn");
  const calcModal=document.getElementById("calculatorModal");
  const noteModal=document.getElementById("notepadModal");

  openCalcBtn?.addEventListener("click", openCalculator);
  openNoteBtn?.addEventListener("click", openNotepad);

  function backdropClose(e){
    if(e.target===calcModal) closeCalculator();
    if(e.target===noteModal) closeNotepad();
  }
  calcModal?.addEventListener("click", backdropClose);
  noteModal?.addEventListener("click", backdropClose);

  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape"){ closeCalculator(); closeNotepad(); } });

  const saved=localStorage.getItem('seavo_note');
  if(saved) document.getElementById('noteArea').value=saved;

  makeDraggable('calcDragHandle','calculatorWindow');
  makeDraggable('noteDragHandle','notepadWindow');
});

/* Popup-sider */
function √•pnePopup4() {
  window.open('Help.html','popup','width=1600,height=1200');
}
function √•pnePopup2() {
  window.open('Documents.html','popup','width=1600,height=1200');
}
function √•pnePopup7() {
  window.open('Settings.html','popup','width=1600,height=1200');
}

/* Start */
updateCategories();
showCategory();
</script>
</html>