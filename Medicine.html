<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Medicine â€“ Seavo Nautiq</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <!-- Kjerne (Ã©n gang, med defer) -->
  <script src="./js/seavo-core.js" defer></script>

  <style>
/* ====== THEME / BASE (samme palett som Office) ====== */
:root{
  --bg:#0f2a4a;
  --text:#ffffff;
  --muted:#bcd3f1;
  --accent:#62b2e7;
  --accent-2:#1b75d1;
  --accent-3:#0e3e86;
  --danger:#f03747;
  --warn:#ecc543;
  --ok:#28e755;
}

*{ box-sizing:border-box; }
body{
  background-color:var(--bg);
  font-family:Arial,sans-serif;
  margin:0;
  color:var(--text);
}

/* Header-video */
.video-header{ position:relative; aspect-ratio:1280/99; overflow:hidden; background:#000; }
.video-header video{ width:100%; height:200%; object-fit:cover; display:block; }
.gradient-overgang{ height:10px; background:linear-gradient(to left,#62b2e7,#001125); box-shadow:6px 4px 6px rgba(0,0,0,.7); }

/* Tittel */
h1{
  text-align:center; margin-top:20px; font-size:36px; font-weight:bold;
  text-shadow:0 1px 3px rgba(0,0,0,.6); color:rgb(30,182,209);
}

/* Bakgrunnsbilde (vannmerke) */
.medicine-image{
  width:100%; height:130%; position:absolute; top:0; left:0; z-index:-1; opacity:.08; pointer-events:none;
  filter:saturate(.9) contrast(1.05);
}

/* Panel / kort */
.panel{
  background:rgba(0,0,0,.25);
  padding:16px; margin:20px auto; max-width:1400px; border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  box-shadow:0 12px 28px rgba(0,0,0,.35);
}
.panel h2{ margin:4px 0 10px; }

/* Tabell (Office-look) */
table{
  width:100%; border-collapse:collapse; background:rgba(0,0,0,.20); color:var(--text);
  border:1px solid rgba(255,255,255,.12); border-radius:14px; overflow:hidden;
  box-shadow:0 12px 28px rgba(0,0,0,.35);
}
th,td{ border-bottom:1px solid rgba(255,255,255,.12); padding:8px; text-align:center; font-size:16px; }
th{ background:rgba(0,0,0,.28); color:var(--text); }

input[type="text"], input[type="number"], input[type="date"]{
  width:95%; padding:10px; border-radius:10px;
  background:rgba(0,0,0,.25); color:var(--text);
  border:1px solid rgba(255,255,255,.18);
  font-weight:700; font-size:14px;
  outline:none;
}
input[type="text"]::placeholder,
input[type="number"]::placeholder,
input[type="date"]::placeholder{ color:var(--muted); }
input:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(98,178,231,.18); }



/* Knapper (Office-gradients) */
.btn{
  padding:10px 16px; border:none; border-radius:12px; cursor:pointer; font-weight:700; font-size:14px;
  background:linear-gradient(to right,var(--accent-2),var(--accent-3));
  color:#fff; border:1px solid rgba(255,255,255,.12); box-shadow:0 6px 16px rgba(0,0,0,.35);
}
.btn:hover{ filter:brightness(1.25); }
.btn-del{ background:linear-gradient(to right,#f13e4e,#a31621); }
.btn-pdf{ background:linear-gradient(to right,#6c757d,#495057); }

/* MIN-alarm */
.min-alarm{
  background:linear-gradient(to right, rgba(255,255,255,.2), rgba(247,230,0,.35)) !important;
}

/* Expiry "trafikklys" */
.expiry-green{
  background:linear-gradient(to right,#00000080,#39e9a0a1) !important; color:#000; font-weight:bold;
  box-shadow:0 0 6px rgba(0,0,0,.4);
}
.expiry-yellow{
  background:linear-gradient(to right,#00000088,#ffda478e) !important; color:#000; font-weight:bold;
  box-shadow:0 0 6px rgba(0,0,0,.4);
}
.expiry-red{
  background:linear-gradient(to right,#0000008a,#d12e2e9f) !important; color:#000; font-weight:bold;
  box-shadow:0 0 6px rgba(0,0,0,.4);
}

/* Print */
@media print{
  body{ background:#fff; color:#000; }
  .video-header,.gradient-overgang{ display:none !important; }
  table{ background:#fff; color:#000; box-shadow:none; border:1px solid #ccc; }
  th{ background:#f2f2f2; color:#000; }
}
  </style>
</head>
<body>
<header class="video-header">
  <video autoplay muted loop playsinline disablePictureInPicture>
    <source src="Video/Ocean-Seavo-Nautiq.mp4" type="video/mp4">
  </video>
</header>
<div class="gradient-overgang"></div>

<h1>Medicine</h1>

<div><img src="images/Medicine chest.PNG" alt="Medicine" class="medicine-image"></div>

<div id="printArea">
  <div class="panel">
    <h2>Registration</h2>
    <table>
      <tr>
        <td><label>Registration Date<br><input type="date" id="regDate"></label></td>
        <td><label>Expiry Date<br><input type="date" id="regExpiry"></label></td>
        <td><label>Medicine Issuer<br><input type="text" id="issuer" placeholder="Company / Clinic"></label></td>
        <td><label>Responsible Officer<br><input type="text" id="officer" placeholder="Name/Role"></label></td>
        <td><label>Notes<br><input type="text" id="notes" placeholder="Optional notes"></label></td>
      </tr>
    </table>
  </div>

  <div class="panel">
    <h2>Medicine Chest</h2>
    <table id="medicineTable">
      <thead>
        <tr>
          <th>Medical equipment</th>
          <th>Qty</th>
          <th>MINðŸ””</th>
          <th>Expiry date</th>
          <th>Comments</th>
          <th>Order</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody><!-- fylles fra localStorage --></tbody>
    </table>
    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" onclick="addMedicineLine()">+ Add Line</button>
      <button class="btn btn-pdf" onclick="generatePDF()">ðŸ“„ Generate PDF (B/W)</button>
    </div>
  </div>
</div>

<!-- jsPDF + AutoTable for ren s/h-rapport -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

<script>
/* =======================
   LOCAL STORAGE + CORE SYNC
   ======================= */
const LS_KEY = 'sn.medicine.v1';

function loadPageState(){
  try { return JSON.parse(localStorage.getItem(LS_KEY)) || null; }
  catch { return null; }
}
function savePageState(state){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

/* Serialize hele siden (registrering + rader) */
function serializePage(){
  const regs = {
    regDate:  document.getElementById('regDate')?.value || '',
    regExpiry:document.getElementById('regExpiry')?.value || '',
    issuer:   document.getElementById('issuer')?.value || '',
    officer:  document.getElementById('officer')?.value || '',
    notes:    document.getElementById('notes')?.value || ''
  };
  const rows = Array.from(document.querySelectorAll('#medicineTable tbody tr')).map(tr=>{
    const id = tr.getAttribute('data-row-id') || '';
    const get = sel => tr.querySelector(sel);
    return {
      id,
      name:   get('.product-name')?.value?.trim() || '',
      qty:    get('.qty-input')?.value || '',
      min:    get('.min-input')?.value || '',
      expiry: get('.expiry-input')?.value || '',
      comment:get('.comment-input')?.value || '',
      order:  get('.order-input')?.value || ''
    };
  });
  return { regs, rows };
}

/* Render fra state */
function renderFromState(state){
  // Registrering
  const r = state?.regs || {};
  document.getElementById('regDate').value   = r.regDate   || '';
  document.getElementById('regExpiry').value = r.regExpiry || '';
  document.getElementById('issuer').value    = r.issuer    || '';
  document.getElementById('officer').value   = r.officer   || '';
  document.getElementById('notes').value     = r.notes     || '';

  // Rader
  const tbody = document.querySelector('#medicineTable tbody');
  tbody.innerHTML = '';
  (state?.rows || []).forEach(row => {
    const tr = createMedicineRow(row);
    tbody.appendChild(tr);
  });

  // Farg registreringens expiry
  applyExpiryClass(document.getElementById('regExpiry'));
  // Farg alle raders expiry
  document.querySelectorAll('.expiry-input').forEach(applyExpiryClass);

  // Sync til core
  scanAndSyncMedicine();
}

/* Lag en rad-node (brukes ved load og add) */
function createMedicineRow(data = {}){
  const tr = document.createElement('tr');
  tr.setAttribute('data-row-id', data.id || crypto.randomUUID());

  const tdEquip = document.createElement('td');
  const equip = document.createElement('input');
  equip.type = "text"; equip.placeholder="Med Eq"; equip.className = "product-name";
  equip.value = data.name || '';
  tdEquip.appendChild(equip);

  const tdQty = document.createElement('td');
  const qty = document.createElement('input');
  qty.type="number"; qty.value = data.qty || 0; qty.className = "qty-input";
  tdQty.appendChild(qty);

  const tdMin = document.createElement('td');
  const min = document.createElement('input');
  min.type="number"; min.value = data.min || 0; min.className = "min-input";
  tdMin.appendChild(min);

  const tdExp = document.createElement('td');
  const exp = document.createElement('input');
  exp.type="date"; exp.value = data.expiry || ''; exp.className = "expiry-input";
  tdExp.appendChild(exp);

  const tdCom = document.createElement('td');
  const com = document.createElement('input');
  com.type="text"; com.placeholder="Comments"; com.value = data.comment || ''; com.className = "comment-input";
  tdCom.appendChild(com);

  const tdOrder = document.createElement('td');
  const order = document.createElement('input');
  order.type="number"; order.value = data.order || 0; order.className = "order-input";
  tdOrder.appendChild(order);

  const tdDel = document.createElement('td');
  const delBtn = document.createElement('button');
  delBtn.textContent="ðŸ—‘ï¸";
  delBtn.className="btn btn-del";
  delBtn.addEventListener('click', ()=>{
    const name = equip.value?.trim() || '[Unnamed]';
    tr.remove();
    medLog(`Deleted "${name}" from Medicine`);
    persistAndSync();
  });
  tdDel.appendChild(delBtn);

  tr.append(tdEquip, tdQty, tdMin, tdExp, tdCom, tdOrder, tdDel);

  // Alarmer
  function checkAlarms(){
    const q = parseFloat(qty.value)||0;
    const m = parseFloat(min.value)||0;
    if(q <= m){ min.classList.add("min-alarm"); } else { min.classList.remove("min-alarm"); }
    applyExpiryClass(exp);
  }
  qty.addEventListener('input', ()=>{ checkAlarms(); persistAndSync(); });
  min.addEventListener('input', ()=>{ checkAlarms(); persistAndSync(); });
  exp.addEventListener('input', ()=>{
    checkAlarms();
    medLog(`Updated expiry for "${equip.value?.trim() || '[Unnamed]'}" to ${exp.value}`);
    persistAndSync();
  });
  equip.addEventListener('input', ()=>{ persistAndSync(); });
  com.addEventListener('input',  ()=>{ persistAndSync(); });
  order.addEventListener('input',()=>{ persistAndSync(); });

  // Init farger
  checkAlarms();

  return tr;
}

/* Lagre + sync */
function persistAndSync(){
  savePageState(serializePage());
  scanAndSyncMedicine();
}

/* ====== UI: farg utlÃ¸psdato lokalt (50/20-dagers terskel) ====== */
function applyExpiryClass(el){
  if(!el) return;
  el.classList.remove("expiry-green","expiry-yellow","expiry-red");
  if(!el.value) return;
  const today = new Date(); today.setHours(0,0,0,0);
  const exp   = new Date(el.value); exp.setHours(0,0,0,0);
  const diffDays = Math.ceil((exp - today) / 86400000);
  if(diffDays <= 20){ el.classList.add("expiry-red"); }
  else if(diffDays <= 50){ el.classList.add("expiry-yellow"); }
  else { el.classList.add("expiry-green"); }
}

/* ====== CORE-bridge: send snapshot til Index ====== */
function scanAndSyncMedicine(){
  const rows = Array.from(document.querySelectorAll('#medicineTable tbody tr'))
    .filter(tr => !tr.classList.contains('header-row'));

  const items = rows.map(tr => {
    let id = tr.getAttribute('data-row-id');
    if(!id){ id = crypto.randomUUID(); tr.setAttribute('data-row-id', id); }
    const nameEl = tr.querySelector('.product-name');
    const expEl  = tr.querySelector('.expiry-input');
    const name = nameEl ? (nameEl.value?.trim?.() || nameEl.textContent?.trim?.() || '') : '';
    const expiryISO = expEl?.value || '';
    return { id, name, expiryISO };
  });

  // <-- Viktig: pageKey = 'medicine'
  seavo.syncInventory('medicine', items);
}

/* ====== Aktivitetslogg helper ====== */
function medLog(text){
  seavo.logActivity({ text, source: 'Medicine', type: 'action' });
}

/* ====== Public: Add line-knappen ====== */
function addMedicineLine(){
  const tbody = document.querySelector("#medicineTable tbody");
  const tr = createMedicineRow();
  tbody.appendChild(tr);
  medLog('Added new medicine line');
  persistAndSync();
}

/* ====== Registreringens Expiry farging + lagring ====== */
(function initRegistrationExpiry(){
  const regDate   = document.getElementById("regDate");
  const regExpiry = document.getElementById("regExpiry");
  const issuer    = document.getElementById("issuer");
  const officer   = document.getElementById("officer");
  const notes     = document.getElementById("notes");

  const onChange = (e)=>{
    if(e?.target === regExpiry) applyExpiryClass(regExpiry);
    persistAndSync();
  };

  [regDate, regExpiry, issuer, officer, notes].forEach(el=>{
    if(el) el.addEventListener('input', onChange);
  });
})();

/* ====== Init ved last ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  const saved = loadPageState();
  if(saved){
    renderFromState(saved);
  } else {
    // Tom state: start med en blank rad
    addMedicineLine();
    persistAndSync();
  }
});
</script>

<script>
/* ---- PDF (svart/hvitt) med jsPDF AutoTable ---- */
async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  const left = 40;

  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text('Seavo Nautiq â€” Medicine Register', left, 50);

  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  let y = 75;
  const reg = {
    'Registration Date': document.getElementById('regDate').value || 'â€”',
    'Expiry Date': document.getElementById('regExpiry').value || 'â€”',
    'Medicine Issuer': document.getElementById('issuer').value || 'â€”',
    'Responsible Officer': document.getElementById('officer').value || 'â€”',
    'Notes': document.getElementById('notes').value || 'â€”'
  };
  Object.entries(reg).forEach(([k,v]) => { doc.text(`${k}: ${v}`, left, y); y += 16; });

  const rows = [];
  document.querySelectorAll('#medicineTable tbody tr').forEach(tr => {
    const tds = tr.querySelectorAll('td');
    const getVal = (tdIndex) => (tds[tdIndex]?.querySelector('input')?.value || '').trim();
    rows.push([ getVal(0), getVal(1), getVal(2), getVal(3), getVal(4), getVal(5) ]);
  });

  doc.autoTable({
    startY: y + 6,
    head: [['Medical equipment','Qty','MIN','Expiry date','Comments','Order']],
    body: rows.length ? rows : [['â€”','â€”','â€”','â€”','â€”','â€”']],
    styles: { font: 'helvetica', fontSize: 10, textColor: [0,0,0], lineColor: [0,0,0], lineWidth: 0.5 },
    headStyles: { fillColor: [255,255,255], textColor: [0,0,0] },
    alternateRowStyles: { fillColor: [245,245,245] },
    margin: { left, right: left }
  });

  const pageCount = doc.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setFontSize(9);
    doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.getWidth()-left, doc.internal.pageSize.getHeight()-20, { align: 'right' });
  }

  doc.save('Medicine_Register.pdf');
}
</script>
</body>
</html>