<!DOCTYPE html> 
<html lang="en"> 
  <head> 
    <meta charset="UTF-8"> 
    <title>Seavo Nautiq-Office</title>

    <style>
      
  body {
    background-color: #12315c;
    font-family: Arial, sans-serif;
    margin: 0;
    color: #fff;
  }

  .video-header {
    position: relative;
    aspect-ratio: 1280/99;
    overflow: hidden;
    background: #000;
  }

  .video-header video {
    width: 100%;
    height: 200%;
    object-fit: cover;
    display: block;
  }

  .gradient-overgang {
    height: 10px;
    background: linear-gradient(to left, #62b2e7, #001125);
    box-shadow: 6px 4px 6px rgba(0, 0, 0, .7)
  }

  .category-slider-office {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(to right, #041425, #3b7fbe);
    padding: 20px;
    overflow-x: auto;
    margin-bottom: -10px;
    width: 90%;
    margin-left: 70px;
    border-radius: 12px;
  }

  .category-item {
    display: flex;
    align-items: center;
    margin: 0 6px;
  }

  .category-button,
  .add-category {
    padding: 10px 20px;
    background: linear-gradient(to right, #00b7ff, #326fa8);
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    margin-left: 20px;
  }

  .category-button.active {
    background: #9ccdfa;
    font-weight: bold;
  }

  .category-button:hover,
  .add-category:hover {
    background: #56bafd;
    color: #fff;
  }

  .delete-category {
    color: #f00;
    font-size: 20px;
    margin-left: 20px;
    cursor: pointer;
  }

  .arrow {
    font-size: 20px;
    font-weight: bold;
    padding: 5px 10px;
    background: transparent;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    width: 60px;
    box-shadow: 0 0 10px rgba(0, 0, 0, .6);
    margin-left: 40px;
  }

  .arrow:hover {
    background: #326fa8;
    color: #fff;
  }

  #content {
    padding: 60px;
  }

  .logo {
    width: 200px;
    height: auto;
    border-radius: 6px;
    box-shadow: 0 0 10px rgba(0, 0, 0, .6);
    cursor: pointer;
    margin-left: 60px;
  }

  .logo:hover {
    transform: scale(1.08);
    transition: transform .2s ease;
    box-shadow: 0 0 30px rgba(255, 255, 255, .8);
  }

  #searchBox {
    width: 200px;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #000;
    box-shadow: 0 0 10px rgba(0, 0, 0, .6);
    margin-left: 60px;
    margin-top: 50px;
    margin-bottom: 20px;
    font-weight: bold;
  }

  .office {
    width: 100%;
    height: 130%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
    opacity: .1;
    pointer-events: none;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #1f3b66;
    color: #000;
    margin-bottom: 20px;
    box-shadow: 0 0 10px rgba(0, 0, 0, .6);
  }

  .large-bold-input {
    font-weight: bold;
    font-size: 14px;
  }

  .cell-min,
  .cell-max {
    width: 45px;
    min-width: 45px;
    max-width: 45px;
  }

  .cell-min input,
  .cell-max input {
    width: 100%;
    box-sizing: border-box;
  }

  .cell-order {
    width: 40px;
  }

  .cell-move {
    width: 60px;
  }

  th,
  td {
    border: 1px solid #112036;
    padding: 5px;
    text-align: center;
    font-size: 18px;
  }

  th {
    background-color: #13a2e4;
    color: #000;
    border-radius: 5px;
  }

  td.min-col input {
    width: 60px;
  }

  /* Alarmfarger */
  .min-alarm {
    background: linear-gradient(to right, #ffffff, #fcac01) !important; /* gulaktig */
  }

  .max-alarm {
    background: linear-gradient(to right, #ffffff, #c8ff02) !important; /* grønnaktig */
  }

  .add-line {
    padding: 8px 16px;
    margin: 5px 10px 20px 0;
    font-size: 15px;
    font-weight: bold;
    border-radius: 10px;
    background: linear-gradient(to right, #00b7ff, #326fa8);
    cursor: pointer;
    box-shadow: 0 0 10px rgba(0, 0, 0, .6);
  }

  .add-line:hover {
    background: #56bafd;
    color: #fff;
  }

  .color-btn.limegreen {
    background-color: #36d131;
  }

  .color-btn.gold {
    background-color: #ffd036;
  }

  .color-btn.mediumturquoise {
    background-color: #40e0d0;
  }

  .color-btn.white {
    background-color: #ffffff;
  }

  .color-btn {
    width: 18px;
    height: 10px;
    border-radius: 30%;
    cursor: pointer;
  }

  .color-btn:hover {
    outline: 1px solid #fff;
    box-shadow: 0 0 5px rgba(0, 0, 0, .6);
  }

  .color-buttons {
    display: inline-flex;
    flex-direction: column;
    gap: 1px;
    margin-left: 2px;
    vertical-align: middle;
  }

  .header-row td {
    background: linear-gradient(to left, #12315c, #79acee);
    font-weight: bold;
    text-align: left;
    border-radius: 5px;
    border-color: black;
  }

  .header-row td span {
    display: inline-block;
    width: 60%;
  }

  .delete-button {
    color: #000;
    cursor: pointer;
    font-size: 20px;
    text-shadow: 0 1px 3px rgba(0, 0, 0, .9);
  }

  .delete-button:hover {
    background-color: rgba(0, 0, 0, .3);
    border-radius: 50px;
    padding: 0 5px;
  }

  td:last-child {
    width: 50px;
    background: linear-gradient(to right, #4e9bce, #1b3863);
  }

  button img {
    width: 40px;
    height: 40px;
    padding-left: 55px;
    margin-top: 20px;
  }

  .global-button {
    background: linear-gradient(to right, #00b7ff, #326fa8);
    color: #fff;
    padding: 20px 15px;
    font-size: 15px;
    font-weight: bold;
    cursor: pointer;
    margin: 10px 60px;
    border-radius: 16px;
    box-shadow: 0 0 10px rgba(0, 0, 0, .6);
  }

  .global-button:hover {
    background: linear-gradient(to right, #56bafd, #0e385f);
    color: #fff;
  }

  .cell-product {
    width: 220px;
  }



  .cell-comment {
    width: 200px;
  }

  .cell-small {
    width: 80px;
  }

  .cell-move {
    width: 60px;
  }

  .cell-move button {
    width: 40px;
    height: 35px;
    background: linear-gradient(to right, #00b7ff, #326fa8);
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
  }

  .cell-move button:hover {
    background: #87cfff;
    color: #fff;
  }

  :root {
    --panel-w: 180px; /* bredde på sidepanel */
    --panel-h: 32vh;  /* høyde på sidepanel (lik din tidligere ~32%) */
    --handle-w: 28px; /* bredde på "toggle"-håndtaket som stikker ut */
  }



    #sidePanel{
      position: fixed;
      overflow: visible;
      top: 180px;
      right: 0;
      width: var(--panel-w);
      height: var(--panel-h);
      background: linear-gradient(to left,#072446,#306cc7);
      color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 10px;
      box-shadow: -2px 0 10px rgba(0,0,0,.5);
      transition: right .5s ease;
      z-index: 999;
      border-radius: 16px;
      border: 2px solid #13192c;
    }
    #sidePanel.hidden{ right: calc(-1 * (var(--panel-w) - var(--handle-w))); }

    /* Håndtaket, utenfor panelet */
    #togglePanelBtn{
      position: absolute;
      left: 0;
      top: 50%;
      transform: translate(-100%, -50%);
      width: var(--handle-w);
      height: clamp(96px, 50%, 180px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      background: linear-gradient(to bottom,#1a4ca8,#0d2c66);
      color: #fff;
      font-weight: bold;
      font-size: 26px;
      border-radius: 12px 0 0 12px;
      cursor: pointer;
      box-shadow: -8px 0 8px rgba(0,0,0,.3);
      user-select: none;
      z-index: 1000;
    }
    #togglePanelBtn:hover{ background:#96bad1; }

    #bottomButtons {
      margin-top: auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    /* Panelknapper – ekskluder toggle-handle */
    #sidePanel button:not(#togglePanelBtn) {
      margin: 4px 0;
      padding: 12px 20px;
      width: 100%;
      background: linear-gradient(to right, #123981, #1994db);
      color: #000;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
    }
    #sidePanel button:not(#togglePanelBtn):hover { background:#56bafd; }

    .highlight{background-color:rgb(240,138,42); font-weight:bold;}
    .highlight-input{background-color:yellow; font-weight:bold;}

    /* Modal overlay og vindu */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: none; /* vises av open*() */
      z-index: 1500; /* over sidepanel */
    }
    .modal-innhold{
      position: absolute;
      left: 300px;
      top: 200px;
      transform: translate(0, 0);
      background: linear-gradient(to right, #041425, #10395f);
      padding: 15px;
      width: 260px;
      border-radius: 18px;
      box-shadow: 0 0 12px #000;
      text-align: center;
      z-index: 1501;
    }
    .calculator-header {
      background: linear-gradient(to right, #104f68, #326fa8);
      color: white;
      padding: 5px;
      cursor: move;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .lukk { font-weight: bold; font-size: 25px; cursor: pointer; }

    #calc-buttons button {
      width: 46px;
      height: 40px;
      font-size: 18px;
      margin: 3px;
      background: linear-gradient(to right, #00b7ff, #326fa8);
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    #calc-buttons button:hover {
      background: #87cfff;
      color: white;
      
    }

    .product-color-wrap {
  display: grid !important;
  grid-template-columns: 1fr auto; /* input | chip */
  align-items: center;
  column-gap: 6px;
  width: 100%;
}

.product-color-wrap input {
  width: 100% !important;
  min-width: 0;
}


    .product-color-wrap { display:inline-flex; align-items:center; gap:6px; position: relative; }
.color-chip {
  background-color: #34d469;
  width: 16px; height: 16px; border-radius: 4px;
  border: 1px solid rgba(0,0,0,.35); cursor: pointer; box-shadow: 0 0 4px rgba(0,0,0,.25);
}
.color-popover {
  position: absolute; top: 28px; left: 0px;
  display: grid; grid-template-columns: repeat(4, 18px); gap: 6px;
  background: #0d1d31; padding: 10px; border-radius: 10px;
  border: 1px solid #1c3e6e; box-shadow: 0 6px 20px rgba(0,0,0,.45); z-index: 2000;
}
.color-popover.hidden { display: none; }
.color-option {
  width: 18px; height: 18px; border-radius: 4px; cursor: pointer;
  border: 1px solid rgba(0,0,0,.35); box-shadow: 0 0 3px rgba(0,0,0,.25);
}
.color-option.clear {
  background: linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 50%, #ccc 50%, #ccc 75%, transparent 75%, transparent);
  background-size: 8px 8px;
}

.color-option:hover, .color-chip:hover { outline: 1px solid #ffffff; }
  </style>
</head>

<header class="video-header">
  <video autoplay muted loop playsinline>
    <source src="Video/Ocean-Seavo-Nautiq.mp4" type="video/mp4">
  </video>
</header>
<div class="gradient-overgang"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<body>
<header>
  <h1 style="text-align:center; color:#dad7d7; margin-top:20px; font-size:36px; font-weight:bold; text-shadow:0 1px 3px rgba(0,0,0,.6);">Office</h1>
  <a href="index.html" class="logo-link"><img src="images/Logo Seavo Nautiq.png" alt="Logo Seavo Nautiq" class="logo"></a>

  <div id="sidePanel" class="hidden">
    <button>Help</button>
    <button>Documents</button>
    <button>Shared Content</button>
    <button>Settings</button>
    <button id="signOutBtn">Sign Out</button>

    <div id="bottomButtons">
      <button id="openCalculatorBtn">🧮 Calculator</button>
      <button id="openNotepadBtn">📝 Notepad</button>
    </div>

    <!-- Håndtaket -->
    <button id="togglePanelBtn" onclick="toggleSidePanel()">⫷</button>
  </div>
</header>

<input type="text" id="searchBox" placeholder="Search inventory..." oninput="searchInPage()">

<div class="category-slider-office">
  <button class="arrow" onclick="scrollSlider(-100)">←</button>
  <div id="category-container" style="display:flex; overflow-x:auto; max-width:50%; scroll-behavior:smooth;">
    <div id="categories" style="display:flex; gap:8px;"></div>
  </div>
  <button class="arrow" onclick="scrollSlider(100)">→</button>
  <button class="add-category" onclick="addCategory()">+ Category</button>
</div>

<div><img src="images/Office.PNG" alt="Office" class="office"></div>

<div id="content"></div>

<button id="globalToggleButton" class="global-button" onclick="toggleGlobalView()">📋 Global Overview</button>
<div>
  <button class="global-button" onclick="generatePDF()">📄 Generate PDF</button>
</div>
<div>
  <button class="global-button" onclick="save()">💾 Save</button>
</div>

<!-- ====== MODALS (UTENFOR panelet) ====== -->

<!-- CALCULATOR MODAL -->
<div id="calculatorModal" class="modal" style="display:none;">
  <div class="modal-innhold" id="calculatorWindow">
    <div class="calculator-header" id="calcDragHandle">
      <h2 style="margin: 0; font-size: 15px;">Calculator</h2>
      <span class="lukk" onclick="closeCalculator()">×</span>
    </div>
    <input id="calc-display" type="text" readonly style="width: 90%; padding: 10px; font-size: 25px; text-align: right; margin-top: 10px;"><br><br>
    <div id="calc-buttons">
      <button onclick="appendCalc('7')">7</button>
      <button onclick="appendCalc('8')">8</button>
      <button onclick="appendCalc('9')">9</button>
      <button onclick="appendCalc('/')">÷</button><br>
      <button onclick="appendCalc('4')">4</button>
      <button onclick="appendCalc('5')">5</button>
      <button onclick="appendCalc('6')">6</button>
      <button onclick="appendCalc('*')">×</button><br>
      <button onclick="appendCalc('1')">1</button>
      <button onclick="appendCalc('2')">2</button>
      <button onclick="appendCalc('3')">3</button>
      <button onclick="appendCalc('-')">−</button><br>
      <button onclick="appendCalc('0')">0</button>
      <button onclick="appendCalc('.')">.</button>
      <button onclick="calculateResult()">=</button>
      <button onclick="appendCalc('+')">+</button><br>
      <button onclick="appendCalc('%')">%</button>
      <button onclick="deleteLast()" style="width: 30%;">DEL</button><br>
      <button onclick="clearCalc()" style="width: 90%">C</button>
    </div>
  </div>
</div>

<!-- NOTEPAD MODAL -->
<div id="notepadModal" class="modal" style="display:none;">
  <div class="modal-innhold" id="notepadWindow">
    <div class="calculator-header" id="noteDragHandle">
      <h2 style="margin:0; font-size:15px;">Notepad</h2>
      <span class="lukk" onclick="closeNotepad()">×</span>
    </div>
    <textarea id="noteArea" style="width:100%; height:260px; margin-top:10px; border-radius:10px;"></textarea>
    <div style="margin-top:10px; display:flex; gap:8px; justify-content:center;">
      <button onclick="saveNote()" style="padding:8px 12px;">Save</button>
      <button onclick="clearNote()" style="padding:8px 12px;">Clear</button>
    </div>
  </div>
</div>

</body>

<script>
/* ===== Sidepanel toggle ===== */
function toggleSidePanel(){
  const panel = document.getElementById("sidePanel");
  const btn   = document.getElementById("togglePanelBtn");
  const nowHidden = panel.classList.toggle("hidden");
  btn.textContent = nowHidden ? "⫷" : "⫸";
}

/* ===== Søk/markering ===== */
function searchInPage(){
  const term=document.getElementById("searchBox").value.trim().toLowerCase();
  removeHighlights(); if(term==="") return;
  let firstMatch=null;
  document.querySelectorAll("td span").forEach(span=>{
    const content=span.textContent.toLowerCase();
    if(content.includes(term)){
      const index=content.indexOf(term);
      const original=span.textContent;
      const before=original.slice(0,index);
      const match=original.slice(index,index+term.length);
      const after=original.slice(index+term.length);
      span.innerHTML=`${before}<span class="highlight">${match}</span>${after}`;
      if(!firstMatch) firstMatch=span;
    }
  });
  document.querySelectorAll("input").forEach(input=>{
    if(input.value.toLowerCase().includes(term)){
      input.classList.add("highlight-input");
      if(!firstMatch) firstMatch=input;
    }
  });
  if(firstMatch){ setTimeout(()=>{ firstMatch.scrollIntoView({behavior:"smooth", block:"center"}); },100); }
}
function removeHighlights(){
  document.querySelectorAll("span .highlight").forEach(el=>{
    const parent=el.parentNode; parent.replaceChild(document.createTextNode(el.textContent), el); parent.normalize();
  });
  document.querySelectorAll(".highlight-input").forEach(input=> input.classList.remove("highlight-input"));
}

/* ===== Data/setup for tabeller (uendret logikk) ===== */
let data = JSON.parse(localStorage.getItem("lagerDataV3")) || {};
let activeCategory = Object.keys(data)[0] || "Standard";

function save(){ localStorage.setItem("lagerDataV3", JSON.stringify(data)); }
function scrollSlider(offset){ document.getElementById("category-container").scrollLeft += offset; }
Object.values(data).forEach(rows=>{
  (rows||[]).forEach(r=>{
    if(r && r.type!=="header" && typeof r.max==="undefined"){ r.max=0; }
  });
});
save();

function updateCategories(){
  const container=document.getElementById("categories");
  container.innerHTML="";
  Object.keys(data).forEach(name=>{
    const wrapper=document.createElement("div"); wrapper.className="category-item"; wrapper.style.display="flex"; wrapper.style.alignItems="center";
    const btn=document.createElement("button"); btn.className="category-button"; btn.textContent=name;
    if(name===activeCategory) btn.classList.add("active");
    btn.onclick=()=>{ activeCategory=name; showCategory(); updateCategories(); };
    const del=document.createElement("span"); del.className="delete-category"; del.textContent="🗑️";
    del.onclick=()=>{
      if(confirm(`Do you want to delete the category "${name}"?`)){
        delete data[name]; activeCategory=Object.keys(data)[0]||null; save(); updateCategories(); showCategory();
      }
    };
    wrapper.appendChild(btn); wrapper.appendChild(del); container.appendChild(wrapper);
  });
}

function addCategory(){
  const name=prompt("New category:");
  if(name && !data[name]){ data[name]=[]; activeCategory=name; save(); updateCategories(); showCategory(); }
}


// Palett (kan utvides)
const PRODUCT_COLORS = [
  "#36d131", "#ffd036", "#40e0d0", "#ffffff",
  "#ff6b6b", "#4da3ff", "#ffa94d", "#a78bfa",
  "#94a3b8", "#000000", "#f472b6", "#14b8a6",
  "#1f2937", "#84cc16", "#b45309", "#c0c0c0"
];

function luminance(hex){
  const c = hex.replace('#','');
  const r = parseInt(c.substr(0,2),16)/255, g = parseInt(c.substr(2,2),16)/255, b = parseInt(c.substr(4,2),16)/255;
  const a = [r,g,b].map(v => v <= .03928 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4));
  return 0.2126*a[0] + 0.7152*a[1] + 0.0722*a[2];
}
function bestTextColor(bg){
  if(!bg || bg.toLowerCase()==="#ffffff") return "#000";
  return luminance(bg) > 0.55 ? "#000" : "#fff";
}

function buildProductColorPicker(td, input, row){
  // wrapper rundt input + chip
  const wrap = document.createElement('span');
  wrap.className = 'product-color-wrap';

  // flytt input inn i wrap
  td.removeChild(input);
  wrap.appendChild(input);

  // chip (viser valgt farge, åpner popover)
  const chip = document.createElement('span');
  chip.className = 'color-chip';
  chip.title = 'Pick color';
  if(row.productColor){
    chip.style.background = row.productColor;
    input.style.backgroundColor = row.productColor;
    input.style.color = bestTextColor(row.productColor);
  }
  wrap.appendChild(chip);

  // popover
  const pop = document.createElement('div');
  pop.className = 'color-popover hidden';

  // “Clear”
  const clear = document.createElement('div');
  clear.className = 'color-option clear';
  clear.title = 'Clear';
  clear.onclick = (e)=>{ e.stopPropagation();
    row.productColor = null;
    input.style.backgroundColor = '';
    input.style.color = '';
    chip.style.background = '';
    save?.();
    pop.classList.add('hidden');
  };
  pop.appendChild(clear);

  // fargevalg
  PRODUCT_COLORS.forEach(col=>{
    const sw = document.createElement('div');
    sw.className = 'color-option';
    sw.style.background = col;
    sw.title = col;
    sw.onclick = (e)=>{ e.stopPropagation();
      row.productColor = col;
      input.style.backgroundColor = col;
      input.style.color = bestTextColor(col);
      chip.style.background = col;
      save?.();
      pop.classList.add('hidden');
    };
    pop.appendChild(sw);
  });

  wrap.appendChild(pop);
  td.appendChild(wrap);

  // toggle popover
  chip.addEventListener('click', (e)=>{
    e.stopPropagation();
    pop.classList.toggle('hidden');
  });

  // klikk utenfor => lukk
  document.addEventListener('click', ()=> pop.classList.add('hidden'));
}


function showCategory(){
  const content=document.getElementById("content");
  content.innerHTML="";
  if(!activeCategory || !data[activeCategory]) return;

  const table=document.createElement("table");
  table.innerHTML=`
    <thead>
      <tr>
        <th>Product/Type</th><th>Start Qty</th><th>Used</th><th>End Qty</th>
        <th>MIN🔔</th><th>MAX🔔</th><th>Comments</th><th>Order</th><th>Move</th><th>Delete</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody=table.querySelector("tbody");

  data[activeCategory].forEach((row,i)=>{
    const tr=document.createElement("tr");
    if(row.type==="header"){
      tr.className="header-row";
      const td=document.createElement("td"); td.colSpan=8;
      const span=document.createElement("span"); span.contentEditable=true; span.textContent=row.text||"Section / Header";
      span.oninput=()=>{ row.text=span.textContent; save(); };
      td.appendChild(span); tr.appendChild(td);
      const del=document.createElement("td"); del.style.textAlign="center";
      del.innerHTML=`<span class="delete-button" onclick="deleteRow(${i})" style="cursor:pointer;">🗑️</span>`;
      tr.appendChild(del); tbody.appendChild(tr); return;
    }

    row.product ??= ""; row.start ??= 0; row.used ??= 0; row.end ??= (parseFloat(row.start)||0)-(parseFloat(row.used)||0);
    row.min ??= 0; row.max ??= 0; row.comment ??= ""; row.order ??= 0;

    const fields=['product','start','used','end','min','max','comment','order'];
    const inputs={};

    fields.forEach((key)=>{
      const td=document.createElement("td");

      if(key==='product') td.classList.add("cell-product");
      else if(key==='comment') td.classList.add("cell-comment");
      else if(key==='min') td.classList.add("cell-min");
      else if(key==='max') td.classList.add("cell-max");
      else if(key==='order') td.classList.add("cell-order");
      else td.classList.add("cell-small");

      const input=document.createElement("input");
      input.type=(key==='product' || key==='comment') ? "text" : "number";
      input.value = row[key] ?? "";
      input.style.width="90%"; input.style.padding="4px"; input.style.borderRadius="5px";
      input.placeholder = key.charAt(0).toUpperCase() + key.slice(1);
      input.classList.add("large-bold-input");

      if(key==='end'){ input.readOnly=true; }

      input.oninput=()=>{
        row[key]=input.type==="number" ? input.value : input.value;
        const startVal=parseFloat(row.start)||0;
        const usedVal =parseFloat(row.used)||0;
        row.end = startVal - usedVal;
        inputs['end'].value = row.end;
        updateAlarms();
        save();
      };

      inputs[key]=input;
      td.appendChild(input);

    if (key === 'product') {
      buildProductColorPicker(td, input, row);
    }

      tr.appendChild(td);
    });

    function updateAlarms(){
      const startVal = parseFloat(inputs['start'].value);
      const usedVal  = parseFloat(inputs['used'].value);
      const endVal   = (isNaN(startVal)?0:startVal) - (isNaN(usedVal)?0:usedVal);
      inputs['end'].value = endVal;
      const minVal   = parseFloat(inputs['min'].value);
      const maxVal   = parseFloat(inputs['max'].value);

      if(!isNaN(endVal) && !isNaN(minVal) && endVal <= minVal){
        inputs['min'].classList.add("min-alarm");
      } else { inputs['min'].classList.remove("min-alarm"); }

      if(!isNaN(startVal) && !isNaN(maxVal) && startVal > maxVal){
        inputs['max'].classList.add("max-alarm");
      } else { inputs['max'].classList.remove("max-alarm"); }
    }
    updateAlarms();

    const tdMove=document.createElement("td"); tdMove.classList.add("cell-move");
    tdMove.innerHTML=`<button onclick="moveRow(${i},-1)">⬆️</button> <button onclick="moveRow(${i},1)">⬇️</button>`;
    const tdDel=document.createElement("td"); tdDel.innerHTML=`<span class="delete-button" onclick="deleteRow(${i})">🗑️</span>`;
    tr.appendChild(tdMove); tr.appendChild(tdDel);
    tbody.appendChild(tr);
  });

  content.appendChild(table);

  const addLine=document.createElement("button");
  addLine.className="add-line"; addLine.textContent="+ Add line";
  addLine.onclick=()=>{
    data[activeCategory].push({ type:"line", product:"", start:0, used:0, end:0, min:0, max:0, comment:"", order:0, productColor:null });
    save(); showCategory();
  };

  const addHeader=document.createElement("button");
  addHeader.className="add-line"; addHeader.textContent="+ Add header/section";
  addHeader.onclick=()=>{ data[activeCategory].push({type:"header", text:"New Header"}); save(); showCategory(); };

  content.appendChild(addLine); content.appendChild(addHeader);
  searchInPage();
}

function deleteRow(index){ data[activeCategory].splice(index,1); save(); showCategory(); }
function moveRow(index, direction){
  const list=data[activeCategory]; const newIndex=index+direction;
  if(newIndex<0 || newIndex>=list.length) return;
  const temp=list[index]; list[index]=list[newIndex]; list[newIndex]=temp;
  save(); showCategory();
}

function showGlobalOverview(){
  const content=document.getElementById("content");
  content.innerHTML="<h2>Global overview of the entire inventory</h2>";
  const table=document.createElement("table");
  table.innerHTML=`
    <thead>
      <tr><th>Category</th><th>Product</th><th>Start</th><th>Used</th><th>End</th><th>Min</th><th>Max</th><th>Comment</th><th>Order</th></tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody=table.querySelector("tbody");
  Object.entries(data).forEach(([category, rows])=>{
    rows.forEach(row=>{
      if(row.type==="header") return;
      const tr=document.createElement("tr");
      const start=parseFloat(row.start)||0;
      const used =parseFloat(row.used)||0;
      const end  = (typeof row.end!=="undefined") ? row.end : (start - used);
      const min  = parseFloat(row.min)||0;
      const max  = parseFloat(row.max)||0;

      const values=[category, row.product||"", start, used, end, min, max, row.comment||"", row.order||""];
      values.forEach((val,i)=>{
        const td=document.createElement("td"); td.textContent=val;
        if(i===4 && end <= min) td.classList.add("red-warning-min");
        if(i===6 && start > max) td.classList.add("red-warning-max");
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  });
  content.appendChild(table);
}

if(!data[activeCategory]){ data[activeCategory]=[]; save(); }

let isGlobalView=false;
function toggleGlobalView(){
  const button=document.getElementById("globalToggleButton");
  if(!isGlobalView){ showGlobalOverview(); button.textContent="🔙 Back to Table"; }
  else { showCategory(); button.textContent="📋 Global Overview"; }
  isGlobalView=!isGlobalView;
}

updateCategories();
showCategory();

async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF('p','mm','a4');
  const logoImg=new Image(); logoImg.src="images/Logo Seavo Nautiq.png";
  await new Promise(resolve=>{ logoImg.onload=resolve; });
  doc.addImage(logoImg,'PNG',10,10,60,35);
  const content=document.getElementById("content");
  await html2canvas(content,{backgroundColor:"#ffffff"}).then(canvas=>{
    const imgData=canvas.toDataURL('image/png');
    const imgProps=doc.getImageProperties(imgData);
    const pdfWidth=doc.internal.pageSize.getWidth()-20;
    const pdfHeight=(imgProps.height*pdfWidth)/imgProps.width;
    doc.addImage(imgData,'PNG',13,35,pdfWidth,pdfHeight);
    doc.save("SeavoNautiq_Inventory.pdf");
  });
}

/* ====== Calculator / Notepad logikk ====== */
function openCalculator(){ document.getElementById("calculatorModal").style.display = "block"; }
function closeCalculator(){ document.getElementById("calculatorModal").style.display = "none"; }
function openNotepad(){ document.getElementById("notepadModal").style.display = "block"; }
function closeNotepad(){ document.getElementById("notepadModal").style.display = "none"; }

/* Kalkulator-funksjoner */
function appendCalc(val){
  const d = document.getElementById('calc-display');
  d.value += val;
}
function deleteLast(){
  const d = document.getElementById('calc-display');
  d.value = d.value.slice(0,-1);
}
function clearCalc(){
  document.getElementById('calc-display').value = '';
}
function calculateResult(){
  const d = document.getElementById('calc-display');
  try{
    // erstatt × og ÷ hvis bruker har klikket knappene
    const expr = d.value.replace(/×/g,'*').replace(/÷/g,'/');
    // prosent: 50% => 0.5
    const expr2 = expr.replace(/(\d+(\.\d+)?)%/g, (_,n)=> String(parseFloat(n)/100));
    d.value = String(Function(`"use strict";return (${expr2})`)());
  }catch{
    d.value = 'Error';
  }
}

/* Notepad-funksjoner (lagres lokalt) */
function saveNote(){
  localStorage.setItem('seavo_note', document.getElementById('noteArea').value);
}
function clearNote(){
  document.getElementById('noteArea').value = '';
  localStorage.removeItem('seavo_note');
}

/* Drag-n-drop for modal-vinduer */
function makeDraggable(handleId, windowId){
  const handle = document.getElementById(handleId);
  const win = document.getElementById(windowId);
  if(!handle || !win) return;

  let offsetX=0, offsetY=0, dragging=false;

  handle.addEventListener('mousedown', (e)=>{
    dragging=true;
    const rect = win.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    document.body.style.userSelect='none';
  });

  window.addEventListener('mousemove', (e)=>{
    if(!dragging) return;
    win.style.left = (e.clientX - offsetX) + 'px';
    win.style.top  = (e.clientY - offsetY) + 'px';
  });

  window.addEventListener('mouseup', ()=>{
    dragging=false;
    document.body.style.userSelect='';
  });
}

/* Koble knapper og modal oppførsel */
document.addEventListener("DOMContentLoaded", () => {
  const openCalcBtn = document.getElementById("openCalculatorBtn");
  const openNoteBtn = document.getElementById("openNotepadBtn");
  const calcModal   = document.getElementById("calculatorModal");
  const noteModal   = document.getElementById("notepadModal");

  openCalcBtn?.addEventListener("click", openCalculator);
  openNoteBtn?.addEventListener("click", openNotepad);

  // Lukk ved klikk på bakgrunnen
  function backdropClose(e){
    if(e.target === calcModal) closeCalculator();
    if(e.target === noteModal) closeNotepad();
  }
  calcModal?.addEventListener("click", backdropClose);
  noteModal?.addEventListener("click", backdropClose);

  // ESC for å lukke
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){ closeCalculator(); closeNotepad(); }
  });

  // Last notat om det finnes
  const saved = localStorage.getItem('seavo_note');
  if(saved) document.getElementById('noteArea').value = saved;

  // Gjør vinduer flyttbare
  makeDraggable('calcDragHandle', 'calculatorWindow');
  makeDraggable('noteDragHandle', 'notepadWindow');
});
</script>
</html>