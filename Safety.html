<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Safety ‚Äì Seavo Nautiq</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Core (√©n gang, med defer) -->
  <script src="./js/seavo-core.js" defer></script>

  <style>
    :root{
      --bg:#0f2a4a; --text:#fff; --muted:#bcd3f1;
      --accent:#62b2e7; --accent-2:#1b75d1; --accent-3:#0e3e86;
      --warn:#ecc543; --danger:#f03747; --ok:#28e755;
    }
    *{box-sizing:border-box}
    body{background:var(--bg); color:var(--text); font-family:Arial,sans-serif; margin:0}

    .panel{
      background:rgba(0,0,0,.25); padding:16px; margin:20px auto; max-width:1400px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12); box-shadow:0 12px 28px rgba(0,0,0,.35);
    }
    h1{ text-align:center; margin:18px 0; color:#1eb6d1; text-shadow:0 1px 3px rgba(0,0,0,.6) }

    h2{ margin:6px 0 12px }

    /* Header-video */
    .video-header{ position:relative; aspect-ratio:1280/99; overflow:hidden; background:#000; }
    .video-header video{ width:100%; height:200%; object-fit:cover; display:block; }
    .gradient-overgang{ height:10px; background:linear-gradient(to left,#62b2e7,#001125); box-shadow:6px 4px 6px rgba(0,0,0,.7); }


    table{ width:100%; border-collapse:collapse; background:rgba(0,0,0,.20); color:var(--text);
           border:1px solid rgba(255,255,255,.12); border-radius:14px; overflow:hidden;
           box-shadow:0 12px 28px rgba(0,0,0,.35); }
    th,td{ border-bottom:1px solid rgba(255,255,255,.12); padding:8px; text-align:center; font-size:16px }
    th{ background:rgba(0,0,0,.28) }

    input[type="text"], input[type="number"], input[type="date"]{
      width:95%; padding:10px; border-radius:10px; background:rgba(0,0,0,.25); color:var(--text);
      border:1px solid rgba(255,255,255,.18); font-weight:700; font-size:14px; outline:none;
    }
    input:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(98,178,231,.18) }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 }
    .btn{
      padding:10px 16px; border:none; border-radius:12px; cursor:pointer; font-weight:700; font-size:14px;
      background:linear-gradient(to right,var(--accent-2),var(--accent-3)); color:#fff;
      border:1px solid rgba(255,255,255,.12); box-shadow:0 6px 16px rgba(0,0,0,.35);
    }
    .btn:hover{ filter:brightness(1.15) }
    .btn-del{ background:linear-gradient(to right,#f13e4e,#a31621) }
    .btn-pdf{ background:linear-gradient(to right,#6c757d,#495057) }

    .number-control{ display:flex; align-items:center; justify-content:center; gap:6px }
    .number-control button{ width:28px; height:28px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.08); color:#fff; cursor:pointer }
    .row-controls{ display:flex; gap:6px; justify-content:center }
    .row-controls button{ width:32px; height:32px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.08); color:#fff; cursor:pointer }

    /* Trafikklys for utl√∏p (Safety terskler: gul <=90, r√∏d <=45 dager) */
    .alert-green { background:linear-gradient(to right,#0000009f,#39e9a0b4) !important; color:#000; font-weight:bold }
    .alert-yellow{ background:linear-gradient(to right,#0000009d,#ffda47a6) !important; color:#000; font-weight:bold }
    .alert-red   { background:linear-gradient(to right,#0000009d,#d12e2ea9) !important; color:#000; font-weight:bold }

    /* Headerikon i Expiry Date */
    .alarm-icon{
      display:none;
      margin-left:6px;
      font-size:14px;
      vertical-align:middle;
    }
    .alarm-icon.blink{ animation:blink 1s infinite; }
    .alarm-icon.red   { color:#d12e2e; }
    .alarm-icon.yellow{ color:#ecc543; }

    @keyframes blink{ 50%{ opacity:.25 } }

    .header-row td{ background:rgba(255,255,255,.06); font-weight:800; letter-spacing:.3px }
    .section-title{ width:100%; font-weight:bold }
  </style>
</head>
<header class="video-header">
  <video autoplay muted loop playsinline disablePictureInPicture>
    <source src="Video/Ocean-Seavo-Nautiq.mp4" type="video/mp4">
  </video>
</header>

<div class="gradient-overgang"></div>
<body>

  <h1>Safety</h1>

  <div class="panel">
    <h2>Safety Inventory</h2>

    <table id="safetyTable">
      <thead>
        <tr>
          <th>Safety Equipment</th>
          <th>Number</th>
          <th>Date of Registration</th>
          <th>
            Expiry Date
            <span id="expiryHeaderIcon" class="alarm-icon" aria-hidden="true" title="Expiry alerts">üö®</span>
          </th>
          <th>Comments</th>
          <th>Order</th>
          <th>Move/Delete</th>
        </tr>
      </thead>
      <tbody><!-- fylles fra localStorage --></tbody>
    </table>

    <div class="controls">
      <button class="btn" id="btnAddRow">+ Add Line</button>
      <button class="btn" id="btnAddHeader">+ Add Header Section</button>
      <button class="btn btn-pdf" id="btnPdf">üñ®Ô∏è Export PDF (B/W)</button>
    </div>

    <p style="opacity:.8; margin:8px 2px 0">
      Notice‚ùó This list is not meant as guidance on routine checks or function tests.
      Please perform maintenance tasks per your maritime authority and radio provider.
    </p>
  </div>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
  /* =========================
     LOCAL STORAGE + CORE SYNC
     ========================= */
  const LS_KEY = 'sn.safety.v1';
  const YELLOW_DAYS = 90;
  const RED_DAYS = 45;

  function loadState(){
    try { return JSON.parse(localStorage.getItem(LS_KEY)) || { rows: [] }; }
    catch { return { rows: [] }; }
  }
  function saveState(state){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function serialize(){
    const rows = Array.from(document.querySelectorAll('#safetyTable tbody tr')).map(tr=>{
      if(tr.classList.contains('header-row')){
        return { type:'header', id: tr.dataset.rowId, text: tr.querySelector('.section-title')?.value || '' };
      }
      return {
        type:'row',
        id: tr.dataset.rowId,
        equipment: tr.querySelector('.product-name')?.value || '',
        number: tr.querySelector('.number-input')?.value || '0',
        registered: tr.querySelector('.registered-input')?.value || '',
        expiry: tr.querySelector('.expiry-input')?.value || '',
        comments: tr.querySelector('.comment-input')?.value || '',
        order: tr.querySelector('.order-input')?.value || '0'
      };
    });
    return { rows };
  }

  function persistAndSync(){
    saveState(serialize());
    scanAndSyncSafety();
    updateExpiryHeaderIcon();
  }

  /* ==============
     Header-ikon logikk
     ============== */
 function updateExpiryHeaderIcon(){
  const icon = document.getElementById('expiryHeaderIcon');
  if(!icon) return;

  const inputs = document.querySelectorAll('.expiry-input');
  let hasRed = false, hasYellow = false;

  inputs.forEach(el=>{
    if(el.classList.contains('alert-red')) hasRed = true;
    else if(el.classList.contains('alert-yellow')) hasYellow = true;
  });

  // reset
  icon.className = 'alarm-icon';
  icon.style.display = 'none';
  icon.removeAttribute('title');

  if(hasRed){
    icon.style.display = 'inline';
    icon.classList.add('red','blink');   // <- blink KUN ved r√∏dt
    icon.title = 'One or more items expired / ‚â§45 days';
  } else if(hasYellow){
    icon.style.display = 'inline';
    icon.classList.add('yellow');        // <- ingen blink ved gult
    icon.title = 'Items expiring within 90 days';
  }
}

  /* ====================
     UI: Row constructors
     ==================== */
  function createHeaderRow(data = {}){
    const tr = document.createElement('tr');
    tr.className = 'header-row';
    tr.dataset.rowId = data.id || crypto.randomUUID();

    const titleTd = document.createElement('td');
    titleTd.colSpan = 6;
    const input = document.createElement('input');
    input.type = 'text'; input.className = 'section-title';
    input.placeholder = 'Section Title'; input.value = data.text || '';
    titleTd.appendChild(input);

    const delTd = document.createElement('td');
    const delBtn = document.createElement('button');
    delBtn.textContent = 'üóëÔ∏è';
    delBtn.className = 'btn-del';
    delBtn.addEventListener('click', ()=>{
      tr.remove();
      seavo.logActivity({ text:`Deleted section "${input.value || 'Untitled'}"`, source:'Safety', type:'action' });
      persistAndSync();
    });
    delTd.appendChild(delBtn);

    input.addEventListener('input', persistAndSync);

    tr.append(titleTd, delTd);
    return tr;
  }

  function createDataRow(data = {}){
    const tr = document.createElement('tr');
    tr.dataset.rowId = data.id || crypto.randomUUID();

    // Equipment
    const t0 = document.createElement('td');
    const name = document.createElement('input');
    name.type = 'text'; name.placeholder = 'Safety Equipment'; name.className = 'product-name';
    name.value = data.equipment || '';
    t0.appendChild(name);

    // Number
    const t1 = document.createElement('td');
    const numWrap = document.createElement('div');
    numWrap.className = 'number-control';
    const btnMinus = document.createElement('button'); btnMinus.textContent = '‚àí';
    const num = document.createElement('input'); num.type='number'; num.className='number-input'; num.value = data.number ?? 0; num.style.width='60px';
    const btnPlus  = document.createElement('button'); btnPlus.textContent = '+';
    numWrap.append(btnMinus, num, btnPlus);
    t1.appendChild(numWrap);

    // Registration date
    const t2 = document.createElement('td');
    const reg = document.createElement('input');
    reg.type='date'; reg.className='registered-input'; reg.value = data.registered || '';
    t2.appendChild(reg);

    // Expiry (uten per-rad ikon)
    const t3 = document.createElement('td');
    const exp = document.createElement('input');
    exp.type='date'; exp.className='expiry-input'; exp.value = data.expiry || '';
    t3.appendChild(exp);

    // Comments
    const t4 = document.createElement('td');
    const com = document.createElement('input');
    com.type='text'; com.className='comment-input'; com.placeholder='Optional comments'; com.value = data.comments || '';
    t4.appendChild(com);

    // Order
    const t5 = document.createElement('td');
    const orderWrap = document.createElement('div');
    orderWrap.className='number-control';
    const minusO = document.createElement('button'); minusO.textContent='‚àí';
    const order = document.createElement('input'); order.type='number'; order.className='order-input'; order.value = data.order ?? 0; order.style.width='60px';
    const plusO = document.createElement('button'); plusO.textContent='+';
    orderWrap.append(minusO, order, plusO);
    t5.appendChild(orderWrap);

    // Move/Delete
    const t6 = document.createElement('td');
    const ctr = document.createElement('div'); ctr.className='row-controls';
    const up = document.createElement('button'); up.textContent='‚¨ÜÔ∏è';
    const down = document.createElement('button'); down.textContent='‚¨áÔ∏è';
    const del = document.createElement('button'); del.textContent='üóëÔ∏è';
    ctr.append(up, down, del); t6.appendChild(ctr);

    // --- Helpers for this row ---
    function checkExpiry(){
      const cls = ['alert-green','alert-yellow','alert-red'];
      cls.forEach(c=>exp.classList.remove(c));
      if(!exp.value){ updateExpiryHeaderIcon(); return; }

      const today = new Date(); today.setHours(0,0,0,0);
      const d = new Date(exp.value); d.setHours(0,0,0,0);
      const diff = Math.floor((d - today)/86400000);

      if(diff <= RED_DAYS)         exp.classList.add('alert-red');
      else if(diff <= YELLOW_DAYS) exp.classList.add('alert-yellow');
      else                         exp.classList.add('alert-green');

      updateExpiryHeaderIcon();
    }

    // number controls
    btnMinus.addEventListener('click', ()=>{ num.value = Math.max(0, (parseInt(num.value)||0)-1); persistAndSync(); });
    btnPlus .addEventListener('click', ()=>{ num.value = (parseInt(num.value)||0)+1; persistAndSync(); });
    minusO  .addEventListener('click', ()=>{ order.value = Math.max(0, (parseInt(order.value)||0)-1); persistAndSync(); });
    plusO   .addEventListener('click', ()=>{ order.value = (parseInt(order.value)||0)+1; persistAndSync(); });

    // edits
    name .addEventListener('input', persistAndSync);
    num  .addEventListener('input', persistAndSync);
    reg  .addEventListener('input', persistAndSync);
    com  .addEventListener('input', persistAndSync);
    order.addEventListener('input', persistAndSync);

    exp.addEventListener('input', ()=>{
      checkExpiry();
      seavo.logActivity({
        text:`Updated expiry for "${name.value?.trim()||'[Unnamed]'}" to ${exp.value}`,
        source:'Safety', type:'action'
      });
      persistAndSync();
    });

    // move up/down
    up.addEventListener('click', ()=>{
      const prev = tr.previousElementSibling;
      if(prev && prev.tagName==='TR'){ prev.before(tr); persistAndSync(); }
    });
    down.addEventListener('click', ()=>{
      const next = tr.nextElementSibling;
      if(next){ next.after(tr); persistAndSync(); }
    });

    // delete
    del.addEventListener('click', ()=>{
      const nm = name.value?.trim() || '[Unnamed]';
      tr.remove();
      seavo.logActivity({ text:`Deleted "${nm}" from Safety`, source:'Safety', type:'action' });
      persistAndSync();
    });

    // initial colors
    checkExpiry();

    tr.append(t0,t1,t2,t3,t4,t5,t6);
    return tr;
  }

  /* ==============
     Render + Sync
     ============== */
  function render(state){
    const tbody = document.querySelector('#safetyTable tbody');
    tbody.innerHTML = '';
    (state.rows || []).forEach(r=>{
      tbody.appendChild( r.type==='header' ? createHeaderRow(r) : createDataRow(r) );
    });
    scanAndSyncSafety(); // snapshot til Index
    updateExpiryHeaderIcon();
  }

  function addRow(data = {}){ 
    const tbody = document.querySelector('#safetyTable tbody');
    tbody.appendChild(createDataRow(data));
    seavo.logActivity({ text:'Added new safety line', source:'Safety', type:'action' });
    persistAndSync();
  }

  function addHeader(text=''){
    const tbody = document.querySelector('#safetyTable tbody');
    tbody.appendChild(createHeaderRow({ text }));
    seavo.logActivity({ text:`Added new section "${text||'Untitled'}"`, source:'Safety', type:'action' });
    persistAndSync();
  }

  /* -------- Core bridge -------- */
  function scanAndSyncSafety(){
    const rows = Array.from(document.querySelectorAll('#safetyTable tbody tr'))
                      .filter(tr=>!tr.classList.contains('header-row'));
    const items = rows.map(tr=>{
      const id = tr.dataset.rowId || crypto.randomUUID();
      tr.dataset.rowId = id;
      const name = tr.querySelector('.product-name')?.value?.trim() || '';
      const expiryISO = tr.querySelector('.expiry-input')?.value || '';
      return { id, name, expiryISO };
    });
    seavo.syncInventory('safety', items);
  }

  /* ==============
     PDF (B/W)
     ============== */
  async function exportPDF_BW(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    doc.setFont('helvetica','bold'); doc.setFontSize(16);
    doc.text('Seavo Nautiq ‚Äî Safety Inventory (B/W)', 40, 40);

    const state = serialize();
    const body = [];
    state.rows.forEach(item=>{
      if(item.type==='header'){
        body.push([`--- ${item.text || 'Section'} ---`, '', '', '', '', '']);
      }else{
        body.push([
          item.equipment || '',
          item.number || '0',
          item.registered || '',
          item.expiry || '',
          item.comments || '',
          item.order || '0'
        ]);
      }
    });

    doc.autoTable({
      startY: 60,
      head: [['Safety Equipment','Number','Registration','Expiry','Comments','Order']],
      body,
      styles: { font:'helvetica', textColor:[0,0,0], lineColor:[0,0,0], lineWidth:0.5, fillColor:false },
      headStyles: { fillColor:false, textColor:[0,0,0], fontStyle:'bold' },
      alternateRowStyles: { fillColor:false },
      didParseCell: ctx=>{
        if(ctx.section==='body' && typeof ctx.cell.raw==='string' && ctx.cell.raw.startsWith('--- ')){
          ctx.cell.styles.fontStyle='italic';
        }
      }
    });

    doc.save('Safety_Inventory_BW.pdf');
  }

  /* ==============
     Init
     ============== */
  document.addEventListener('DOMContentLoaded', ()=>{
    const state = loadState();
    if(!state.rows || state.rows.length===0){
      // Start med √©n blank linje
      addRow({});
    }else{
      render(state);
    }

    // knapper
    document.getElementById('btnAddRow').addEventListener('click', ()=>addRow({}));
    document.getElementById('btnAddHeader').addEventListener('click', ()=>addHeader(''));
    document.getElementById('btnPdf').addEventListener('click', exportPDF_BW);

    // sikkerhetsnett: oppdater headerikon p√• f√∏rste last
    updateExpiryHeaderIcon();
  });
  </script>
</body>
</html>