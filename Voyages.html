<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Voyages</title>
  <style>
    :root {
      --bg: #12315c; --panel: rgba(0,0,0,.15); --panel-2: rgba(255,255,255,.08);
      --text: #fff; --muted: #bcd3f1; --accent: #62b2e7; --danger: #f03747; --ok: #28e755;
    }
    * { box-sizing: border-box; }
    body { background-color: var(--bg); color: var(--text); font-family: Arial, sans-serif; margin: 0; }

    .video-header { position: relative; aspect-ratio: 1280 / 99; overflow: hidden; background:#000; }
    .video-header video { width: 100%; height: 200%; object-fit: cover; display: block; }

    .gradient-overgang {
      height: 10px;
      background: linear-gradient(to left, #62b2e7, #001125);
      box-shadow: 6px 4px 6px rgba(0,0,0,.7);
    }

    .container { padding: 20px 24px 60px; max-width: 1200px; margin: 0 auto; }
    h1,h2,h3 { margin: 10px 0 16px; letter-spacing: .2px; text-shadow: 0 1px 2px rgba(0,0,0,.35); }
    .hint { color: var(--muted); font-size: .95rem; }

    table {
      width: 100%; border-collapse: collapse; background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.15); border-radius:10px; overflow:hidden;
    }
    thead th { background:#212224; color:#fff; text-align:left; padding:10px 12px; font-weight:bold; }
    tbody td { border-top:1px solid rgba(255,255,255,.15); padding:10px 12px; background: rgba(0,0,0,.1); }
    tbody tr:nth-child(even) td { background: rgba(255,255,255,.06); }
    .row-actions { display:flex; gap:8px; }
    .selected-row { outline:2px solid var(--accent); outline-offset:-2px; }

    .panel {
      background: var(--panel); border:1px solid var(--panel-2); border-radius:12px;
      padding:14px; margin:18px 0 28px;
      box-shadow: 0 6px 18px rgba(0,0,0,.18) inset, 0 4px 22px rgba(0,0,0,.18);
    }
    label { font-weight:bold; }
    .grid { display:grid; gap:12px; }
    .grid-3 { grid-template-columns: 1.4fr 1fr 1fr; }
    @media (max-width: 900px) { .grid-3 { grid-template-columns: 1fr; } }

    input[type="text"], input[type="date"], input[type="email"], input[type="tel"], select, input[list] {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25); color: #fff; outline: none;
    }
    input::placeholder { color: rgba(255,255,255,.7); }

    .btn {
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:none; border-radius:8px;
      cursor:pointer; font-weight:600; color:#fff; background:linear-gradient(90deg,#007bff,#0056b3);
      box-shadow:0 2px 8px rgba(0,0,0,.35);
    }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .btn-secondary { background: linear-gradient(90deg, #6c757d, #495057); }
    .btn-danger { background: linear-gradient(90deg, #f14b53, #b82127); }
    .btn-ok { background: linear-gradient(90deg, #28e755, #0f9d2a); color:#001; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:.85rem; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.2); }
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    .muted { color: var(--muted); }

    /* Uploads */
    .dropzone { border:2px dashed rgba(255,255,255,.25); border-radius:12px; padding:16px; text-align:center; background:rgba(0,0,0,.15); transition:border-color .2s, background .2s; }
    .dropzone.dragover { background: rgba(59,161,255,.08); border-color: var(--accent); }
    .dropzone input[type=file] { display:none; }
    .uploads { margin-top:12px; display:grid; gap:12px; }
    .upload-card { display:grid; grid-template-columns:56px 1fr auto; align-items:center; gap:12px; padding:10px; border:1px solid rgba(255,255,255,.15); border-radius:12px; background:rgba(0,0,0,.15); }
    .thumb { width:56px; height:56px; border-radius:10px; background:#0b1423; display:grid; place-items:center; overflow:hidden; }
    .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    .file-meta { font-size:.92rem; color: var(--muted); }
    .upload-actions { display:flex; gap:8px; }
    a.file-link { color:#fff; text-decoration:underline; }

    /* Inline import popup (under Crew-seksjonen) */
    .inline-import {
      display:none; margin-top:12px; border:1px solid rgba(255,255,255,.2); border-radius:12px;
      background:#0f274a; box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    .inline-import-header {
      display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.15);
    }
    .inline-import-title { font-weight:700; }
    .inline-import-body { padding:12px; }
    .inline-import .search-row { display:grid; grid-template-columns:1fr auto; gap:10px; margin-bottom:10px; }
    .inline-import table { margin:0; }
    .inline-import .small-hint { color: var(--muted); font-size:.9rem; margin-left:6px; }
    .close-x { cursor:pointer; font-size:20px; padding:6px 10px; border-radius:8px; background:rgba(255,255,255,.1); }
    .minw-110 { min-width:110px; }
    .scroll-area { max-height: 320px; overflow:auto; border-radius:10px; }
  </style>
</head>
<body>
  <header class="video-header">
    <video autoplay muted loop playsinline>
      <source src="Video/Ocean-Seavo-Nautiq.mp4" type="video/mp4">
    </video>
  </header>
  <div class="gradient-overgang"></div>

  <div class="container">
    <h1>Voyages</h1>
    <p class="hint">Create a voyage, select it in the main table, add crew, and upload relevant documents. Export PDF or send the active voyage to Fleet.</p>

    <!-- Add Voyage -->
    <div class="panel">
      <h2>New Voyage</h2>
      <div class="grid grid-3">
        <div>
          <label for="voyageName">Voyage Name</label>
          <input type="text" id="voyageName" placeholder="e.g. Winter Cod Run 2025">
        </div>
        <div>
          <label for="startDate">Start Date</label>
          <input type="date" id="startDate">
        </div>
        <div>
          <label for="endDate">Estimated End Date</label>
          <input type="date" id="endDate">
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" onclick="addVoyage()">Add Voyage</button>
        <button class="btn btn-ok" id="exportPdfBtn" onclick="generateVoyagePDF()" disabled>Export PDF (Selected)</button>
        <button class="btn btn-secondary" id="sendToFleetBtn" onclick="sendSelectedToFleet()" disabled>Send to Fleet</button>
        <span class="hint">Click a row below to select the active voyage.</span>
      </div>
    </div>

    <!-- Voyages Table -->
    <div class="panel">
      <h2>Voyage List</h2>
      <table id="voyageTable" aria-label="Voyage table">
        <thead>
          <tr>
            <th style="width:44px;">Sel</th>
            <th>Voyage Name</th>
            <th>Start Date</th>
            <th>Estimated End Date</th>
            <th style="width:180px;">Actions</th>
          </tr>
        </thead>
        <tbody id="voyageBody"></tbody>
      </table>
      <div style="margin-top:10px;" class="hint">
        <span>Active voyage: </span>
        <strong id="activeVoyageName" class="badge">not selected</strong>
      </div>
    </div>

    <!-- Crew Section -->
    <div class="panel" id="crewPanel">
      <h2>Crew for Selected Voyage</h2>
      <p class="hint" id="crewHint">Select a voyage above to activate the crew list.</p>

      <div class="toolbar">
        <button class="btn btn-secondary" id="openImportBtn" onclick="openImportPicker()" disabled>Add from Participants</button>
        <span class="hint">Import from participants list</span>
      </div>

      <!-- INLINE IMPORT POPUP (under crew) -->
      <div id="importInline" class="inline-import" aria-hidden="true">
        <div class="inline-import-header">
          <div class="inline-import-title">Add from Participants
            <span class="small-hint">Select and press ‚ÄúAdd Selected‚Äù</span>
          </div>
          <div>
            <button class="btn btn-ok minw-110" id="importConfirmBtn" onclick="importSelected()" disabled>Add Selected</button>
            <span class="close-x" onclick="closeImportPicker()">√ó</span>
          </div>
        </div>
        <div class="inline-import-body">
          <div class="search-row">
            <input type="text" id="participantSearch" placeholder="Search name, nationality, position, phone, email‚Ä¶" oninput="renderParticipantsList()">
            <button class="btn" onclick="toggleAllParticipants()">Toggle All</button>
          </div>
          <div class="scroll-area">
            <table>
              <thead>
                <tr>
                  <th style="width:50px;">Sel</th>
                  <th>Full name</th>
                  <th>Nationality</th>
                  <th>Id/Pn</th>
                  <th>Phone</th>
                  <th>Email</th>
                  <th>Job position</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="participantsList"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Crew table -->
      <div style="margin-top:16px;">
        <table aria-label="Crew table">
          <thead>
            <tr>
              <th>Full name</th><th>Nationality</th><th>Id/Pn</th><th>Phone</th><th>Email</th><th>Job position</th>
              <th style="width:110px;">Actions</th>
            </tr>
          </thead>
          <tbody id="crewBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="panel">
      <h2>Upload documents</h2>
      <p class="hint" id="uploadHint">Select a voyage above to enable uploading.</p>

      <label class="dropzone" id="dropzone">
        <input id="fileInput" type="file" multiple
               accept=".pdf,.xlsx,.xls,.csv,.txt,.jpg,.jpeg,.png,.webp,.doc,.docx,.ods,.odt" />
        <div>
          <strong>Drag and drop</strong> files here or <span class="badge">click to select</span><br>
          <span class="hint">PDF/Excel/CSV/Images etc. will be saved to the selected Voyage.</span>
        </div>
      </label>
      <div class="uploads" id="uploadList"></div>
    </div>
  </div>

  <!-- jsPDF + AutoTable (PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
    // ------- Storage keys -------
    const VKEY = 'voyages_v1';
    const PKEY = 'participants_v1';
    const EXPORTKEY = 'fleet_add_voyage'; // Fleet lytter p√• denne

    // ------- State -------
    let voyages = loadVoyages();
    let activeVoyageId = voyages[0]?.id || null;
    let importSelection = new Set();

    // ------- Utils -------
    const $ = (id) => document.getElementById(id);
    const uid = () => Math.random().toString(36).slice(2, 10);
    const fmtDate = (d) => d || '';
    const kb = (b) => (b/1024).toFixed(1) + ' KB';
    const escapeHtml = (s='') => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;')
      .replaceAll("'", "&#039;");
    function loadParticipants() {
      try {
        const arr = JSON.parse(localStorage.getItem(PKEY)) || [];
        return arr.map(p => ({ id: p.id || p.uid || uid(), ...p }));
      } catch { return []; }
    }

    // ------- Storage -------
    function saveVoyages() {
      localStorage.setItem(VKEY, JSON.stringify({ voyages, activeVoyageId }));
    }
    function loadVoyages() {
      const raw = localStorage.getItem(VKEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        activeVoyageId = parsed.activeVoyageId || null;
        return Array.isArray(parsed.voyages) ? parsed.voyages : [];
      } catch { return []; }
    }

    // ------- Active voyage helpers -------
    function getActiveVoyage() { return voyages.find(v => v.id === activeVoyageId) || null; }
    function setActiveVoyage(id) {
      activeVoyageId = id;
      saveVoyages();
      renderVoyages(); renderCrew(); renderUploads(); updateSectionEnabled();
    }
    function updateSectionEnabled() {
      const hasActive = !!getActiveVoyage();
      $('activeVoyageName').textContent = hasActive ? getActiveVoyage().name : 'Ingen valgt';
      $('openImportBtn').disabled = !hasActive;
      $('exportPdfBtn').disabled = !hasActive;
      $('sendToFleetBtn').disabled = !hasActive;
      $('crewHint').textContent = hasActive ? 'Legg til mannskap for valgt tokt.' : 'Velg et tokt i tabellen over for √• aktivere mannskapslisten.';
      $('uploadHint').textContent = hasActive ? 'Last opp dokumenter for valgt tokt.' : 'Velg et tokt i tabellen over for √• aktivere opplasting.';
      $('dropzone').style.pointerEvents = hasActive ? 'auto' : 'none';
      $('dropzone').style.opacity = hasActive ? '1' : '.55';
    }

    // ------- Voyages CRUD -------
    function addVoyage() {
      const name = $('voyageName').value.trim();
      const start = $('startDate').value;
      const end = $('endDate').value;
      if (!name) { alert('Please enter Voyage Name'); return; }
      if (start && end && start > end) { alert('Start Date can‚Äôt be after End Date'); return; }
      const v = { id: uid(), name, start, end, crew: [], files: [] };
      voyages.push(v);
      activeVoyageId = v.id;
      saveVoyages();
      $('voyageName').value=''; $('startDate').value=''; $('endDate').value='';
      renderVoyages(); renderCrew(); renderUploads(); updateSectionEnabled();
    }
    function deleteVoyage(id) {
      if (!confirm('Delete this voyage and all associated crew/files?')) return;
      voyages = voyages.filter(v => v.id !== id);
      if (activeVoyageId === id) activeVoyageId = voyages[0]?.id || null;
      saveVoyages(); renderVoyages(); renderCrew(); renderUploads(); updateSectionEnabled();
    }
    function renderVoyages() {
      const body = $('voyageBody'); body.innerHTML = '';
      voyages.forEach(v => {
        const tr = document.createElement('tr');
        if (v.id === activeVoyageId) tr.classList.add('selected-row');
        tr.innerHTML = `
          <td><input type="radio" name="selVoy" ${v.id===activeVoyageId ? 'checked' : ''} /></td>
          <td>${escapeHtml(v.name)}</td>
          <td>${fmtDate(v.start)}</td>
          <td>${fmtDate(v.end)}</td>
          <td class="row-actions">
            <button class="btn btn-secondary" onclick="setActiveVoyage('${v.id}')">Select</button>
            <button class="btn btn-danger" onclick="deleteVoyage('${v.id}')">Delete</button>
          </td>
        `;
        tr.addEventListener('click', (e) => {
          if (e.target.tagName.toLowerCase() === 'button') return;
          setActiveVoyage(v.id);
        });
        body.appendChild(tr);
      });
      $('activeVoyageName').textContent = getActiveVoyage()?.name || 'Ingen valgt';
    }

    // ------- Crew (import only) -------
    function deleteCrew(id) {
      const v = getActiveVoyage(); if (!v) return;
      v.crew = v.crew.filter(c => c.id !== id);
      saveVoyages(); renderCrew();
    }
    function renderCrew() {
      const v = getActiveVoyage();
      const body = $('crewBody'); body.innerHTML = '';
      if (!v) return;
      v.crew.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(c.name)}</td>
          <td>${escapeHtml(c.nationality || '')}</td>
          <td>${escapeHtml(c.personId || '')}</td>
          <td>${escapeHtml(c.phone || '')}</td>
          <td>${escapeHtml(c.email || '')}</td>
          <td>${escapeHtml(c.position || '')}</td>
          <td><button class="btn btn-danger" onclick="deleteCrew('${c.id}')">Delete</button></td>
        `;
        body.appendChild(tr);
      });
    }

    // ------- Uploads (persistent DataURL) -------
    const dropzone = $('dropzone'); const fileInput = $('fileInput');

    function isPreviewableType(mime='') {
      return mime.startsWith('image/') || mime === 'application/pdf' || mime.startsWith('text/');
    }

    function addFilesToVoyage(fileList) {
      const v = getActiveVoyage(); if (!v) return alert('No voyage selected');
      const files = Array.from(fileList || []); if (!files.length) return;
      let pending = files.length;
      files.forEach(f => {
        const reader = new FileReader();
        reader.onload = () => {
          v.files.push({
            id: uid(), name: f.name, size: f.size, type: f.type,
            dataUrl: reader.result, previewable: isPreviewableType(f.type)
          });
          if (--pending === 0) { saveVoyages(); renderUploads(); }
        };
        reader.onerror = () => { if (--pending === 0) { saveVoyages(); renderUploads(); } };
        reader.readAsDataURL(f);
      });
    }
    function deleteFile(fileId) {
      const v = getActiveVoyage(); if (!v) return;
      v.files = v.files.filter(f => f.id !== fileId);
      saveVoyages(); renderUploads();
    }
    function renderUploads() {
      const v = getActiveVoyage(); const list = $('uploadList'); list.innerHTML = '';
      if (!v) return;
      v.files.forEach(f => {
        const card = document.createElement('div'); card.className = 'upload-card';
        const thumb = document.createElement('div'); thumb.className = 'thumb';
        if ((f.type||'').startsWith('image/')) {
          const img = document.createElement('img'); img.src = f.dataUrl; img.alt = f.name; thumb.appendChild(img);
        } else { thumb.innerHTML = 'üìÑ'; thumb.style.fontSize = '28px'; }
        const meta = document.createElement('div');
        meta.innerHTML = `<div><strong>${escapeHtml(f.name)}</strong></div>
                          <div class="file-meta">${kb(f.size)} ‚Ä¢ ${escapeHtml(f.type || 'file')}</div>`;
        const actions = document.createElement('div'); actions.className = 'upload-actions';
        if (f.previewable) {
          const aPreview = document.createElement('a'); aPreview.href = f.dataUrl; aPreview.target = '_blank'; aPreview.rel = 'noopener';
          aPreview.className = 'file-link'; aPreview.textContent = 'Open'; actions.appendChild(aPreview);
        }
        const aDownload = document.createElement('a'); aDownload.href = f.dataUrl; aDownload.download = f.name;
        aDownload.className = 'file-link'; aDownload.textContent = 'Download';
        const del = document.createElement('button'); del.className = 'btn btn-danger'; del.textContent = 'Remove';
        del.onclick = () => deleteFile(f.id);
        actions.append(aDownload, del);
        card.append(thumb, meta, actions);
        list.appendChild(card);
      });
    }
    ['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, (e) => {
      if (!getActiveVoyage()) return; e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover');
    }));
    ['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, (e) => {
      if (!getActiveVoyage()) return; e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover');
    }));
    dropzone.addEventListener('drop', (e) => { if (!getActiveVoyage()) return; addFilesToVoyage(e.dataTransfer.files); });
    dropzone.addEventListener('click', () => { if (!getActiveVoyage()) return; fileInput.click(); });
    fileInput.addEventListener('change', (e) => addFilesToVoyage(e.target.files));

    // ------- Inline Import from Participants -------
    function openImportPicker() {
      importSelection = new Set();
      $('participantSearch').value = '';
      renderParticipantsList();
      const box = $('importInline');
      box.style.display = 'block';
      box.setAttribute('aria-hidden', 'false');
      updateImportButtonState();
      // Scroll into view hvis n√∏dvendig
      box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    function closeImportPicker() {
      const box = $('importInline');
      box.style.display = 'none';
      box.setAttribute('aria-hidden', 'true');
    }

    function getFilteredParticipants() {
      const q = $('participantSearch').value.trim().toLowerCase();
      const all = loadParticipants();
      if (!q) return all;
      return all.filter(p => [p.name, p.nationality, p.position, p.phone, p.email]
        .some(f => (f||'').toLowerCase().includes(q)));
    }

    function renderParticipantsList() {
      const list = $('participantsList'); list.innerHTML = '';
      const arr = getFilteredParticipants();
      if (!arr.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="8" class="muted">No participants found</td>`;
        list.appendChild(tr);
        return;
      }
      arr.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" ${importSelection.has(p.id) ? 'checked' : ''} onchange="toggleOne('${p.id}', this.checked)"></td>
          <td>${escapeHtml(p.name)}</td>
          <td>${escapeHtml(p.nationality||'')}</td>
          <td>${escapeHtml(p.personId||'')}</td>
          <td>${escapeHtml(p.phone||'')}</td>
          <td>${escapeHtml(p.email||'')}</td>
          <td>${escapeHtml(p.position||'')}</td>
          <td>${statusBadge(p.status)}</td>
        `;
        list.appendChild(tr);
      });
    }

    function statusBadge(s) {
      return s === 'valid' ? '‚úÖ Valid'
           : s === 'soon' ? '‚ö†Ô∏è Soon'
           : s === 'expired' ? '‚ùå Expired'
           : (s||'‚Äî');
    }

    function toggleOne(id, checked) {
      if (checked) importSelection.add(id);
      else importSelection.delete(id);
      updateImportButtonState();
    }

    function toggleAllParticipants() {
      const arr = getFilteredParticipants();
      const allSelected = arr.every(p => importSelection.has(p.id));
      if (allSelected) arr.forEach(p => importSelection.delete(p.id));
      else arr.forEach(p => importSelection.add(p.id));
      renderParticipantsList();
      updateImportButtonState();
    }

    function updateImportButtonState() {
      $('importConfirmBtn').disabled = importSelection.size === 0;
    }

    function importSelected() {
      const v = getActiveVoyage();
      if (!v) { alert('No voyage selected'); return; }
      if (importSelection.size === 0) return;

      const source = loadParticipants().filter(p => importSelection.has(p.id));
      const key = x => (x.name||'') + '|' + (x.email||''); // enkel dedupe
      const existingKeys = new Set((v.crew||[]).map(key));
      const toAdd = source.filter(p => !existingKeys.has(key(p)));

      toAdd.forEach(p => {
        v.crew.push({
          id: uid(),
          name: p.name,
          nationality: p.nationality,
          personId: p.personId,
          phone: p.phone,
          email: p.email,
          position: p.position
        });
      });

      saveVoyages(); renderCrew(); closeImportPicker();
      if (toAdd.length === 0) alert('Ingen nye √• legge til (mulige duplikater ble filtrert).');
    }

    // ------- Export to Fleet (DIRECT) -------
    function sendSelectedToFleet() {
      const v = getActiveVoyage();
      if (!v) { alert('Select a voyage first.'); return; }

      const safeFiles = (v.files || []).map(f => ({
        id: f.id, name: f.name, type: f.type, size: f.size,
        dataUrl: f.dataUrl, previewable: !!f.previewable
      }));

      const payload = {
        id: v.id, name: v.name, start: v.start, end: v.end,
        crew: v.crew || [], files: safeFiles,
        exportedAt: new Date().toISOString()
        // vesselName kan legges til her n√•r fart√∏yregistrering er p√• plass
      };

      localStorage.setItem(EXPORTKEY, JSON.stringify(payload));
      alert('Voyage sent to Fleet.');
    }

    // ------- PDF Export -------
    async function generateVoyagePDF() {
      const v = getActiveVoyage();
      if (!v) { alert('No voyage selected'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4', compress: true });
      const left = 40; let y = 52;

      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text('Seavo Nautiq ‚Äî Voyage Report', left, y); y += 10;

      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text(`Generated: ${new Date().toLocaleString()}`, left, y); y += 20;

      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('Voyage', left, y); y += 10;

      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      [['Name', v.name||'‚Äî'],['Start Date', v.start||'‚Äî'],['End Date', v.end||'‚Äî']]
        .forEach(row => { doc.text(`${row[0]}: ${row[1]}`, left, y); y += 16; });
      y += 8;

      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('Crew', left, y); y += 6;

      doc.autoTable({
        startY: y + 6,
        head: [['Full name','Nationality','Id/Pn','Phone','Email','Position']],
        body: (v.crew && v.crew.length ? v.crew : [{name:'‚Äî',nationality:'‚Äî',personId:'‚Äî',phone:'‚Äî',email:'‚Äî',position:'‚Äî'}]).map(c => [
          c.name||'‚Äî', c.nationality||'‚Äî', c.personId||'‚Äî', c.phone||'‚Äî', c.email||'‚Äî', c.position||'‚Äî'
        ]),
        styles: { font: 'helvetica', fontSize: 10 },
        headStyles: { fillColor: [33,34,36], textColor: 255 },
        alternateRowStyles: { fillColor: [245,245,245] },
        margin: { left, right: left },
      });

      y = doc.lastAutoTable.finalY + 20;

      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('Inventory Files', left, y);

      doc.autoTable({
        startY: y + 10,
        head: [['File name','Type','Size']],
        body: (v.files && v.files.length ? v.files : [{name:'‚Äî',type:'‚Äî',size:0}]).map(f => [
          f.name||'‚Äî', f.type||'‚Äî', (f.size ? (f.size/1024).toFixed(1)+' KB' : '‚Äî')
        ]),
        styles: { font: 'helvetica', fontSize: 10 },
        headStyles: { fillColor: [33,34,36], textColor: 255 },
        alternateRowStyles: { fillColor: [245,245,245] },
        margin: { left, right: left },
      });

      const pageCount = doc.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(9); doc.setTextColor(120);
        const pageWidth = doc.internal.pageSize.getWidth();
        doc.text(`Page ${i} of ${pageCount}`, pageWidth - left, doc.internal.pageSize.getHeight() - 20, { align: 'right' });
      }

      const safeName = (v.name || 'voyage').trim()
        .replace(/[^\p{L}\p{N}_-]+/gu, '_').replace(/_+/g, '_').replace(/^_+|_+$/g, '');
      doc.save(`${safeName}_report.pdf`);
    }

    // ------- Init -------
    renderVoyages(); renderCrew(); renderUploads(); updateSectionEnabled();
  </script>
</body>
</html>