<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Seavo Nautiq-Office</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <style>
/* ===== MOBILE-FRIENDLY PACK (tilpasset full bredde) ===== */
:root{
  --gap: 16px;
  --radius: 12px;
  --shadow: 0 6px 18px rgba(0,0,0,.15);

  --fs-sm: clamp(12px, .9vw, 14px);
  --fs-md: clamp(14px, 1.2vw, 16px);
  --fs-lg: clamp(18px, 2.2vw, 24px);
  --fs-xl: clamp(22px, 3vw, 32px);
}

html { -webkit-text-size-adjust: 100%; }
body { margin:0; font: 400 var(--fs-md)/1.5 system-ui, Arial, sans-serif; }

/* FULL-BREDDE container (kun litt innvendig luft) */
.container { width:100%; margin-inline:auto; padding-inline: 24px; }
.row { display:grid; grid-template-columns: repeat(12, 1fr); gap: var(--gap); }
.col-12{ grid-column: span 12; } .col-6{ grid-column: span 6; }
.col-4{ grid-column: span 4; } .col-3{ grid-column: span 3; }
.col-8{ grid-column: span 8; } .col-2{ grid-column: span 2; }

.card{ background: rgba(255,255,255,.06); backdrop-filter: blur(6px);
  border:1px solid rgba(255,255,255,.1); border-radius: var(--radius); padding:16px; box-shadow: var(--shadow); }

img, video, canvas, svg { max-width:100%; height:auto; }

button, .btn, .nav a, a.button {
  display:inline-flex; align-items:center; justify-content:center;
  min-height:44px; min-width:44px; padding:.6rem .9rem; border-radius:10px;
  border:1px solid rgba(255,255,255,.15); text-decoration:none; cursor:pointer;
}

.hide-on-mobile{ display:revert; } .show-on-mobile{ display:none; }

/* Tabeller → scroll på små skjermer, full bredde på store */
.table-wrap { width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; }
table { width:100%; border-collapse:collapse; table-layout: auto; }
th, td { padding:10px; border:1px solid rgba(255,255,255,.15); white-space:nowrap; }
th { position:sticky; top:0; backdrop-filter: blur(4px); }

@media (max-width: 600px){
  .table--stacked { border:0; }
  .table--stacked thead { display:none; }
  .table--stacked tr { display:grid; grid-template-columns: 1fr 1.2fr; gap:6px 10px; padding:12px; border:1px solid rgba(255,255,255,.12); border-radius:10px; margin-bottom:10px; }
  .table--stacked td { border:0; white-space:normal; padding:2px 0; }
  .table--stacked td::before { content: attr(data-label); font-weight:700; margin-right:8px; display:block; opacity:.85; }
}

/* Breakpoints */
@media (max-width: 992px){
  .col-md-12{ grid-column: span 12; }
  .col-md-6{ grid-column: span 6; }
  .col-md-4{ grid-column: span 4; }
}
@media (max-width: 768px){
  .row { grid-template-columns: repeat(6, 1fr); }
  .col-6, .col-md-6 { grid-column: span 6; }
  .col-4, .col-md-4 { grid-column: span 6; }
  .col-3 { grid-column: span 3; }
  .hide-on-mobile{ display:none !important; }
  .show-on-mobile{ display:revert !important; }
  th, td { white-space:normal; }
}
@media (max-width: 480px){
  :root { --gap: 12px; }
  body { font-size: var(--fs-sm); }
  .row { grid-template-columns: repeat(4, 1fr); }
  .col-3 { grid-column: span 4; }
}

/* ===== EKSISTERENDE STIL (små justeringer for full bredde) ===== */
:root{
  --bg:#0f2a4a;
  --panel:rgba(0,0,0,.18);
  --panel-2:rgba(255,255,255,.08);
  --text:#ffffff;
  --muted:#bcd3f1;
  --accent:#62b2e7;
  --accent-2:#1b75d1;
  --accent-3:#0e3e86;
  --danger:#f03747;
  --warn:#ecc543;
  --ok:#28e755;

  --panel-w: 200px;
  --panel-h: 36vh;
  --handle-w: 28px;
}

*{box-sizing:border-box}
body{ background-color:var(--bg); color:var(--text); font-family:Arial,sans-serif; }

/* Header-video */
.video-header{ position:relative; aspect-ratio:1280/99; overflow:hidden; background:#000; }
.video-header video{ width:100%; height:200%; object-fit:cover; display:block; }
.gradient-overgang{ height:10px; background:linear-gradient(to left,#62b2e7,#001125); box-shadow:6px 4px 6px rgba(0,0,0,.7); }

/* TOPP / LOGO / SØK */
.logo{
  width:200px; height:auto; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.45);
  cursor:pointer; transition:transform .2s ease, box-shadow .2s ease; background:rgba(255,255,255,.04);
}
.logo:hover{ transform:scale(1.05); box-shadow:0 8px 28px rgba(0,0,0,.6); }

#searchBox{
  width: min(480px, 100%);
  padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.25);
  background:rgba(0,0,0,.25); color:var(--text); font-weight:600; box-shadow:0 6px 16px rgba(0,0,0,.35); outline:none;
  margin: 12px 0 18px 0;
}
#searchBox::placeholder{ color:var(--muted); }
#searchBox:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(98,178,231,.25); }

/* Bakgrunnsbilde */
.office{
  width:100%; height:auto; position:absolute; top:0; left:0; z-index:-1; opacity:.08; pointer-events:none;
  filter:saturate(.9) contrast(1.05);
}

/* KATEGORI-SLIDER */
.category-slider-office{
  display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.25); backdrop-filter:blur(4px);
  padding:14px; overflow-x:auto; border-radius:14px;
  border:1px solid rgba(255,255,255,.12); box-shadow:0 10px 26px rgba(0,0,0,.35);
}
#category-container{ display:flex; overflow-x:auto; max-width:100%; width:100%; scroll-behavior:smooth; }
#categories{ display:flex; gap:8px; }
.category-item{ display:flex; align-items:center; margin:0 6px; }
.category-button,.add-category{
  padding:10px 16px; background:linear-gradient(to right,var(--accent-2),var(--accent-3));
  color:#fff; border-radius:10px; cursor:pointer; font-size:15px; border:1px solid rgba(255,255,255,.12); box-shadow:0 4px 12px rgba(0,0,0,.35);
  white-space:nowrap;
}
.category-button.active{ background:linear-gradient(to right,#438ed3,#1853a8); font-weight:700; }
.category-button:hover,.add-category:hover{ filter:brightness(1.30); }
.delete-category{ color:var(--danger); font-size:18px; margin-left:10px; cursor:pointer; filter:drop-shadow(0 2px 4px rgba(0,0,0,.5)); }
.arrow{
  font-size:18px; font-weight:700; padding:8px 12px; background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.12);
  color:#fff; border-radius:10px; cursor:pointer; width:56px; box-shadow:0 6px 16px rgba(0,0,0,.35); margin-left:16px;
}
.arrow:hover{ background:rgba(0,0,0,.35); }

/* KNAPPER GLOBALT */
.global-button,#sidePanel button:not(#togglePanelBtn),#calc-buttons button{
  background:linear-gradient(to right,var(--accent-2),var(--accent-3));
  color:#fff; border:1px solid rgba(255,255,255,.12); border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.35);
}
.global-button{ padding:10px 18px; font-size:15px; font-weight:700; cursor:pointer; margin:10px 0; }
.global-button:hover{ filter:brightness(1.30); }

/* TABELL */
table{
  width:100%; border-collapse:collapse; background:rgba(0,0,0,.20); color:var(--text);
  margin:20px 0; border:1px solid rgba(255,255,255,.12); border-radius:14px; overflow:hidden; box-shadow:0 12px 28px rgba(0,0,0,.35);
}
th,td{ border-bottom:1px solid rgba(255,255,255,.12); padding:10px; text-align:center; font-size:16px; }
th{ background:rgba(0,0,0,.28); color:var(--text); }

.header-row td{
  background:linear-gradient(to right, rgba(255,255,255,.06), rgba(255,255,255,.02));
  font-weight:700; text-align:left; border-color:rgba(255,255,255,.12); border-radius:0;
}
.header-row td span{ display:inline-block; width:52%; margin-left:10px; color:var(--text); vertical-align:middle; }

.section-columns td{
  background:rgba(0,0,0,.24); color:#fff; font-weight:700; border-bottom:1px solid rgba(255,255,255,.12); padding:6px 10px;
}
.section-columns td.muted{ color:#bcd3f1; font-weight:600; }

/* Header farge-chip */
.header-color-chip{
  height:8px; width:14px; border-radius:4px; border:1px solid rgba(0,0,0,.35); box-shadow:0 0 4px rgba(0,0,0,.25);
  cursor:pointer; margin-left:4px; background:rgba(255,255,255,.15); display:inline-block; opacity:.9;
}

/* Celler / inputs */
.large-bold-input{ font-weight:700; font-size:14px; color:var(--text); background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.18); }
.large-bold-input::placeholder{ color:var(--muted); }
.large-bold-input:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(98,178,231,.18); }

.cell-min,.cell-max{ width:110px; min-width:110px; max-width:140px; }
.cell-order{ width:140px; }
.cell-move{ width:100px; }
.cell-product{ min-width:280px; }
.cell-comment{ min-width:300px; }
td.min-col input{ width:60px; }

/* Flytteknapper */
.cell-move button{
  width:42px; height:36px; background:linear-gradient(to right,var(--accent-2),var(--accent-3));
  color:#fff; border-radius:10px; cursor:pointer; font-size:16px; border:1px solid rgba(255,255,255,.12);
}
.cell-move button:hover{ filter:brightness(1.15); }

td:last-child{ width:80px; background:linear-gradient(to right, rgba(78,155,206,.25), rgba(27,56,99,.25)); }

.btn-danger{
  background:linear-gradient(to right,#f13e4e,#a31621); color:#fff; font-weight:bold; padding:6px 12px; border-radius:6px; cursor:pointer; border:none;
}
.btn-danger:hover{ background:linear-gradient(to right,#ff5a6b,#c3222d); font-style:italic; box-shadow:0 0 20px #ff0000; }

/* Alarmfarger */
.min-alarm{ background:linear-gradient(to right, rgba(255,255,255,.2), rgba(247, 230, 0, 0.35)) !important; }
.max-alarm{ background:linear-gradient(to right, rgba(255,255,255,.2), rgba(95, 255, 2, 0.28)) !important; }

/* Transparent input via CSS-variabel --col-rgb */
.product-input{ background-color:rgba(var(--col-rgb,0,0,0), .30); transition:background-color .15s ease; }
.product-input:focus{ background-color:rgba(var(--col-rgb,0,0,0), .22); }

/* Produkt fargepicker */
.product-color-wrap{
  position:relative; display:grid !important;
  grid-template-columns:1fr auto; align-items:center; column-gap:6px; width:100%;
}
.product-color-wrap input{ width:100% !important; min-width:0; }

.color-chip{
  width:16px; height:16px; border-radius:4px; border:1px solid rgba(0,0,0,.35); cursor:pointer;
  box-shadow:0 0 4px rgba(0,0,0,.25);
  background:var(--chip-color, rgba(255,255,255,.15));
}

.color-popover{
  position:absolute; top: 100%; left: 100px;
  display:grid; grid-template-columns:repeat(4, 18px); gap:6px;
  background:rgba(3,14,24,.95); padding:10px; border-radius:10px;
  border:1px solid rgba(255,255,255,.12); box-shadow:0 10px 26px rgba(0,0,0,.55); z-index:2000;
}
.color-popover.hidden{ display:none; }
.color-option{ width:18px; height:18px; border-radius:4px; cursor:pointer; border:1px solid rgba(0,0,0,.35); box-shadow:0 0 3px rgba(0,0,0,.25); }
.color-option.clear{
  background:linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 50%, #ccc 50%, #ccc 75%, transparent 75%, transparent);
  background-size:8px 8px;
}
.color-option:hover,.color-chip:hover{ outline:1px solid #ffffff; }

/* SIDE PANEL */
#sidePanel{
  position:fixed; overflow:visible; top:180px; right:0; width:var(--panel-w); height:var(--panel-h);
  background:rgba(0,0,0,.35); backdrop-filter:blur(4px); color:var(--text); display:flex; flex-direction:column; align-items:center;
  padding:16px 10px; box-shadow:-8px 0 22px rgba(0,0,0,.45); transition:right .5s ease; z-index:999; border-radius:16px 0 0 16px; border:1px solid rgba(255,255,255,.12);
}
#sidePanel.hidden{ right:calc(-1 * (var(--panel-w) - var(--handle-w))); }

#togglePanelBtn{
  position:absolute; left:0; top:50%; transform:translate(-100%, -50%); width:var(--handle-w); height:clamp(96px,50%,180px);
  display:flex; align-items:center; justify-content:center; padding:0; background:linear-gradient(to bottom, var(--accent-2), var(--accent-3));
  color:#fff; font-weight:bold; font-size:22px; border-radius:12px 0 0 12px; cursor:pointer; box-shadow:-8px 0 12px rgba(0,0,0,.35);
  user-select:none; z-index:1000; border:1px solid rgba(255,255,255,.12);
}
#togglePanelBtn:hover{ filter:brightness(1.06); }

#bottomButtons{ margin-top:auto; width:100%; display:flex; flex-direction:column; gap:6px; }
#sidePanel button:not(#togglePanelBtn){
  margin:4px 0; padding:12px 14px; width:100%; background:linear-gradient(to right,#123981,#1994db);
  color:#fff; font-weight:700; border-radius:10px; cursor:pointer; font-size:14px; box-shadow:0 6px 14px rgba(0,0,0,.35);
}
#sidePanel button:not(#togglePanelBtn):hover{ filter:brightness(1.05); }

/* Markering */
.highlight{ background:rgba(240,138,42,.8); font-weight:700; color:#09111f; border-radius:4px; padding:0 2px; }
.highlight-input{ background:rgba(255,222,89,.85); color:#09111f; font-weight:700; }

/* MODALER */
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:1500; }
.modal-innhold{
  position:absolute; left:300px; top:200px; transform:translate(0,0); background:rgba(8,22,38,.9); padding:16px; width:280px;
  border-radius:16px; box-shadow:0 14px 30px rgba(0,0,0,.6); text-align:center; z-index:1501; border:1px solid rgba(255,255,255,.12);
}
.calculator-header{ background:linear-gradient(to right,#104f68,#326fa8); color:white; padding:6px 10px; cursor:move; border-radius:12px 12px 0 0; display:flex; justify-content:space-between; align-items:center; }
.lukk{ font-weight:700; font-size:22px; cursor:pointer; }
#calc-buttons button{ width:46px; height:40px; font-size:18px; margin:3px; }
#calc-buttons button:hover{ filter:brightness(1.25); }

/* Diverse */
button img{ width:40px; height:40px; padding-left:55px; margin-top:20px; }
#content{ padding:20px 0; }

/* PRINT */
@media print{
  body{ background:#fff; color:#000; }
  .video-header,.gradient-overgang,.global-button,#sidePanel,.category-slider-office,.logo,#searchBox{ display:none !important; }
  table{ background:#fff; color:#000; box-shadow:none; border:1px solid #ccc; }
  th{ background:#f2f2f2; color:#000; }
}

/* MOBILE TWEAKS */
@media (max-width: 900px){
  .logo{ width:150px; }
  .category-slider-office{ padding:10px; }
}
@media (max-width: 600px){
  .logo{ width:120px; }
  #sidePanel{ --panel-w: 160px; --handle-w: 26px; top:120px; }
  .cell-product{ min-width:unset; }
  .cell-comment{ min-width:unset; }
}
  </style>
</head>

<body>
  <header class="video-header">
    <video autoplay muted loop playsinline>
      <source src="Video/Ocean-Seavo-Nautiq.mp4" type="video/mp4">
    </video>
  </header>
  <div class="gradient-overgang"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <div class="container">
    <header style="display:flex; align-items:center; gap:16px; flex-wrap:wrap; padding:12px 0;">
      <h1 style="margin:0; color: rgb(30, 182, 209); font-size:var(--fs-xl); font-weight:bold; text-shadow:0 1px 3px rgba(0,0,0,.6);">Office</h1>
      <a href="index.html" class="logo-link" style="display:inline-flex; align-items:center;">
        <img src="images/Logo Seavo Nautiq.png" alt="Logo Seavo Nautiq" class="logo">
      </a>

      <span style="flex:1 1 auto;"></span>
      <button class="btn show-on-mobile" id="menuToggle" aria-label="Toggle Menu">☰ Menu</button>

      <div id="sidePanel" class="hidden">
        <button>Help</button>
        <button>Documents</button>
        <button>Shared Content</button>
        <button>Settings</button>
        <button id="signOutBtn">Sign Out</button>
        <div id="bottomButtons">
          <button id="openCalculatorBtn">🧮 Calculator</button>
          <button id="openNotepadBtn">📝 Notepad</button>
        </div>
        <button id="togglePanelBtn" onclick="toggleSidePanel()">⫷</button>
      </div>
    </header>

    <input type="text" id="searchBox" placeholder="Search inventory..." oninput="searchInPage()">

    <div class="category-slider-office">
      <button class="arrow" onclick="scrollSlider(-100)">←</button>
      <div id="category-container">
        <div id="categories"></div>
      </div>
      <button class="arrow" onclick="scrollSlider(100)">→</button>
      <button class="add-category" onclick="addCategory()">+ Category</button>
    </div>

    <div style="position:relative;"><img src="images/Office.PNG" alt="Office" class="office"></div>

    <div id="content"></div>

    <div class="row" style="margin-top:8px;">
      <div class="col-12" style="display:flex; gap:12px; flex-wrap:wrap;">
        <button id="globalToggleButton" class="global-button" onclick="toggleGlobalView()">📋 Global Overview</button>
        <button class="global-button" onclick="generatePDF()">📄 Generate PDF</button>
        <button class="global-button" onclick="save()">💾 Save</button>
      </div>
    </div>
  </div>

  <!-- ====== MODALS ====== -->
  <div id="calculatorModal" class="modal" style="display:none;">
    <div class="modal-innhold" id="calculatorWindow">
      <div class="calculator-header" id="calcDragHandle">
        <h2 style="margin: 0; font-size: 15px;">Calculator</h2>
        <span class="lukk" onclick="closeCalculator()">×</span>
      </div>
      <input id="calc-display" type="text" readonly style="width: 90%; padding: 10px; font-size: 25px; text-align: right; margin-top: 10px;"><br><br>
      <div id="calc-buttons">
        <button onclick="appendCalc('7')">7</button>
        <button onclick="appendCalc('8')">8</button>
        <button onclick="appendCalc('9')">9</button>
        <button onclick="appendCalc('/')">÷</button><br>
        <button onclick="appendCalc('4')">4</button>
        <button onclick="appendCalc('5')">5</button>
        <button onclick="appendCalc('6')">6</button>
        <button onclick="appendCalc('*')">×</button><br>
        <button onclick="appendCalc('1')">1</button>
        <button onclick="appendCalc('2')">2</button>
        <button onclick="appendCalc('3')">3</button>
        <button onclick="appendCalc('-')">−</button><br>
        <button onclick="appendCalc('0')">0</button>
        <button onclick="appendCalc('.')">.</button>
        <button onclick="calculateResult()">=</button>
        <button onclick="appendCalc('+')">+</button><br>
        <button onclick="appendCalc('%')">%</button>
        <button onclick="deleteLast()" style="width: 30%;">DEL</button><br>
        <button onclick="clearCalc()" style="width: 90%">C</button>
      </div>
    </div>
  </div>

  <div id="notepadModal" class="modal" style="display:none;">
    <div class="modal-innhold" id="notepadWindow">
      <div class="calculator-header" id="noteDragHandle">
        <h2 style="margin:0; font-size:15px;">Notepad</h2>
        <span class="lukk" onclick="closeNotepad()">×</span>
      </div>
      <textarea id="noteArea" style="width:100%; height:260px; margin-top:10px; border-radius:10px;"></textarea>
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:center;">
        <button onclick="saveNote()" style="padding:8px 12px;">Save</button>
        <button onclick="clearNote()" style="padding:8px 12px;">Clear</button>
      </div>
    </div>
  </div>

  <script>
/* ===== Responsive init (pakker tabeller for scroll) ===== */
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('table').forEach(tbl => {
    if (tbl.parentElement && tbl.parentElement.classList.contains('table-wrap')) return;
    const wrap = document.createElement('div');
    wrap.className = 'table-wrap';
    tbl.parentNode.insertBefore(wrap, tbl);
    wrap.appendChild(tbl);
  });

  const toggle = document.getElementById('menuToggle');
  const nav = document.querySelector('.nav');
  if (toggle && nav){
    toggle.addEventListener('click', () => {
      nav.style.display = (getComputedStyle(nav).display === 'none') ? 'flex' : 'none';
    });
    if (window.matchMedia('(max-width: 768px)').matches) nav.style.display = 'none';
  }
});

/* ===== Sidepanel toggle ===== */
function toggleSidePanel(){
  const panel = document.getElementById("sidePanel");
  const btn   = document.getElementById("togglePanelBtn");
  const nowHidden = panel.classList.toggle("hidden");
  btn.textContent = nowHidden ? "⫷" : "⫸";
}

/* ===== Søk/markering ===== */
function searchInPage(){
  const term=document.getElementById("searchBox").value.trim().toLowerCase();
  removeHighlights(); if(term==="") return;
  let firstMatch=null;
  document.querySelectorAll("td span").forEach(span=>{
    const content=span.textContent.toLowerCase();
    if(content.includes(term)){
      const index=content.indexOf(term);
      const original=span.textContent;
      const before=original.slice(0,index);
      const match=original.slice(index,index+term.length);
      const after=original.slice(index+term.length);
      span.innerHTML=`${before}<span class="highlight">${match}</span>${after}`;
      if(!firstMatch) firstMatch=span;
    }
  });
  document.querySelectorAll("input").forEach(input=>{
    if((input.value||"").toLowerCase().includes(term)){
      input.classList.add("highlight-input");
      if(!firstMatch) firstMatch=input;
    }
  });
  if(firstMatch){ setTimeout(()=>{ firstMatch.scrollIntoView({behavior:"smooth", block:"center"}); },100); }
}
function removeHighlights(){
  document.querySelectorAll("span .highlight").forEach(el=>{
    const parent=el.parentNode; parent.replaceChild(document.createTextNode(el.textContent), el); parent.normalize();
  });
  document.querySelectorAll(".highlight-input").forEach(input=> input.classList.remove("highlight-input"));
}

/* ===== Data/setup ===== */
let data = JSON.parse(localStorage.getItem("lagerDataV3")) || {};
let activeCategory = Object.keys(data)[0] || "Standard";
function save(){ localStorage.setItem("lagerDataV3", JSON.stringify(data)); }
function scrollSlider(offset){ document.getElementById("category-container").scrollLeft += offset; }

Object.values(data).forEach(rows=>{
  (rows||[]).forEach(r=>{
    if(r && r.type!=="header" && typeof r.max==="undefined"){ r.max=0; }
  });
});
save();

/* ===== Kategorier ===== */
function updateCategories(){
  const container=document.getElementById("categories");
  container.innerHTML="";
  Object.keys(data).forEach(name=>{
    const wrapper=document.createElement("div"); wrapper.className="category-item"; wrapper.style.display="flex"; wrapper.style.alignItems="center";
    const btn=document.createElement("button"); btn.className="category-button"; btn.textContent=name;
    if(name===activeCategory) btn.classList.add("active");
    btn.onclick=()=>{ activeCategory=name; showCategory(); updateCategories(); };
    const del=document.createElement("span"); del.className="delete-category"; del.textContent="🗑️";
    del.onclick=()=>{ if(confirm(`Do you want to delete the category "${name}"?`)){ delete data[name]; activeCategory=Object.keys(data)[0]||null; save(); updateCategories(); showCategory(); } };
    wrapper.appendChild(btn); wrapper.appendChild(del); container.appendChild(wrapper);
  });
}
function addCategory(){
  const name=prompt("New category:");
  if(name && !data[name]){ data[name]=[]; activeCategory=name; save(); updateCategories(); showCategory(); }
}

/* Palett */
const PRODUCT_COLORS = [
  "#36d131","#ffd036","#40e0d0","#ffffff",
  "#ff6b6b","#4da3ff","#ffa94d","#a78bfa",
  "#94a3b8","#000000","#f472b6","#14b8a6",
  "#1f2937","#84cc16","#b45309","#c0c0c0"
];

/* Fargehjelpere */
function toRgbStr(col){
  if(/^#/.test(col)){
    let hex = col.replace('#','');
    if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
    const n = parseInt(hex,16);
    const r = (n>>16)&255, g=(n>>8)&255, b=n&255;
    return `${r},${g},${b}`;
  }
  if(/^rgba?\(/i.test(col)){
    const m = col.match(/rgba?\s*\(\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)/i);
    if(m) return `${m[1]},${m[2]},${m[3]}`;
  }
  const tmp = document.createElement('span');
  tmp.style.color = col; document.body.appendChild(tmp);
  const rgb = getComputedStyle(tmp).color; document.body.removeChild(tmp);
  const m2 = rgb.match(/rgb\(\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)/i);
  return m2 ? `${m2[1]},${m2[2]},${m2[3]}` : `0,0,0`;
}
function bestTextColor(hexOrCss){
  const [r,g,b] = toRgbStr(hexOrCss).split(',').map(n=>+n);
  const lum = 0.2126*(r/255) + 0.7152*(g/255) + 0.0722*(b/255);
  return lum > 0.55 ? '#000' : '#fff';
}

/* Popover */
let currentOpenPopover = null;
function hidePopover(p){ if(!p) return; p.classList.add('hidden'); if(currentOpenPopover===p) currentOpenPopover=null; }
function togglePopover(p){
  if(!p) return;
  if(currentOpenPopover && currentOpenPopover!==p) currentOpenPopover.classList.add('hidden');
  const willOpen = p.classList.contains('hidden');
  p.classList.toggle('hidden', !willOpen);
  currentOpenPopover = willOpen ? p : null;
}

/* Product Color Picker */
function buildProductColorPicker(td, input, row){
  const wrap = document.createElement('span');
  wrap.className = 'product-color-wrap';
  if(input.parentNode===td) td.removeChild(input);
  wrap.appendChild(input);

  const chip = document.createElement('span');
  chip.className = 'color-chip';
  chip.title = 'Pick color';

  if(row.productColor){
    chip.style.setProperty('--chip-color', row.productColor);
    input.classList.add('product-input');
    input.style.setProperty('--col-rgb', toRgbStr(row.productColor));
    input.style.color = bestTextColor(row.productColor);
  }

  const pop = document.createElement('div');
  pop.className = 'color-popover hidden';

  const clear = document.createElement('div');
  clear.className = 'color-option clear';
  clear.title = 'Clear';
  clear.onclick = (e)=>{
    e.stopPropagation();
    row.productColor = null;

    input.classList.remove('product-input');
    input.style.removeProperty('--col-rgb');
    input.style.color = '';
    chip.style.removeProperty('--chip-color');

    save();
    hidePopover(pop);
  };
  pop.appendChild(clear);

  PRODUCT_COLORS.forEach(col=>{
    const sw = document.createElement('div');
    sw.className = 'color-option';
    sw.style.background = col;
    sw.title = col;
    sw.onclick = (e)=>{
      e.stopPropagation();
      row.productColor = col;

      input.classList.add('product-input');
      input.style.setProperty('--col-rgb', toRgbStr(col));
      input.style.color = bestTextColor(col);

      chip.style.setProperty('--chip-color', col);
      save();
      hidePopover(pop);
    };
    pop.appendChild(sw);
  });

  wrap.appendChild(chip);
  wrap.appendChild(pop);
  td.appendChild(wrap);

  chip.addEventListener('click', (e)=>{ e.stopPropagation(); togglePopover(pop); });
  document.addEventListener('click', (ev)=>{ if(!wrap.contains(ev.target)) hidePopover(pop); });
}

/* Header Color */
function applyHeaderStyle(td, row){
  const span = td.querySelector('span');
  if(row.headerColor){
    const col = row.headerColor;
    td.style.background = `linear-gradient(to right, ${col}36, ${col}10)`;
    td.style.borderColor = 'rgba(255,255,255,.18)';
    if(span) span.style.color = bestTextColor(col);
  }else{
    td.style.background = '';
    td.style.borderColor = '';
    if(span) span.style.color = '';
  }
}
function buildHeaderColorPicker(hostTd, row){
  hostTd.style.position = hostTd.style.position || 'relative';

  const chip = document.createElement('span');
  chip.className = 'header-color-chip';
  chip.title = 'Pick header color';
  if(row.headerColor) chip.style.background = row.headerColor;

  const pop = document.createElement('div');
  pop.className = 'color-popover hidden';

  const clear = document.createElement('div');
  clear.className = 'color-option clear';
  clear.title = 'Clear';
  clear.onclick = (e)=>{
    e.stopPropagation();
    row.headerColor = null;
    chip.style.background = 'rgba(255,255,255,.15)';
    applyHeaderStyle(hostTd, row);
    save();
    hidePopover(pop);
  };
  pop.appendChild(clear);

  PRODUCT_COLORS.forEach(col=>{
    const sw = document.createElement('div');
    sw.className = 'color-option';
    sw.style.background = col;
    sw.title = col;
    sw.onclick = (e)=>{
      e.stopPropagation();
      row.headerColor = col;
      chip.style.background = col;
      applyHeaderStyle(hostTd, row);
      save();
      hidePopover(pop);
    };
    pop.appendChild(sw);
  });

  hostTd.appendChild(chip);
  hostTd.appendChild(pop);

  chip.addEventListener('click', (e)=>{ e.stopPropagation(); togglePopover(pop); });
  document.addEventListener('click', (ev)=>{ if(!hostTd.contains(ev.target)) hidePopover(pop); });
}

/* Tabellbygging */
function showCategory(){
  const content=document.getElementById("content");
  content.innerHTML="";
  if(!activeCategory || !data[activeCategory]) return;

  const table=document.createElement("table");
  table.classList.add('table--stacked');
  table.innerHTML=`
    <thead>
      <tr>
        <th>Product/Type</th><th>Start Qty</th><th>Used</th><th>End Qty</th>
        <th>MIN🔔</th><th>MAX🔔</th><th>Comments</th><th>Order</th><th>Move</th><th>Delete</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody=table.querySelector("tbody");

  data[activeCategory].forEach((row,i)=>{
    const tr=document.createElement("tr");

    if(row.type==="header"){
      tr.className="header-row";
      const td=document.createElement("td");
      td.colSpan=10;
      const span=document.createElement("span");
      span.contentEditable=true;
      span.textContent=row.text||"Section / Header";
      span.oninput=()=>{ row.text=span.textContent; save(); };
      td.appendChild(span);
      tr.appendChild(td);
      tbody.appendChild(tr);

      buildHeaderColorPicker(td, row);
      applyHeaderStyle(td, row);

      const sub=document.createElement("tr");
      sub.className="section-columns";
      sub.innerHTML=`
        <td>Product/Type</td>
        <td>Start Qty</td>
        <td>Used</td>
        <td>End Qty</td>
        <td>MIN🔔</td>
        <td>MAX🔔</td>
        <td>Comments</td>
        <td>Order</td>
        <td>Move</td>
        <td><button class="btn-danger" onclick="deleteRow(${i})">Delete</button></td>
      `;
      tbody.appendChild(sub);
      return;
    }

    row.product ??=""; row.start ??=0; row.used ??=0; row.end ??=(parseFloat(row.start)||0)-(parseFloat(row.used)||0);
    row.min ??=0; row.max ??=0; row.comment ??=""; row.order ??=0;

    const fields=['product','start','used','end','min','max','comment','order'];
    const inputs={};

    function makeTd(label){
      const td=document.createElement('td');
      td.setAttribute('data-label', label);
      return td;
    }

    fields.forEach((key)=>{
      const labelMap = {
        product:'Product/Type', start:'Start Qty', used:'Used', end:'End Qty',
        min:'MIN🔔', max:'MAX🔔', comment:'Comments', order:'Order'
      };
      const td = makeTd(labelMap[key] || key);

      if(key==='product') td.classList.add("cell-product");
      else if(key==='comment') td.classList.add("cell-comment");
      else if(key==='min') td.classList.add("cell-min");
      else if(key==='max') td.classList.add("cell-max");
      else if(key==='order') td.classList.add("cell-order");
      else td.classList.add("cell-small");

      const input=document.createElement("input");
      input.type=(key==='product'||key==='comment')?"text":"number";
      input.value=row[key] ?? "";
      input.style.width="100%"; input.style.padding="8px"; input.style.borderRadius="10px";
      input.placeholder=labelMap[key] || key;
      input.classList.add("large-bold-input");
      if(key==='end'){ input.readOnly=true; }

      input.oninput=()=>{
        row[key]=input.value;
        const startVal=parseFloat(row.start)||0;
        const usedVal=parseFloat(row.used)||0;
        row.end = startVal - usedVal;
        inputs['end'].value = row.end;
        updateAlarms();
        save();
      };

      inputs[key]=input;
      td.appendChild(input);

      if(key==='product'){
        if(row.productColor){
          input.classList.add('product-input');
          input.style.setProperty('--col-rgb', toRgbStr(row.productColor));
          input.style.color = bestTextColor(row.productColor);
        }
        buildProductColorPicker(td, input, row);
      }

      tr.appendChild(td);
    });

    function updateAlarms(){
      const startVal=parseFloat(inputs['start'].value);
      const usedVal=parseFloat(inputs['used'].value);
      const endVal=(isNaN(startVal)?0:startVal)-(isNaN(usedVal)?0:usedVal);
      inputs['end'].value=endVal;
      const minVal=parseFloat(inputs['min'].value);
      const maxVal=parseFloat(inputs['max'].value);

      if(!isNaN(endVal) && !isNaN(minVal) && endVal<=minVal) inputs['min'].classList.add("min-alarm");
      else inputs['min'].classList.remove("min-alarm");

      if(!isNaN(startVal) && !isNaN(maxVal) && startVal>maxVal) inputs['max'].classList.add("max-alarm");
      else inputs['max'].classList.remove("max-alarm");
    }
    updateAlarms();

    const tdMove=document.createElement("td"); tdMove.classList.add("cell-move"); tdMove.setAttribute('data-label','Move');
    tdMove.innerHTML=`<button onclick="moveRow(${i},-1)">⬆️</button> <button onclick="moveRow(${i},1)">⬇️</button>`;
    const tdDel=document.createElement("td"); tdDel.setAttribute('data-label','Delete');
    tdDel.innerHTML=`<button class="btn-danger" onclick="deleteRow(${i})">Delete</button>`;
    tr.appendChild(tdMove); tr.appendChild(tdDel);
    tbody.appendChild(tr);
  });

  content.appendChild(table);

  const actions = document.createElement('div');
  actions.style.display='flex';
  actions.style.flexWrap='wrap';
  actions.style.gap='10px';
  actions.style.margin='10px 0';

  const addLine=document.createElement("button");
  addLine.className="global-button"; addLine.textContent="+ Add line";
  addLine.onclick=()=>{ data[activeCategory].push({type:"line", product:"", start:0, used:0, end:0, min:0, max:0, comment:"", order:0, productColor:null}); save(); showCategory(); };

  const addHeader=document.createElement("button");
  addHeader.className="global-button"; addHeader.textContent="+ Add header/section";
  addHeader.onclick=()=>{ data[activeCategory].push({type:"header", text:"New Header"}); save(); showCategory(); };

  actions.appendChild(addLine);
  actions.appendChild(addHeader);
  content.appendChild(actions);

  searchInPage();
}

function deleteRow(index){ data[activeCategory].splice(index,1); save(); showCategory(); }
function moveRow(index, direction){
  const list=data[activeCategory]; const newIndex=index+direction;
  if(newIndex<0 || newIndex>=list.length) return;
  const temp=list[index]; list[index]=list[newIndex]; list[newIndex]=temp;
  save(); showCategory();
}

/* Global oversikt */
function showGlobalOverview(){
  const content=document.getElementById("content");
  content.innerHTML="<h2>Global overview of the entire inventory</h2>";
  const table=document.createElement("table");
  table.classList.add('table--stacked');
  table.innerHTML=`
    <thead>
      <tr><th>Category</th><th>Product</th><th>Start</th><th>Used</th><th>End</th><th>Min</th><th>Max</th><th>Comment</th><th>Order</th></tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody=table.querySelector("tbody");
  Object.entries(data).forEach(([category, rows])=>{
    rows.forEach(row=>{
      if(row.type==="header") return;
      const tr=document.createElement("tr");
      const start=parseFloat(row.start)||0;
      const used =parseFloat(row.used)||0;
      const end  = (typeof row.end!=="undefined") ? row.end : (start-used);
      const min  = parseFloat(row.min)||0;
      const max  = parseFloat(row.max)||0;

      const values=[
        ['Category',category],
        ['Product', row.product||''],
        ['Start', start],
        ['Used', used],
        ['End', end],
        ['Min', min],
        ['Max', max],
        ['Comment', row.comment||''],
        ['Order', row.order||'']
      ];
      values.forEach(([lbl,val])=>{
        const td=document.createElement("td");
        td.setAttribute('data-label', lbl);
        td.textContent=val;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  });
  content.appendChild(table);
}

if(!data[activeCategory]){ data[activeCategory]=[]; save(); }

let isGlobalView=false;
function toggleGlobalView(){
  const button=document.getElementById("globalToggleButton");
  if(!isGlobalView){ showGlobalOverview(); button.textContent="🔙 Back to Table"; }
  else { showCategory(); button.textContent="📋 Global Overview"; }
  isGlobalView=!isGlobalView;
}

updateCategories();
showCategory();

/* ===== PDF ===== */
async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF('p','mm','a4');
  const logoImg=new Image(); logoImg.src="images/Logo Seavo Nautiq.png";
  await new Promise(resolve=>{ logoImg.onload=resolve; });
  doc.addImage(logoImg,'PNG',10,10,60,35);
  const content=document.getElementById("content");
  await html2canvas(content,{backgroundColor:"#ffffff"}).then(canvas=>{
    const imgData=canvas.toDataURL('image/png');
    const imgProps=doc.getImageProperties(imgData);
    const pdfWidth=doc.internal.pageSize.getWidth()-20;
    const pdfHeight=(imgProps.height*pdfWidth)/imgProps.width;
    doc.addImage(imgData,'PNG',13,35,pdfWidth,pdfHeight);
    doc.save("SeavoNautiq_Inventory.pdf");
  });
}

/* ===== Calculator / Notepad ===== */
function openCalculator(){ document.getElementById("calculatorModal").style.display="block"; }
function closeCalculator(){ document.getElementById("calculatorModal").style.display="none"; }
function openNotepad(){ document.getElementById("notepadModal").style.display="block"; }
function closeNotepad(){ document.getElementById("notepadModal").style.display="none"; }

function appendCalc(v){ const d=document.getElementById('calc-display'); d.value+=v; }
function deleteLast(){ const d=document.getElementById('calc-display'); d.value=d.value.slice(0,-1); }
function clearCalc(){ document.getElementById('calc-display').value=''; }
function calculateResult(){
  const d=document.getElementById('calc-display');
  try{
    const expr=d.value.replace(/×/g,'*').replace(/÷/g,'/');
    const expr2=expr.replace(/(\d+(\.\d+)?)%/g,(_,n)=>String(parseFloat(n)/100));
    d.value=String(Function(`"use strict";return (${expr2})`)());
  }catch{ d.value='Error'; }
}

/* Notepad lagring */
function saveNote(){ localStorage.setItem('seavo_note', document.getElementById('noteArea').value); }
function clearNote(){ document.getElementById('noteArea').value=''; localStorage.removeItem('seavo_note'); }

/* Drag-n-drop for modal-vinduer */
function makeDraggable(handleId, windowId){
  const handle=document.getElementById(handleId);
  const win=document.getElementById(windowId);
  if(!handle||!win) return;
  let offsetX=0, offsetY=0, dragging=false;
  handle.addEventListener('mousedown',(e)=>{
    dragging=true; const rect=win.getBoundingClientRect();
    offsetX=e.clientX-rect.left; offsetY=e.clientY-rect.top; document.body.style.userSelect='none';
  });
  window.addEventListener('mousemove',(e)=>{
    if(!dragging) return; win.style.left=(e.clientX-offsetX)+'px'; win.style.top=(e.clientY-offsetY)+'px';
  });
  window.addEventListener('mouseup',()=>{ dragging=false; document.body.style.userSelect=''; });
}

/* Init */
document.addEventListener("DOMContentLoaded", ()=>{
  const openCalcBtn=document.getElementById("openCalculatorBtn");
  const openNoteBtn=document.getElementById("openNotepadBtn");
  const calcModal=document.getElementById("calculatorModal");
  const noteModal=document.getElementById("notepadModal");

  openCalcBtn?.addEventListener("click", openCalculator);
  openNoteBtn?.addEventListener("click", openNotepad);

  function backdropClose(e){
    if(e.target===calcModal) closeCalculator();
    if(e.target===noteModal) closeNotepad();
  }
  calcModal?.addEventListener("click", backdropClose);
  noteModal?.addEventListener("click", backdropClose);

  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape"){ closeCalculator(); closeNotepad(); } });

  const saved=localStorage.getItem('seavo_note');
  if(saved) document.getElementById('noteArea').value=saved;

  makeDraggable('calcDragHandle','calculatorWindow');
  makeDraggable('noteDragHandle','notepadWindow');
});
  </script>
</body>
</html>