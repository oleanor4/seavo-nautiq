<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Supplies – Seavo Nautiq</title>
  <style>
    :root{
      --right-w: 420px;       /* fast bredde for høyre kolonne */
      --gap: 24px;            /* standard mellomrom i layout */
    }

    *{ box-sizing: border-box; }

    body {
      background-color: #0b264d;
      font-family: Arial, sans-serif;
      margin: 0;
      color: white;
      padding: 20px;
    }

    .video-header {
      position: relative;
      aspect-ratio: 1280 / 99;
      overflow: hidden;
      background-color: #000;
    }
    .video-header video {
      width: 100%;
      height: 200%;
      object-fit: cover;
      display: block;
    }

    .gradient-overgang {
      height: 10px;
      background: linear-gradient(to left, #62b2e7, #001125);
      box-shadow: 6px 4px 6px rgba(0, 0, 0, 0.7);
    }

    .logo {
      width: 200px;
      height: auto;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.6);
      cursor: pointer;
      margin-left: 60px;
    }
    .logo:hover {
      transform: scale(1.08);
      transition: transform 0.2s ease;
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
    }

    .Supplies {
      width: 100%;
      height: 160%;
      position: absolute;
      top: 0;
      left: 0%;
      z-index: -1;
      opacity: 0.1;
      pointer-events: none;
    }

    .summary-box{
      max-width: 300px;
      margin: 10px auto 14px;
      padding: 10px 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      display: flex;
      gap: 24px;
      justify-content: center;
      align-items: baseline;
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
    }
    .summary-box .metric{ display:flex; gap:8px; align-items: baseline; }
    .summary-box .num{ font-size: 26px; font-weight: 800; line-height:1; }
    .summary-box .label{ opacity:.8; font-weight:700; }

    /* === LAYOUT – fast 2-kolonne grid for stabilitet === */
    .layout{
      display: grid;
      grid-template-columns: minmax(740px, 1fr) var(--right-w);
      gap: var(--gap);
      align-items: start;
      margin-top: 16px;
    }

    .left-col{
      min-width: 740px; /* sikrer at venstre kolonne ikke krymper og forårsaker wrap */
    }

    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin: 10px 0 6px;
      flex-wrap: nowrap;    /* forhindrer at knapper hopper ned */
    }

    .btn {
      padding: 10px 16px;
      font-size: 15px;
      background: linear-gradient(to right,#62b2e7,#1b4f8f);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.35);
    }
    .btn:hover { filter: brightness(1.30); }
    .btn-danger { background: linear-gradient(to right,#f03747,#b61b26); }
    .btn-ghost {
      background: rgba(0,0,0,.2);
      color: #fff;
    }
    .btn-ghost:hover { background: rgba(0,0,0,.3); }

    .exportbar{
      display:flex; gap:12px; align-items:center; margin: 8px 0 12px;
    }
    .btn1 {
      padding: 6px 16px;
      font-size: 15px;
      background: linear-gradient(to right,#7e7ceb,#103d75);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.35);
    }
    .btn1:hover { filter: brightness(1.30); }

    /* Kortsamling fyller hele venstre kolonne, faste spalter */
    .cards {
      display: grid;
      grid-template-columns: 1fr; /* én spalte = symmetri */
      gap: 16px;
      margin-top: 4px;
      width: 95%;
      min-height: 80px; /* holder arealet stabilt før første kort */
    }

    .card {
      background: rgba(0,0,0,.15);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,.25);
      padding: 12px;
      width: 100%;     /* fyll alltid kolonnen – ingen hopp */
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .card-title {
      font-size: 18px;
      font-weight: bold;
      color: #e6f0ff;
      text-shadow: 0 1px 2px rgba(0,0,0,.4);
    }
    .card-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
    }

    /* Tabell inni kortet */
    .supply-table {
      width: 85%;
      border-collapse: collapse;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 10px;
      overflow: hidden;
      table-layout: fixed; /* viktig for faste bredder og stabilitet */
    }
    .supply-table th, .supply-table td {
      border-bottom: 1px solid rgba(255,255,255,.12);
      padding: 10px;
      text-align: left;
      vertical-align: middle;
      height: 44px; /* konsistent rad-høyde for symmetri */
    }
    .supply-table th {
      background: rgba(0, 0, 0, 0.411);
    }

    /* Faste kolonnebredder (stabile på tvers av alle kort) */
    .col-supply { width: 380px; }
    .col-qty    { width: 80px; }
    .col-comments { width: 350px; }
    .col-actions { width: 120px; }

    .row-actions {
      display: flex;
      gap: 6px;
    }
    .btn-small {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-small:hover { background-color: #b61b26; }

    /* Inputs i tabellen – samme høyde overalt for symmetri */
    .supply-input, .qty-input, .comments-input {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid rgba(241, 241, 241, 0.2);
      background: rgba(0, 0, 0, 0.226);
      color: #fff;
      box-sizing: border-box;
      height: 34px;            /* låst input-høyde */
      line-height: 18px;
    }

    /* Tom-tilstand */
    .empty {
      padding: 10px;
      opacity: .8;
      font-style: italic;
    }

    /* Høyre kolonne – crew-box står fast, flytter seg ikke horisontalt */
    .right-col{ position: relative; width: var(--right-w); }

    .reset-wrap { display:flex; justify-content:flex-end; margin-bottom: 8px; }
    .btn-reset {
      padding: 6px 10px;
      font-size: 13px;
      background: linear-gradient(to right,#f03747,#b61b26);
      color:#fff; border:none; border-radius:8px; cursor:pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.35);
      
    }
    .btn-reset:hover { filter: brightness(1.1); }

    .crew-box {
      width: 100%;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      position: sticky; top: 12px; /* holder seg på toppen ved scroll */
      margin-top: 68px;
    }
    .crew-box h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .crew-count {
      display: inline-block;
      min-width: 24px;
      padding: 2px 8px;
      font-weight: 800;
      text-align: center;
      border-radius: 999px;
      background: linear-gradient(to right,#62b2e7,#1b4f8f);
    }
    .crew-list {
      max-height: 400px;
      overflow: auto;
      display: grid;
      gap: 6px;
    }
    .crew-item {
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .crew-item .tag {
      font-size: 11px;
      opacity: .85;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.12);
    }

    /* Meta-felt i crew-box */
    .meta-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 8px 0 10px; }
    .meta-row label { font-size: 12px; opacity: .9; display:block; margin-bottom: 6px; }
    .meta-input {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(0,0,0,.2);
      color: #fff;
      box-sizing: border-box;
      height: 34px;
      line-height: 18px;
    }

    /* Skjul elementer merket no-print ved utskrift / print-PDF */
    @media print {
      .no-print { display: none !important; }
    }

    /* (Valgfritt) Respons: stack når skjermen er smalere, uten hopp */
    @media (max-width: 1180px){
      .layout{
        grid-template-columns: 1fr;
      }
      .left-col{ min-width: 0; }
      .right-col{ width: 100%; }
      .crew-box{ position: static; }
    }
  </style>
</head>
<body>
<header class="video-header">
  <video autoplay muted loop playsinline disablePictureInPicture>
    <source src="Video/Ocean-Seavo-Nautiq.mp4" type="video/mp4">
  </video>
</header>

<div class="gradient-overgang"></div>

  <header>
    <h1 style="text-align:center;color:rgb(218,215,215);margin-top:20px;font-size:36px;font-weight:bold;text-shadow:0 1px 3px rgba(0,0,0,.6);">
      Supplies
    </h1>

    <div>
      <a href="index.html" class="logo-link">
        <img src="images/Logo Seavo Nautiq.png" alt="Logo Seavo Nautiq" class="logo">
      </a>
    </div>

    <div class="summary-box" id="summaryBox" aria-live="polite">
      <div class="metric">
        <span class="num" id="crewCount">0</span>
        <span class="label">Crew</span>
      </div>
      <div class="metric">
        <span class="num" id="lineCount">0</span>
        <span class="label">Lines</span>
      </div>
    </div>

    <img src="images/Supplies.png" alt="Supplies" class="Supplies">
  </header>

  <!-- FAST 2-KOLONNE LAYOUT -->
  <div class="layout">
    <!-- Venstre kolonne -->
    <section class="left-col">
      <div class="toolbar">
        <button class="btn" id="openPickerBtn">Add Participant/Crew</button>
      </div>

      <div class="exportbar">
        <button class="btn1" id="exportPdfBtn">Export PDF (B/W)</button>
        <button class="btn1" id="exportExcelBtn">Export Excel</button>
      </div>

      <div id="cards" class="cards"></div>
    </section>

    <!-- Høyre kolonne (står i ro) -->
    <aside class="right-col no-print">
      <div class="reset-wrap">
        <button class="btn-reset" id="resetAllBtn" title="Remove all lines from all crew">Reset lines</button>
      </div>

      <div class="crew-box" id="crewBox" aria-live="polite">
        <h3>Participants <span class="crew-count" id="crewBadge">0</span></h3>

        <!-- Voyage meta -->
        <div class="meta-row">
          <div>
            <label for="voyageNameInput">Voyage name</label>
            <input id="voyageNameInput" class="meta-input" placeholder="Voyage name">
          </div>
          <div>
            <label for="startDateInput">Start date</label>
            <input id="startDateInput" class="meta-input" type="date">
          </div>
        </div>

        <div class="crew-list" id="crewList">
          <!-- Fylles dynamisk -->
        </div>
      </div>
    </aside>
  </div>

  <!-- Legg denne script-taggen nederst på hver side (før dine side-spesifikke skript) -->
  <script src="seavo-core.js"></script>

  <!-- jsPDF + AutoTable (for PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
    /** KEYS */
    const PKEY   = 'participants_v1';          // (ikke brukt direkte her)
    const BOXKEY = 'supplies_boxes_v1';        // lagring av kort og rader
    const PICKKEY= 'selected_for_supplies';    // utvalg fra picker
    const METAKEY= 'supplies_meta_v1';         // Voyage name + Start date

    /** Hjelpere */
    const $ = sel => document.querySelector(sel);
    const el = (tag, cls) => { const x = document.createElement(tag); if (cls) x.className = cls; return x; };

    function loadJSON(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
      catch { return fallback; }
    }
    function saveJSON(key, val) {
      localStorage.setItem(key, JSON.stringify(val));
    }

    /** Dataformat:
     * boxes = [
     *  { participantUid, participantName, lines: [{supply, qty, comments}] }
     * ]
     */
    let boxes = loadJSON(BOXKEY, []);
    let meta  = loadJSON(METAKEY, { voyageName:'', startDate:'' });

    /** Render hele kortlisten */
    function renderAll() {
      const wrap = $('#cards');
      wrap.innerHTML = '';
      if (!boxes.length) {
        const empty = el('div', 'empty');
        empty.textContent = 'No participants added yet. Click "Add Participant" to begin.';
        wrap.appendChild(empty);
      } else {
        boxes.forEach((box, idx) => wrap.appendChild(renderCard(box, idx)));
      }
      updateSummaryBox();
      renderCrewBox();
      hydrateMetaInputs();
    }

    function persistAndRender() {
      saveJSON(BOXKEY, boxes);
      renderAll();
    }

    // Etter init
    document.addEventListener('DOMContentLoaded', () => {
      renderAll();
      updateSummaryBox();
      renderCrewBox();
      hydrateMetaInputs();
      bindReset();
      bindMetaInputs();
    });

    /** Meta inputs visning/lagring */
    function hydrateMetaInputs(){
      const v = $('#voyageNameInput');
      const d = $('#startDateInput');
      if (v) v.value = meta.voyageName || '';
      if (d) d.value = meta.startDate || '';
    }
    function bindMetaInputs(){
      const v = $('#voyageNameInput');
      const d = $('#startDateInput');
      if (v) v.addEventListener('input', e => { meta.voyageName = e.target.value; saveJSON(METAKEY, meta); });
      if (d) d.addEventListener('input', e => { meta.startDate  = e.target.value; saveJSON(METAKEY, meta); });
    }

    /** Reset alle linjer (beholder crew-kortene) */
    function bindReset(){
      const btn = $('#resetAllBtn');
      if (!btn) return;
      btn.addEventListener('click', () => {
        if (!boxes.length) return;
        if (!confirm('Remove all lines from all crew cards?')) return;
        boxes = boxes.map(b => ({ ...b, lines: [] }));
        persistAndRender();
      });
    }

    /** Render ett kort (deltakerboks med tabell) */
    function renderCard(box, idx) {
      const card = el('div', 'card');

      // Header
      const header = el('div', 'card-header');
      const title = el('div', 'card-title');
      title.textContent = `Crew member: ${box.participantName}`;
      const actions = el('div', 'card-actions');
      const addBtn = el('button', 'btn btn-small');
      addBtn.textContent = 'Add supply line';
      addBtn.onclick = () => { addLine(idx); };

      const delBtn = el('button', 'btn btn-small btn-danger');
      delBtn.textContent = 'Delete Crew';
      delBtn.onclick = () => { deleteCard(idx); };

      actions.append(addBtn, delBtn);
      header.append(title, actions);

      // Table
      const table = el('table', 'supply-table');
      const thead = el('thead');
      const trh = el('tr');

      trh.innerHTML = `
        <th class="col-supply">Supply</th>
        <th class="col-qty">Qty</th>
        <th class="col-comments">Comments</th>
        <th class="col-actions">Actions</th>
      `;
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = el('tbody');

      if (!box.lines || !box.lines.length) {
        const trEmpty = el('tr');
        const tdEmpty = el('td');
        tdEmpty.colSpan = 4;
        tdEmpty.className = 'empty';
        tdEmpty.textContent = 'No lines yet. Click "Add supply line".';
        trEmpty.appendChild(tdEmpty);
        tbody.appendChild(trEmpty);
      } else {
        box.lines.forEach((ln, ridx) => {
          const tr = el('tr');

          const tdSupply = el('td');
          const inpSupply = el('input', 'supply-input');
          inpSupply.value = ln.supply ?? '';
          inpSupply.oninput = e => updateCell(idx, ridx, 'supply', e.target.value);
          tdSupply.appendChild(inpSupply);

          const tdQty = el('td');
          const inpQty = el('input', 'qty-input');
          inpQty.type = 'number';
          inpQty.step = '1';
          inpQty.min = '0';
          inpQty.value = ln.qty ?? '';
          inpQty.oninput = e => updateCell(idx, ridx, 'qty', e.target.value);
          tdQty.appendChild(inpQty);

          const tdComments = el('td');
          const inpComments = el('input', 'comments-input');
          inpComments.placeholder = 'Notes, lot, etc.';
          inpComments.value = ln.comments ?? '';
          inpComments.oninput = e => updateCell(idx, ridx, 'comments', e.target.value);
          tdComments.appendChild(inpComments);

          const tdAct = el('td');
          const rowBtns = el('div', 'row-actions');
          const delRow = el('button', 'btn-small btn-ghost');
          delRow.textContent = 'Delete';
          delRow.onclick = () => deleteLine(idx, ridx);
          rowBtns.appendChild(delRow);
          tdAct.appendChild(rowBtns);

          tr.append(tdSupply, tdQty, tdComments, tdAct);
          tbody.appendChild(tr);
        });
      }
      table.appendChild(tbody);

      card.append(header, table);
      return card;
    }

    function addLine(cardIndex) {
      boxes[cardIndex].lines = boxes[cardIndex].lines || [];
      boxes[cardIndex].lines.push({ supply: '', qty: '', comments: '' });
      persistAndRender();
    }
    function deleteLine(cardIndex, rowIndex) {
      boxes[cardIndex].lines.splice(rowIndex, 1);
      persistAndRender();
    }
    function deleteCard(cardIndex) {
      if (!confirm('Delete this participant and all lines?')) return;
      boxes.splice(cardIndex, 1);
      persistAndRender();
    }
    function updateCell(cardIndex, rowIndex, key, val) {
      boxes[cardIndex].lines[rowIndex][key] = val;
      saveJSON(BOXKEY, boxes);
    }

    /** Åpne picker (participants.html i plukkemodus) */
    $('#openPickerBtn').addEventListener('click', () => {
      localStorage.removeItem(PICKKEY); // rydd forrige utvalg
      window.open('participants.html?pick=1', 'participantPicker',
        'width=1000,height=800,noopener=yes');

      waitForPicked(); // Poll resultat fra picker
    });

    /** Poller lokalStorage etter valgt liste */
    function waitForPicked() {
      const start = Date.now();
      const timer = setInterval(() => {
        const raw = localStorage.getItem(PICKKEY);
        if (raw) {
          clearInterval(timer);
          const picked = JSON.parse(raw);
          localStorage.removeItem(PICKKEY);
          addPickedParticipants(picked);
        } else {
          if (Date.now() - start > 5 * 60 * 1000) clearInterval(timer); // fail-safe 5min
        }
      }, 500);
    }

    /** Legg til valgte deltakere som nye kort (unngå duplikater) */
    function addPickedParticipants(pickedArr) {
      if (!Array.isArray(pickedArr)) return;
      pickedArr.forEach(p => {
        if (!boxes.some(b => b.participantUid === p.uid)) {
          boxes.push({
            participantUid: p.uid,
            participantName: p.name,
            lines: [{ supply: '', qty: '', comments: '' }],
          });
        }
      });
      persistAndRender();
    }

    function countTotalLines(){
      return (boxes || []).reduce((sum, b) => sum + (b.lines?.length || 0), 0);
    }
    function updateSummaryBox(){
      const crewEl = document.getElementById('crewCount');
      const lineEl = document.getElementById('lineCount');
      if(!crewEl || !lineEl) return;
      crewEl.textContent = (boxes || []).length;
      lineEl.textContent = countTotalLines();
    }

    /* === Participants-boks på høyre side === */
    function renderCrewBox() {
      const listEl = document.getElementById('crewList');
      const badge = document.getElementById('crewBadge');
      if (!listEl || !badge) return;

      const names = (boxes || []).map(b => b.participantName).filter(Boolean);
      badge.textContent = names.length;

      listEl.innerHTML = '';
      if (!names.length) {
        const empty = document.createElement('div');
        empty.className = 'crew-item';
        empty.textContent = 'No participants yet.';
        listEl.appendChild(empty);
        return;
      }

      names.forEach((name, i) => {
        const item = document.createElement('div');
        item.className = 'crew-item';
        const span = document.createElement('span');
        span.textContent = name;
        const tag = document.createElement('span');
        tag.className = 'tag';
        tag.textContent = `#${i+1}`;
        item.append(span, tag);
        listEl.appendChild(item);
      });
    }

    // ==== EXPORT: PDF (Svart/Hvitt) ====
    document.getElementById('exportPdfBtn').addEventListener('click', exportSuppliesPDF);

    async function exportSuppliesPDF() {
      if (!boxes.length) { alert('No data to export.'); return; }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      let cursorY = 40; // startposisjon

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0); // svart

      // Tittel
      doc.setFontSize(16);
      doc.text('Seavo Nautiq – Supplies', 40, cursorY);
      cursorY += 12;

      // Meta (Voyage + Start) rett under logo/overskrift
      doc.setFontSize(10);
      const vName = (meta.voyageName || '').toString();
      const sDate = (meta.startDate  || '').toString();
      if (vName) { doc.text(`Voyage: ${vName}`, 40, cursorY); cursorY += 12; }
      if (sDate) { doc.text(`Start date: ${sDate}`, 40, cursorY); cursorY += 12; }

      const dateStr = new Date().toISOString().slice(0,16).replace('T',' ');
      doc.text(`Generated: ${dateStr}`, 40, cursorY);
      cursorY += 16;

      // Per deltaker-boks
      boxes.forEach((box, idx) => {
        // Seksjonstittel
        doc.setFontSize(12);
        doc.setTextColor(0,0,0);
        doc.text(`Participant: ${box.participantName || ''}`, 40, cursorY);
        cursorY += 10;

        // Bygg tabell-data (kun datafelt – ingen actions/knapper)
        const head = [['Supply', 'Qty', 'Comments']];
        const body = (box.lines && box.lines.length)
          ? box.lines.map(ln => [
              (ln.supply ?? '').toString(),
              (ln.qty ?? '').toString(),
              (ln.comments ?? '').toString()
            ])
          : [['', '', '']];

        doc.autoTable({
          head,
          body,
          startY: cursorY,
          theme: 'grid',
          styles: {
            font: 'helvetica',
            fontSize: 9,
            textColor: [0,0,0],
            lineColor: [0,0,0],
            lineWidth: 0.5,
            fillColor: [255,255,255],
          },
          headStyles: {
            fillColor: [230,230,230],
            textColor: [0,0,0],
            lineColor: [0,0,0],
            lineWidth: 0.5
          },
          alternateRowStyles: { fillColor: [245,245,245] },
          margin: { left: 40, right: 40 },
        });

        cursorY = doc.lastAutoTable.finalY + 16;

        // Sideskift hvis lite plass igjen
        if (idx < boxes.length - 1 && cursorY > (doc.internal.pageSize.getHeight() - 120)) {
          doc.addPage();
          cursorY = 40;
        }
      });

      doc.save('Supplies_BW.pdf');
    }

    // ==== EXPORT: Excel (CSV med semikolon) ====
    document.getElementById('exportExcelBtn').addEventListener('click', exportSuppliesCSV);

    function exportSuppliesCSV() {
      if (!boxes.length) { alert('No data to export.'); return; }

      // Kolonner oppdatert: Comments erstatter Voyage/Date
      const headers = ['Participant','Supply','Qty','Comments'];

      // Samle rader (en rad per linje i alle bokser)
      const rows = [headers];

      boxes.forEach(box => {
        const participant = sanitizeCSV(box.participantName ?? '');

        if (box.lines && box.lines.length) {
          box.lines.forEach(ln => {
            rows.push([
              participant,
              sanitizeCSV(ln.supply ?? ''),
              sanitizeCSV(ln.qty ?? ''),
              sanitizeCSV(ln.comments ?? '')
            ]);
          });
        } else {
          rows.push([participant, '', '', '']);
        }

        // Visuell luft mellom deltakere (tom linje)
        rows.push(['','','','']);
      });

      // Fjern siste ekstra tomlinje
      if (rows.length && rows[rows.length - 1].every(c => c === '')) {
        rows.pop();
      }

      // Bygg CSV med semikolon + BOM + "sep=;" for Excel
      const DELIM = ';';
      const csvBody = rows.map(r => r.map(csvEscape).join(DELIM)).join('\r\n');
      const csvWithSep = 'sep=;\r\n' + csvBody;
      const blob = new Blob(['\uFEFF' + csvWithSep], { type: 'text/csv;charset=utf-8;' });

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Supplies.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function sanitizeCSV(v) {
      return (v ?? '').toString().trim();
    }
    function csvEscape(field) {
      const f = field.toString();
      if (/[\";\r\n]/.test(f)) {
        return '"' + f.replace(/"/g, '""') + '"';
      }
      return f;
    }
  </script>
</body>
</html>