<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Disposal – Seavo Nautiq</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Core (for aktivitetlogg etc.) -->
  <script src="./js/seavo-core.js" defer></script>

  <style>
    :root{
      --bg:#0f2a4a; --text:#ffffff; --muted:#bcd3f1;
      --accent:#62b2e7; --accent-2:#1b75d1; --accent-3:#0e3e86;
      --danger:#f03747; --warn:#ecc543; --ok:#28e755;
    }
    *{ box-sizing:border-box }
    body{ background:var(--bg); color:var(--text); font-family:Arial,sans-serif; margin:0 }

    /* Header-video + gradient */
    .video-header{ position:relative; aspect-ratio:1280/99; overflow:hidden; background:#000 }
    .video-header video{ width:100%; height:200%; object-fit:cover; display:block }
    .gradient-overgang{ height:10px; background:linear-gradient(to left,#62b2e7,#001125); box-shadow:6px 4px 6px rgba(0,0,0,.7) }

    h1{
      text-align:center; margin:20px 0 8px; font-size:36px; font-weight:bold; color:#dad7d7;
      text-shadow:0 1px 3px rgba(0,0,0,.6);
    }

  

    /* Panel / kort */
    .panel{
      background:rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      box-shadow:0 12px 28px rgba(0,0,0,.35);
    }

    /* Top toolbar + stats */
    .toolbar{
      max-width:1400px; margin:12px auto; padding:12px;
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    }
    .btn{
      padding:10px 16px; border:none; border-radius:12px; cursor:pointer; font-weight:700; font-size:14px;
      background:linear-gradient(to right,var(--accent-2),var(--accent-3)); color:#fff;
      border:1px solid rgba(255,255,255,.12); box-shadow:0 6px 16px rgba(0,0,0,.35);
    }
    .btn:hover{ filter:brightness(1.15) }
    .btn-ghost{ background:rgba(255,255,255,.12) }
    .btn-danger{ background:linear-gradient(to right,#f13e4e,#a31621) }

    .stats{
      max-width:300px; margin:0 auto 10px; padding:10px 14px;
      border:1px solid rgba(255,255,255,.12); border-radius:12px;
      background:rgba(0,0,0,.18); display:flex; gap:18px; justify-content:center; align-items:baseline;
    }
    .stat{ display:flex; gap:8px; align-items:baseline }
    .stat .num{ font-size:22px; font-weight:800 }

    /* Layout: tabell venstre, completed-boks høyre */
    .layout{
      max-width:1600px; margin:0 auto 24px; padding:0 12px;
      display:grid; grid-template-columns:minmax(0,1fr) 320px; gap:16px; align-items:start;
    }
    @media(max-width:1100px){ .layout{ grid-template-columns:1fr } }

    /* Table */
    table{
      width:100%; border-collapse:collapse; background:rgba(0,0,0,.20); color:var(--text);
      border:1px solid rgba(255,255,255,.12); border-radius:14px; overflow:hidden;
      box-shadow:0 12px 28px rgba(0,0,0,.35);
    }
    th,td{ border-bottom:1px solid rgba(255,255,255,.12); padding:8px; text-align:center; font-size:16px }
    th{ background:rgba(0,0,0,.28) }

    input[type="text"], input[type="number"], input[type="date"], select{
      width:95%; padding:8px 10px; border-radius:10px; background:rgba(0,0,0,.25); color:var(--text);
      border:1px solid rgba(255,255,255,.18); font-size:14px; font-weight:700; outline:none;
    }
    input:focus, select:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(98,178,231,.18) }

    .move-btns{ display:flex; gap:6px; justify-content:center }
    .move-btns .btn{ padding:6px 10px; border-radius:10px }

    /* Condition farger */
    .condition-defective select{ background:#e9a250 !important; color:#000 }
    .condition-worn select{ background:#8dd453 !important; color:#000 }
    .condition-lost select{ background:#1ba895 !important; color:#fff }
    .condition-discarded select{ background:#293c3d !important; color:#fff }

    /* Completed panel (sticky) */
    .completed-panel{ position:sticky; top:16px; }
    .completed-box{ padding:12px }
    .completed-box h3{ margin:0 0 10px; font-size:18px }
    .completed-list{ display:grid; gap:10px }
    .completed-card{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      padding:10px; display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center;
    }
    .completed-title{ font-weight:800 }
    .meta{ font-size:12px; color:var(--muted) }
    .badge{ display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.2) }
    .badge.defective{ background:#e9a150; color:#111 }
    .badge.worn{ background:#8dd453; color:#111 }
    .badge.lost{ background:#1ba895; color:#fff }
    .badge.discarded{ background:#293c3d; color:#fff }

    /* Image modal */
    #imageModal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:1000; place-items:center }
    #imageModal.show{ display:grid }
    #imageModal .close{ position:absolute; top:18px; right:24px; font-size:30px; cursor:pointer }
    #modalImage{ max-width:92vw; max-height:86vh; border:4px solid #fff; border-radius:8px; box-shadow:0 20px 60px rgba(0,0,0,.6) }

    /* Gjør Product (kolonne 2) og Comments (kolonne 5) ~3× bredere */
table thead th:nth-child(2),
table tbody td:nth-child(2),
table thead th:nth-child(5),
table tbody td:nth-child(5){
  width: 18%;           /* juster evt. til 30% om du vil enda bredere */
}

/* La inputs fylle cellene helt */
input[type="text"], input[type="number"], input[type="date"], select{
  width: 100%;          /* var 95%; gir litt mer luft til brede kolonner */
}

/* Mindre "Mark completed"-knapp */
.btn-sm{
  padding: 4px 6px;
  font-size: 10px;
  border-radius: 10px;
}


    /* Print */
    @media print{
      body{ background:#fff; color:#000 }
      .video-header,.gradient-overgang,.toolbar,.stats,.completed-panel{ display:none !important }
      table{ background:#fff; color:#000; box-shadow:none; border:1px solid #ccc }
      th{ background:#f2f2f2; color:#000 }
    }
  </style>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <header class="video-header">
    <video autoplay muted loop playsinline>
      <source src="Video/Ocean-Seavo-Nautiq.mp4" type="video/mp4" />
    </video>
  </header>
  <div class="gradient-overgang"></div>

  

  <h1>Disposal</h1>

  <!-- Toolbar -->
  <div class="toolbar">
    <button class="btn" id="btnAddLine">+ Add Line</button>
    <button class="btn" id="btnAddHeader">+ Add Header Section</button>
    <button class="btn" id="btnExportPdf">📄 Export PDF</button>
    <button class="btn btn-ghost" id="btnClearAll">Reset table</button>
  </div>

  <!-- Stats -->
  <div class="stats panel" id="statsBox" aria-live="polite">
    <div class="stat"><span class="num" id="statActive">0</span> Active</div>
    <div class="stat"><span class="num" id="statCompleted">0</span> Completed</div>
  </div>

  <!-- Layout -->
  <div class="layout">
    <!-- Left: table -->
    <div class="panel">
      <table>
        <thead>
          <tr>
            <th style="width:130px">Date</th>
            <th>Product</th>
            <th style="width:110px">Number</th>
            <th style="width:150px">Condition</th>
            <th>Comments</th>
            <th style="width:140px">Completed</th>
            <th style="width:120px">📸 Image</th>
            <th style="width:130px">Move</th>
            <th style="width:80px">Delete</th>
          </tr>
        </thead>
        <tbody id="disposalBody"><!-- filled dynamically --></tbody>
      </table>
    </div>

    <!-- Right: Completed -->
    <aside class="completed-panel">
      <div class="panel completed-box">
        <h3>Completed</h3>
        <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap">
          <button class="btn btn-ghost" id="btnClearCompleted">Clear completed</button>
        </div>
        <div id="completedList" class="completed-list"><!-- items --></div>
      </div>
    </aside>
  </div>

  <!-- Image modal -->
  <div id="imageModal" role="dialog" aria-modal="true">
    <span class="close" onclick="closeModal()">✖</span>
    <img id="modalImage" src="" alt="Preview" />
  </div>

  <script>
  /* =========================
     STORAGE KEYS + HELPERS
     ========================= */
  const LS_ROWS = 'sn.disposal.rows.v1';
  const LS_DONE = 'sn.disposal.completed.v1';

  const $ = (sel)=>document.querySelector(sel);
  const escapeHtml = (s)=> (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function loadJSON(k, fb){ try{ return JSON.parse(localStorage.getItem(k)) ?? fb }catch{ return fb } }
  function saveJSON(k, v){ localStorage.setItem(k, JSON.stringify(v)) }

  function seavoLog(text){
    if(window.seavo && typeof seavo.logActivity==='function'){
      seavo.logActivity({ text, source:'Disposal', type:'action' });
    }
  }

  /* =========================
     STATE
     ========================= */
  // rows: [{type:'row'|'header', id, date, product, number, condition, comments, image}]
  let rows = loadJSON(LS_ROWS, []);
  let completed = loadJSON(LS_DONE, []);

  /* =========================
     RENDER
     ========================= */
  function render(){
    const tbody = $('#disposalBody');
    tbody.innerHTML = '';

    rows.forEach(r=>{
      if(r.type==='header'){
        const tr = document.createElement('tr');
        tr.dataset.id = r.id;
        tr.innerHTML = `
          <td colspan="7" class="header-cell" contenteditable="true" style="text-align:left; font-weight:800; background:rgba(255,255,255,.08)">
            ${escapeHtml(r.text||'New Section Header')}
          </td>
          <td class="move-btns">
            <button class="btn" data-act="up">↑</button>
            <button class="btn" data-act="down">↓</button>
          </td>
          <td><button class="btn btn-danger" data-act="delete">🗑️</button></td>
        `;
        tbody.appendChild(tr);
        return;
      }

      const tr = document.createElement('tr');
      tr.dataset.id = r.id;

      // condition class on td for color
      const condCls = condClass(r.condition);
      tr.innerHTML = `
        <td><input type="date" value="${r.date||''}" data-key="date"></td>
        <td><input type="text" value="${escapeAttr(r.product)}" placeholder="Product" data-key="product"></td>
        <td><input type="number" min="0" value="${r.number||''}" data-key="number"></td>
        <td class="${condCls}">
          <select data-key="condition">
            <option value=""></option>
            <option value="Defective"${r.condition==='Defective'?' selected':''}>Defective</option>
            <option value="Worn"${r.condition==='Worn'?' selected':''}>Worn</option>
            <option value="Lost"${r.condition==='Lost'?' selected':''}>Lost</option>
            <option value="Discarded"${r.condition==='Discarded'?' selected':''}>Discarded</option>
          </select>
        </td>
        <td><input type="text" value="${escapeAttr(r.comments)}" placeholder="Comments" data-key="comments"></td>
        <td>
          <button class="btn ok btn-sm" data-act="complete">Mark completed ✅</button>
        </td>
        <td>
          <div style="display:flex; flex-direction:column; align-items:center; gap:6px">
            <button class="btn" data-act="upload">Upload</button>
            <img src="${r.image||''}" alt="" style="max-width:40px; max-height:40px; display:${r.image?'block':'none'}; cursor:pointer" data-act="preview">
            <input type="file" accept="image/*" style="display:none" data-file>
          </div>
        </td>
        <td class="move-btns">
          <button class="btn" data-act="up">↑</button>
          <button class="btn" data-act="down">↓</button>
        </td>
        <td><button class="btn btn-danger" data-act="delete">🗑️</button></td>
      `;
      tbody.appendChild(tr);
    });

    renderCompleted();
    updateStats();
    saveAll(); // persist current state
  }

  function renderCompleted(){
    const list = $('#completedList');
    if(!completed.length){
      list.innerHTML = `<div class="meta">No completed items yet.</div>`;
      $('#statCompleted').textContent = '0';
      return;
    }
    list.innerHTML = '';
    completed.forEach((it, i)=>{
      const div = document.createElement('div');
      div.className = 'completed-card';
      const badge = badgeClass(it.condition);
      const when = formatDateTime(it.completedAt);
      div.innerHTML = `
        <div>
          <div class="completed-title">${escapeHtml(it.product||'(no product)')}</div>
          <div class="meta">
            <span class="badge ${badge}">${escapeHtml(it.condition||'–')}</span>
            &nbsp;•&nbsp; Completed: ${when}
          </div>
        </div>
        <div style="display:flex; gap:8px">
          ${it.image ? `<button class="btn" data-act="viewDone" data-index="${i}">View</button>`:''}
          <button class="btn btn-ghost" data-act="undo" data-index="${i}">Undo</button>
          <button class="btn btn-danger" data-act="removeDone" data-index="${i}">🗑️</button>
        </div>
      `;
      list.appendChild(div);
    });
    $('#statCompleted').textContent = String(completed.length);
  }

  function updateStats(){
    const activeCount = rows.filter(r=>r.type==='row').length;
    $('#statActive').textContent = String(activeCount);
  }

  /* =========================
     EVENTS (delegert)
     ========================= */
  document.addEventListener('DOMContentLoaded', ()=>{
    // init
    if(rows.length===0){ addLine(); } // start med én tom linje
    render();

    // top buttons
    $('#btnAddLine').addEventListener('click', ()=> addLine());
    $('#btnAddHeader').addEventListener('click', ()=> addHeader());
    $('#btnExportPdf').addEventListener('click', exportPDF);
    $('#btnClearAll').addEventListener('click', resetAll);
    $('#btnClearCompleted').addEventListener('click', clearCompleted);

    // table interactions
    $('#disposalBody').addEventListener('click', onTableClick);
    $('#disposalBody').addEventListener('change', onTableChange);
    // contenteditable headers
    $('#disposalBody').addEventListener('input', (e)=>{
      const cell = e.target.closest('.header-cell');
      if(!cell) return;
      const tr = e.target.closest('tr');
      const id = tr?.dataset.id;
      const h = rows.find(x=>x.id===id);
      if(h){ h.text = cell.innerText.trim(); saveAll(); }
    });

    // completed panel interactions
    $('#completedList').addEventListener('click', onCompletedClick);
  });

  function onTableClick(e){
    const btn = e.target.closest('button');
    if(!btn) return;
    const tr = e.target.closest('tr');
    const id = tr?.dataset.id;
    const r = rows.find(x=>x.id===id);
    const act = btn.dataset.act;

    if(act==='up' || act==='down'){
      moveRow(id, act==='up' ? -1 : +1);
      return;
    }
    if(act==='delete'){
      deleteById(id);
      return;
    }
    if(act==='complete'){
      markCompletedById(id);
      return;
    }
    if(act==='upload'){
      tr.querySelector('[data-file]').click();
      return;
    }
  }

  function onTableChange(e){
    const tr = e.target.closest('tr'); if(!tr) return;
    const id = tr.dataset.id;
    const r = rows.find(x=>x.id===id); if(!r) return;

    // file input?
    if(e.target.matches('[data-file]')){
      const file = e.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev)=>{
        r.image = ev.target.result;
        seavoLog(`Image uploaded for "${r.product||'(no product)'}"`);
        render(); // re-render to show preview
      };
      reader.readAsDataURL(file);
      return;
    }

    // preview click handled in click via [data-act="preview"]
    if(e.target.matches('select[data-key="condition"]')){
      r.condition = e.target.value;
      seavoLog(`Condition set to "${r.condition||'—'}" for "${r.product||'(no product)'}"`);
      render(); // to refresh condition color
      return;
    }

    // regular inputs
    const key = e.target.dataset.key;
    if(key){
      r[key] = e.target.value;
      saveAll();
    }
  }

  // image preview (click on img)
  document.addEventListener('click', (e)=>{
    const prev = e.target.closest('img[data-act="preview"]');
    if(prev && prev.src){ openModal(prev.src); }
  });

  function onCompletedClick(e){
    const btn = e.target.closest('button');
    if(!btn) return;
    const act = btn.dataset.act;
    const idx = Number(btn.dataset.index);
    if(act==='undo'){
      undoCompleted(idx);
      return;
    }
    if(act==='removeDone'){
      if(confirm('Remove from completed?')){ completed.splice(idx,1); saveAll(); render(); }
      return;
    }
    if(act==='viewDone'){
      const it = completed[idx];
      if(it?.image) openModal(it.image);
    }
  }

  /* =========================
     ACTIONS
     ========================= */
  function addLine(data={}){
    rows.push({
      type:'row',
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()),
      date: data.date || '',
      product: data.product || '',
      number: data.number || '',
      condition: data.condition || '',
      comments: data.comments || '',
      image: data.image || ''
    });
    seavoLog('Added disposal line');
    render();
  }

  function addHeader(text='New Section Header'){
    rows.push({ type:'header', id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()), text });
    seavoLog('Added disposal section');
    render();
  }

  function deleteById(id){
    const i = rows.findIndex(x=>x.id===id);
    if(i>=0){
      const wasHeader = rows[i].type==='header';
      seavoLog(`Deleted ${wasHeader?'section':'line'} "${rows[i].product||rows[i].text||''}"`);
      rows.splice(i,1);
      render();
    }
  }

  function moveRow(id, dir){
    const i = rows.findIndex(x=>x.id===id);
    if(i<0) return;
    const j = i + dir;
    if(j<0 || j>=rows.length) return;
    const [it] = rows.splice(i,1);
    rows.splice(j,0,it);
    render();
  }

  function markCompletedById(id){
    const i = rows.findIndex(x=>x.id===id);
    if(i<0) return;
    const r = rows[i];
    if(r.type!=='row') return;
    rows.splice(i,1);
    completed.push({
      product:r.product, condition:r.condition, image:r.image,
      completedAt: new Date().toISOString()
    });
    seavoLog(`Marked completed: "${r.product||'(no product)'}"`);
    render();
  }

  function undoCompleted(index){
    const it = completed.splice(index,1)[0];
    if(!it) return;
    addLine({
      date:'', product: it.product, number:'', condition: it.condition, comments:'', image: it.image
    });
    seavoLog(`Undo completed: "${it.product||'(no product)'}"`);
    saveAll();
    render();
  }

  function resetAll(){
    if(!confirm('Reset table (active rows only)? Completed list kept.')) return;
    rows = [];
    seavoLog('Reset Disposal table');
    render();
  }

  function clearCompleted(){
    if(!completed.length) return;
    if(!confirm('Clear all completed items?')) return;
    completed = [];
    seavoLog('Cleared completed in Disposal');
    render();
  }

  /* =========================
     SAVE/LOAD
     ========================= */
  function saveAll(){
    saveJSON(LS_ROWS, rows);
    saveJSON(LS_DONE, completed);
  }

  /* =========================
     UTILS
     ========================= */
  function condClass(v){
    switch((v||'').toLowerCase()){
      case 'defective': return 'condition-defective';
      case 'worn': return 'condition-worn';
      case 'lost': return 'condition-lost';
      case 'discarded': return 'condition-discarded';
      default: return '';
    }
  }
  function badgeClass(v){
    switch((v||'').toLowerCase()){
      case 'defective': return 'defective';
      case 'worn': return 'worn';
      case 'lost': return 'lost';
      case 'discarded': return 'discarded';
      default: return '';
    }
  }
  function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;') }
  function formatDateTime(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString(undefined,{ year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }catch{ return iso||'' }
  }

  /* =========================
     IMAGE MODAL
     ========================= */
  function openModal(src){
    const m = $('#imageModal'); $('#modalImage').src = src; m.classList.add('show');
  }
  function closeModal(){ $('#imageModal').classList.remove('show'); }

  /* =========================
     PDF EXPORT
     ========================= */
  function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });

    doc.setFont('helvetica','bold'); doc.setFontSize(16);
    doc.text('Seavo Nautiq — Disposal Report', 40, 40);
    doc.setFont('helvetica','normal'); doc.setFontSize(1);
    doc.text('Generated: ' + new Date().toLocaleString(), 40, 58);

    // Build active table (expand headers as separators)
    const activeRows = rows.slice();
    const body = [];
    activeRows.forEach(item=>{
      if(item.type==='header'){
        body.push([`--- ${item.text||'Section'} ---`, '', '', '', '', '']);
      }else{
        body.push([
          item.date||'',
          item.product||'',
          item.number||'',
          item.condition||'',
          item.comments||'',
          item.image ? ' ' : '' // place for thumb
        ]);
      }
    });

    let startY = 80;
    doc.autoTable({
      startY,
      head: [['Date','Product','Number','Condition','Comments','Image']],
      body,
      theme:'grid',
      styles:{ font:'helvetica', textColor:[0,0,0], lineColor:[0,0,0], lineWidth:0.5, fillColor:false, fontSize:9 },
      headStyles:{ fillColor:false, textColor:[0,0,0], fontStyle:'bold' },
      alternateRowStyles:{ fillColor:false },
      didDrawCell:(data)=>{
        if(data.section==='body' && data.column.index===5){
          const idx = data.row.index;
          // Map body index back to activeRows (same order)
          const it = activeRows[idx];
          if(it && it.type==='row' && it.image){
            const type = it.image.startsWith('data:image/png')?'PNG'
                        : (it.image.startsWith('data:image/jpeg')||it.image.startsWith('data:image/jpg'))?'JPEG':null;
            if(type){
              const max = 20;
              const x = data.cell.x + 4;
              const y = data.cell.y + (data.cell.height - max)/2;
              try{ doc.addImage(it.image, type, x, y, max, max); }catch{}
            }else{
              doc.setFontSize(8);
              doc.text('IMG', data.cell.x + 4, data.cell.y + data.cell.height/2 + 3);
              doc.setFontSize(9);
            }
          }
        }
      }
    });

    startY = doc.lastAutoTable.finalY + 22;

    // Completed table
    if(completed.length){
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('Completed', 40, startY);
      startY += 8;
      const cBody = completed.map(it=>[
        it.product||'', it.condition||'', formatDateTime(it.completedAt||'')
      ]);
      doc.autoTable({
        startY: startY+6,
        head: [['Product','Condition','Completed on']],
        body: cBody,
        theme:'grid',
        styles:{ font:'helvetica', textColor:[0,0,0], lineColor:[0,0,0], lineWidth:0.5, fillColor:false, fontSize:9 },
        headStyles:{ fillColor:false, textColor:[0,0,0], fontStyle:'bold' },
        alternateRowStyles:{ fillColor:false }
      });
    }else{
      doc.setFont('helvetica','italic'); doc.setFontSize(10);
      doc.text('No completed items.', 40, startY);
    }

    // footer pages
    const pages = doc.getNumberOfPages();
    for(let i=1;i<=pages;i++){
      doc.setPage(i);
      const t = `Page ${i} of ${pages}`;
      doc.text(t, doc.internal.pageSize.getWidth()-40-doc.getTextWidth(t), doc.internal.pageSize.getHeight()-20);
    }
    doc.save('Disposal_Report.pdf');
  }
  </script>
</body>
</html>
